<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuis Fisika Dasar - Neon</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles untuk tema neon dan glassmorphism */
        body {
            font-family: 'Rajdhani', sans-serif;
            background: #0f0c29;
            background: -webkit-linear-gradient(to right, #24243e, #302b63, #0f0c29);
            background: linear-gradient(to right, #24243e, #302b63, #0f0c29);
            color: #e0e0e0;
        }

        .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
        }

        /* Efek neon standar untuk teks kecil */
        .neon-text {
            color: #00ffff;
            text-shadow:
                0 0 5px #00ffff,
                0 0 10px #00ffff;
        }
        
        /* Header utama dengan animasi kelip */
        #main-header {
            font-size: 2.8rem; /* Ukuran font diperkecil */
            line-height: 1.1;
            color: #cceeff;
            animation: neon-flicker 2.5s infinite alternate;
        }
        @media (min-width: 768px) {
            #main-header {
                font-size: 3.8rem; /* Ukuran font diperkecil */
            }
        }
        @keyframes neon-flicker {
            0%, 19%, 21%, 23%, 25%, 54%, 56%, 100% {
                text-shadow:
                    0 0 4px #fff,
                    0 0 10px #fff,
                    0 0 20px #00ffff,
                    0 0 40px #00ffff,
                    0 0 70px #00ffff,
                    0 0 80px #00ffff;
                color: #cceeff;
            }
            20%, 24%, 55% {
                text-shadow: none;
                color: #00ffff;
            }
        }
        
        /* Sub-header dengan animasi kelip pink */
        #sub-header {
            font-size: 1.25rem;
            color: #ffccff;
            animation: neon-flicker-pink 3s infinite alternate;
        }

        @keyframes neon-flicker-pink {
            0%, 19%, 21%, 23%, 25%, 54%, 56%, 100% {
                text-shadow:
                    0 0 2px #fff,
                    0 0 5px #fff,
                    0 0 10px #ff00ff,
                    0 0 20px #ff00ff,
                    0 0 35px #ff00ff,
                    0 0 40px #ff00ff;
                color: #ffccff;
            }
            20%, 24%, 55% {
                text-shadow: none;
                color: #ff00ff;
            }
        }

        .neon-border {
            border: 2px solid #00ffff;
            box-shadow: 0 0 10px #00ffff, inset 0 0 10px #00ffff;
        }

        .neon-button {
            transition: all 0.3s ease;
            color: #00ffff;
        }

        .neon-button:hover {
            background-color: #00ffff;
            color: #0f0c29;
            box-shadow: 0 0 20px #00ffff;
        }
        
        .neon-button-pink {
            border-color: #ff00ff;
            color: #ff00ff;
            box-shadow: 0 0 10px #ff00ff, inset 0 0 10px #ff00ff;
        }

        .neon-button-pink:hover {
            background-color: #ff00ff;
            color: #0f0c29;
            box-shadow: 0 0 20px #ff00ff;
        }

        .correct-answer {
            background-color: rgba(0, 255, 0, 0.3) !important;
            border-color: #00ff00 !important;
            color: #fff !important;
            transform: scale(1.05);
        }

        .wrong-answer {
            background-color: rgba(255, 0, 0, 0.3) !important;
            border-color: #ff0000 !important;
            color: #fff !important;
            opacity: 0.7;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        ::-webkit-scrollbar-thumb {
            background: #00ffff;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #00bfff;
        }
        
        /* Animasi untuk entri Hall of Fame baru */
        @keyframes pulse-once {
          0% { transform: scale(1); }
          50% { transform: scale(1.05); }
          100% { transform: scale(1); }
        }
        .animate-pulse-once {
          animation: pulse-once 0.5s ease-in-out;
        }

        /* Styling untuk dropdown */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2300FFFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 0.8em;
            padding-right: 2.5rem; /* Memberi ruang untuk panah */
        }
        select option {
            background: #0f0c29;
            color: #e0e0e0;
        }

    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Container Utama -->
    <div class="relative w-full max-w-7xl mx-auto flex flex-col md:flex-row gap-8">

        <!-- Panel Progres Real-time (hanya muncul saat kuis) -->
        <div id="progress-tracker-container" class="hidden md:block w-full md:w-1/3 lg:w-1/4 order-first md:order-last">
            <div class="glass-card p-4 space-y-3 h-full">
                <h3 class="font-orbitron text-xl text-center neon-text">Progres Siswa Lain</h3>
                <div id="progress-tracker-list" class="space-y-2 max-h-96 md:max-h-full overflow-y-auto pr-2">
                    <!-- Daftar progres siswa akan muncul di sini -->
                </div>
            </div>
        </div>

        <!-- Konten Kuis Utama -->
        <div id="app-container" class="w-full md:w-2/3 lg:w-3/4">

            <!-- Start Screen -->
            <div id="start-screen" class="glass-card p-8 text-center space-y-6">
                <h1 id="main-header" class="font-orbitron font-bold">Kuis Fisika Dasar</h1>
                <p id="sub-header" class="font-orbitron font-semibold mt-2">Dibuat Oleh Pak Akhsan</p>
                <p class="text-lg text-gray-300 mt-6">Uji pemahaman Anda tentang Alat Ukur, Besaran, Satuan, dan Dimensi!</p>
                <div class="space-y-4">
                    <input id="name-input" type="text" placeholder="Masukkan Nama Anda" class="w-full p-3 bg-transparent border-2 border-gray-500 rounded-lg text-center text-white focus:neon-border focus:outline-none transition-all">
                    <select id="class-input" class="w-full p-3 bg-transparent border-2 border-gray-500 rounded-lg text-center text-white focus:neon-border focus:outline-none transition-all">
                        <option value="" disabled selected>Pilih Kelas Anda</option>
                        <option value="X.1">X.1</option>
                        <option value="X.2">X.2</option>
                        <option value="X.3">X.3</option>
                        <option value="X.4">X.4</option>
                        <option value="X.5">X.5</option>
                        <option value="X.6">X.6</option>
                        <option value="X.7">X.7</option>
                        <option value="X.8">X.8</option>
                        <option value="X.9">X.9</option>
                        <option value="X.10">X.10</option>
                        <option value="X.11">X.11</option>
                    </select>
                </div>
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button id="start-button" class="w-full sm:w-auto neon-button neon-border font-bold py-3 px-8 rounded-lg text-lg">Mulai Kuis</button>
                    <button id="hof-button-start" class="w-full sm:w-auto neon-button-pink font-bold py-3 px-8 rounded-lg text-lg">Hall of Fame</button>
                </div>
                <p id="error-message" class="text-red-400 h-4"></p>
            </div>

            <!-- Quiz Screen -->
            <div id="quiz-screen" class="hidden glass-card p-6 md:p-8 space-y-6">
                <div class="flex justify-between items-center">
                    <div id="progress-text" class="font-bold text-lg">Soal 1 / 15</div>
                    <div id="score-text" class="font-bold text-lg neon-text">Skor: 0</div>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-cyan-400 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <h2 id="question-text" class="text-2xl font-bold text-center min-h-[100px]"></h2>
                <div id="answer-buttons" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Answer buttons will be generated here -->
                </div>
                 <p id="hint-text" class="text-center text-gray-400 italic h-6"></p>
            </div>

            <!-- Result Screen -->
            <div id="result-screen" class="hidden glass-card p-8 text-center space-y-6">
                <h1 class="font-orbitron text-4xl font-bold neon-text">Kuis Selesai!</h1>
                <p class="text-2xl">Skor Akhir Anda:</p>
                <p id="final-score" class="font-orbitron text-6xl font-bold neon-text">0</p>
                <p id="feedback-message" class="text-xl"></p>
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button id="retry-button" class="w-full sm:w-auto neon-button neon-border font-bold py-3 px-8 rounded-lg text-lg">Coba Lagi</button>
                    <button id="hof-button-result" class="w-full sm:w-auto neon-button-pink font-bold py-3 px-8 rounded-lg text-lg">Hall of Fame</button>
                </div>
            </div>

            <!-- Hall of Fame Screen -->
            <div id="hof-screen" class="hidden glass-card p-8 space-y-6">
                <h1 class="font-orbitron text-4xl font-bold text-center neon-text">Hall of Fame</h1>
                <div id="hof-list" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                    <!-- Scores will be listed here -->
                    <div id="loading-spinner" class="text-center p-8">
                        <svg class="animate-spin h-10 w-10 text-cyan-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="mt-4">Memuat data...</p>
                    </div>
                </div>
                <div class="text-center">
                    <button id="back-button" class="w-full sm:w-auto neon-button neon-border font-bold py-3 px-8 rounded-lg text-lg">Kembali</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, serverTimestamp, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCPjAixXLCJtRSxDgtWe210nFtiTWrppe4",
            authDomain: "quiz-32672.firebaseapp.com",
            projectId: "quiz-32672",
            storageBucket: "quiz-32672.firebasestorage.app",
            messagingSenderId: "168006086401",
            appId: "1:168006086401:web:980837424fcff6bb5fb500"
        };
        
        // --- Inisialisasi Firebase ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'quiz-numerasi-fisika';

        // --- DOM Elements ---
        const startScreen = document.getElementById('start-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const resultScreen = document.getElementById('result-screen');
        const hofScreen = document.getElementById('hof-screen');
        const progressTrackerContainer = document.getElementById('progress-tracker-container');
        const progressTrackerList = document.getElementById('progress-tracker-list');
        
        const nameInput = document.getElementById('name-input');
        const classInput = document.getElementById('class-input');
        const startButton = document.getElementById('start-button');
        const errorMessage = document.getElementById('error-message');

        const questionText = document.getElementById('question-text');
        const answerButtons = document.getElementById('answer-buttons');
        const progressText = document.getElementById('progress-text');
        const progressBar = document.getElementById('progress-bar');
        const scoreText = document.getElementById('score-text');
        const hintText = document.getElementById('hint-text');

        const finalScore = document.getElementById('final-score');
        const feedbackMessage = document.getElementById('feedback-message');
        const retryButton = document.getElementById('retry-button');
        
        const hofButtonStart = document.getElementById('hof-button-start');
        const hofButtonResult = document.getElementById('hof-button-result');
        const hofList = document.getElementById('hof-list');
        const loadingSpinner = document.getElementById('loading-spinner');
        const backButton = document.getElementById('back-button');

        // --- Quiz Data (Plain JSON) ---
        const quizData = [
            { question: "Perhatikan gambar pengukuran diameter koin menggunakan jangka sorong. Skala utama di angka 2,4 cm dan skala nonius yang berimpit di angka 7. Hasil pengukuran diameter koin tersebut adalah...", hint: "Hasil = Skala Utama + (Skala Nonius x 0,01 cm)", answers: [{ text: "2,47 cm", correct: true }, { text: "2,40 cm", correct: false }, { text: "2,77 cm", correct: false }, { text: "2,57 cm", correct: false }] },
            { question: "Momentum didefinisikan sebagai hasil kali antara massa dan kecepatan. Dimensi dari momentum adalah...", hint: "Dimensi massa [M], dimensi kecepatan [L][T]⁻¹", answers: [{ text: "[M][L]²[T]⁻²", correct: false }, { text: "[M][L][T]⁻¹", correct: true }, { text: "[M][L][T]⁻²", correct: false }, { text: "[M][L]²[T]⁻¹", correct: false }] },
            { question: "Di antara kelompok besaran berikut, yang seluruhnya merupakan besaran turunan adalah...", hint: "Besaran turunan adalah besaran yang diturunkan dari besaran pokok.", answers: [{ text: "Kecepatan, suhu, dan gaya", correct: false }, { text: "Massa, waktu, dan percepatan", correct: false }, { text: "Usaha, daya, dan tekanan", correct: true }, { text: "Panjang, kuat arus, dan energi", correct: false }] },
            { question: "Sebuah sekrup diukur diameternya menggunakan mikrometer sekrup. Skala utama 4,5 mm dan skala putar di angka 38. Besar diameter sekrup tersebut adalah...", hint: "Hasil = Skala Utama + (Skala Putar x 0,01 mm)", answers: [{ text: "4,58 mm", correct: false }, { text: "4,38 mm", correct: false }, { text: "4,88 mm", correct: true }, { text: "4,50 mm", correct: false }] },
            { question: "Besaran pokok kuat arus listrik memiliki satuan dalam Sistem Internasional (SI), yaitu...", hint: "Ingat 7 besaran pokok dalam fisika.", answers: [{ text: "Volt", correct: false }, { text: "Ohm", correct: false }, { text: "Coulomb", correct: false }, { text: "Ampere", correct: true }] },
            { question: "Energi kinetik dirumuskan sebagai Eₖ = ½mv². Berdasarkan rumus tersebut, dimensi dari energi kinetik adalah...", hint: "Dimensi massa [M], dimensi kecepatan [L][T]⁻¹.", answers: [{ text: "[M][L]²[T]⁻²", correct: true }, { text: "[M][L][T]⁻¹", correct: false }, { text: "[M][L]⁻¹[T]²", correct: false }, { text: "[M][L]²[T]²", correct: false }] },
            { question: "Dari besaran-besaran berikut: (1) Jarak, (2) Perpindahan, (3) Kelajuan, (4) Gaya. Yang termasuk besaran vektor adalah...", hint: "Besaran vektor adalah besaran yang memiliki nilai dan arah.", answers: [{ text: "(1) dan (3)", correct: false }, { text: "(2) dan (3)", correct: false }, { text: "(1) dan (4)", correct: false }, { text: "(2) dan (4)", correct: true }] },
            { question: "Sebuah mobil bergerak dengan kecepatan 72 km/jam. Jika dinyatakan dalam satuan m/s, kecepatan mobil tersebut adalah...", hint: "1 km = 1000 m, dan 1 jam = 3600 s.", answers: [{ text: "10 m/s", correct: false }, { text: "36 m/s", correct: false }, { text: "20 m/s", correct: true }, { text: "25 m/s", correct: false }] },
            { question: "Tekanan adalah gaya per satuan luas. Dimensi dari tekanan adalah...", hint: "Dimensi gaya [M][L][T]⁻², dimensi luas [L]².", answers: [{ text: "[M][L]⁻¹[T]⁻²", correct: true }, { text: "[M][L]²[T]⁻²", correct: false }, { text: "[M][L]⁻²[T]⁻²", correct: false }, { text: "[M][L][T]⁻¹", correct: false }] },
            { question: "Untuk mengukur diameter dalam sebuah pipa kecil dengan ketelitian tinggi, alat ukur yang paling sesuai untuk digunakan adalah...", hint: "Alat ukur mana yang memiliki rahang untuk mengukur diameter dalam?", answers: [{ text: "Penggaris", correct: false }, { text: "Jangka sorong", correct: true }, { text: "Mikrometer sekrup", correct: false }, { text: "Meteran gulung", correct: false }] },
            { question: "Seorang siswa mengukur panjang sebuah meja dan mendapatkan hasil 1,50 meter. Jumlah angka penting dari hasil pengukuran tersebut adalah...", hint: "Angka nol di akhir desimal termasuk angka penting.", answers: [{ text: "Dua", correct: false }, { text: "Empat", correct: false }, { text: "Satu", correct: false }, { text: "Tiga", correct: true }] },
            { question: "Daya didefinisikan sebagai usaha yang dilakukan per satuan waktu. Dimensi dari daya adalah...", hint: "Dimensi usaha [M][L]²[T]⁻², dimensi waktu [T].", answers: [{ text: "[M][L]²[T]⁻²", correct: false }, { text: "[M][L]²[T]⁻³", correct: true }, { text: "[M][L][T]⁻²", correct: false }, { text: "[M][L]⁻¹[T]⁻²", correct: false }] },
            { question: "Kelompok besaran di bawah ini yang merupakan kelompok besaran pokok sesuai Sistem Internasional (SI) adalah...", hint: "Ingat 7 besaran pokok: panjang, massa, waktu, suhu, kuat arus, intensitas cahaya, jumlah zat.", answers: [{ text: "Panjang, massa, dan volume", correct: false }, { text: "Waktu, suhu, dan kecepatan", correct: false }, { text: "Kuat arus, intensitas cahaya, dan jumlah zat", correct: true }, { text: "Massa, berat, dan waktu", correct: false }] },
            { question: "Notasi ilmiah dari bilangan 0,0000852 adalah...", hint: "Geser koma ke kanan hingga di belakang angka bukan nol pertama.", answers: [{ text: "8,52 x 10⁻⁵", correct: true }, { text: "8,52 x 10⁵", correct: false }, { text: "85,2 x 10⁻⁶", correct: false }, { text: "0,852 x 10⁻⁴", correct: false }] },
            { question: "Suatu besaran fisika dinyatakan dengan P = Q.R², dengan P memiliki satuan newton dan R memiliki satuan meter. Agar persamaan tersebut benar secara dimensi, maka Q harus merupakan besaran...", hint: "Dimensi Q = Dimensi P / Dimensi R².", answers: [{ text: "Percepatan", correct: false }, { text: "Tekanan", correct: true }, { text: "Massa jenis", correct: false }, { text: "Usaha", correct: false }] }
        ];

        // --- Game State ---
        let currentQuestionIndex;
        let score;
        let userName;
        let userClass;
        let shuffledQuestions;
        let currentSessionId = null;
        let unsubscribeHofListener = null;
        let unsubscribeProgressListener = null;
        
        // --- Functions ---
        async function startQuiz() {
            userName = nameInput.value.trim();
            userClass = classInput.value; // Mengambil nilai dari dropdown

            if (userName === '' || userClass === '') {
                errorMessage.textContent = 'Nama dan Kelas wajib diisi!';
                return;
            }
            errorMessage.textContent = '';

            currentQuestionIndex = 0;
            score = 0;
            shuffledQuestions = [...quizData];

            try {
                const sessionRef = await addDoc(collection(db, `artifacts/${appId}/public/data/active_sessions`), {
                    name: userName,
                    kelas: userClass,
                    progress: 0,
                    timestamp: serverTimestamp()
                });
                currentSessionId = sessionRef.id;
            } catch (error) {
                console.error("Gagal membuat sesi:", error);
                errorMessage.textContent = 'Gagal memulai sesi. Coba lagi.';
                return;
            }
            
            progressTrackerContainer.classList.remove('hidden');
            startScreen.classList.add('hidden');
            resultScreen.classList.add('hidden');
            hofScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');

            listenToProgress();
            updateScoreDisplay();
            await showQuestion();
        }

        async function showQuestion() {
            resetState();
            
            if (currentSessionId) {
                const sessionDoc = doc(db, `artifacts/${appId}/public/data/active_sessions`, currentSessionId);
                await updateDoc(sessionDoc, { progress: currentQuestionIndex + 1 });
            }

            const question = shuffledQuestions[currentQuestionIndex];
            questionText.textContent = question.question;
            hintText.textContent = `Petunjuk: ${question.hint}`;
            
            const shuffledAnswers = [...question.answers].sort(() => Math.random() - 0.5);

            shuffledAnswers.forEach(answer => {
                const button = document.createElement('button');
                button.innerText = answer.text;
                button.classList.add('w-full', 'p-4', 'rounded-lg', 'border-2', 'border-gray-500', 'transition-all', 'duration-300', 'hover:bg-gray-700', 'text-lg');
                if (answer.correct) {
                    button.dataset.correct = answer.correct;
                }
                button.addEventListener('click', selectAnswer);
                answerButtons.appendChild(button);
            });

            updateProgress();
        }

        function resetState() {
            while (answerButtons.firstChild) {
                answerButtons.removeChild(answerButtons.firstChild);
            }
            hintText.textContent = '';
        }

        function selectAnswer(e) {
            const selectedButton = e.target;
            const correct = selectedButton.dataset.correct === 'true';

            if (correct) {
                score += 10;
                updateScoreDisplay();
            }

            Array.from(answerButtons.children).forEach(button => {
                if (button.dataset.correct === 'true') {
                    button.classList.add('correct-answer');
                } else {
                    button.classList.add('wrong-answer');
                }
                button.disabled = true;
            });

            setTimeout(async () => {
                currentQuestionIndex++;
                if (currentQuestionIndex < shuffledQuestions.length) {
                    await showQuestion();
                } else {
                    await showResult();
                }
            }, 1500);
        }

        function updateProgress() {
            progressText.textContent = `Soal ${currentQuestionIndex + 1} / ${shuffledQuestions.length}`;
            const progressPercentage = ((currentQuestionIndex + 1) / shuffledQuestions.length) * 100;
            progressBar.style.width = `${progressPercentage}%`;
        }
        
        function updateScoreDisplay() {
            scoreText.textContent = `Skor: ${score}`;
        }

        async function showResult() {
            await cleanupSession();

            quizScreen.classList.add('hidden');
            progressTrackerContainer.classList.add('hidden');
            resultScreen.classList.remove('hidden');
            finalScore.textContent = score;

            let feedback = '';
            if (score >= 120) { // Disesuaikan untuk 15 soal (80%)
                feedback = 'Luar biasa! Pemahaman Anda sangat baik!';
            } else if (score >= 90) { // 60%
                feedback = 'Bagus! Anda punya dasar yang kuat.';
            } else if (score >= 60) { // 40%
                feedback = 'Cukup baik! Terus berlatih ya.';
            } else {
                feedback = 'Jangan menyerah, ayo coba lagi untuk lebih paham!';
            }
            feedbackMessage.textContent = feedback;

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/scores`), {
                    name: userName,
                    kelas: userClass,
                    score: score,
                    timestamp: serverTimestamp()
                });
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        }
        
        function showHallOfFame() {
            startScreen.classList.add('hidden');
            resultScreen.classList.add('hidden');
            hofScreen.classList.remove('hidden');
            loadingSpinner.classList.remove('hidden');
            hofList.innerHTML = '';
            hofList.appendChild(loadingSpinner);

            if (unsubscribeHofListener) unsubscribeHofListener();

            const q = query(collection(db, `artifacts/${appId}/public/data/scores`), orderBy("score", "desc"));
            
            unsubscribeHofListener = onSnapshot(q, (querySnapshot) => {
                loadingSpinner.classList.add('hidden');
                hofList.innerHTML = ''; 
                
                if (querySnapshot.empty) {
                    hofList.innerHTML = '<p class="text-center text-gray-400">Belum ada skor. Jadilah yang pertama!</p>';
                    return;
                }

                let rank = 1;
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const hofEntry = document.createElement('div');
                    let rankColor = 'text-gray-400';
                    if (rank === 1) rankColor = 'text-yellow-400';
                    if (rank === 2) rankColor = 'text-gray-300';
                    if (rank === 3) rankColor = 'text-yellow-600';

                    hofEntry.classList.add('glass-card', 'p-4', 'rounded-lg', 'flex', 'items-center', 'justify-between', 'gap-4', 'animate-pulse-once');
                    hofEntry.innerHTML = `
                        <div class="flex items-center gap-4">
                            <span class="font-orbitron text-2xl font-bold w-8 text-center ${rankColor}">#${rank}</span>
                            <div>
                                <p class="font-bold text-lg text-white">${data.name}</p>
                                <p class="text-sm text-gray-300">${data.kelas}</p>
                            </div>
                        </div>
                        <span class="font-orbitron text-3xl font-bold neon-text">${data.score}</span>
                    `;
                    hofList.appendChild(hofEntry);
                    rank++;
                });
            }, (error) => {
                console.error("Error listening to scores: ", error);
                loadingSpinner.classList.add('hidden');
                hofList.innerHTML = '<p class="text-center text-red-400">Gagal memuat data. Silakan coba lagi.</p>';
            });
        }
        
        function listenToProgress() {
            if (unsubscribeProgressListener) unsubscribeProgressListener();
            
            const q = query(collection(db, `artifacts/${appId}/public/data/active_sessions`), orderBy("timestamp", "desc"));
            unsubscribeProgressListener = onSnapshot(q, (snapshot) => {
                progressTrackerList.innerHTML = '';
                if (snapshot.empty) {
                     progressTrackerList.innerHTML = '<p class="text-center text-sm text-gray-400">Menunggu siswa lain...</p>';
                }
                snapshot.forEach(doc => {
                    const session = doc.data();
                    if (doc.id === currentSessionId) return;

                    const progressItem = document.createElement('div');
                    progressItem.classList.add('glass-card', 'p-3', 'rounded-lg');
                    progressItem.innerHTML = `
                        <p class="font-bold text-white">${session.name}</p>
                        <div class="flex items-center gap-2">
                            <div class="w-full bg-gray-600 rounded-full h-1.5">
                                <div class="bg-pink-500 h-1.5 rounded-full" style="width: ${(session.progress / shuffledQuestions.length) * 100}%"></div>
                            </div>
                            <span class="text-xs font-bold">${session.progress}/${shuffledQuestions.length}</span>
                        </div>
                    `;
                    progressTrackerList.appendChild(progressItem);
                });
            });
        }

        async function cleanupSession() {
            if (currentSessionId) {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/active_sessions`, currentSessionId));
                currentSessionId = null;
            }
            if (unsubscribeProgressListener) {
                unsubscribeProgressListener();
                unsubscribeProgressListener = null;
            }
        }

        function goBackToStart() {
            if (unsubscribeHofListener) {
                unsubscribeHofListener();
                unsubscribeHofListener = null;
            }
            hofScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
        }

        // --- Event Listeners ---
        startButton.addEventListener('click', startQuiz);
        retryButton.addEventListener('click', () => {
             resultScreen.classList.add('hidden');
             startScreen.classList.remove('hidden');
             nameInput.value = '';
             classInput.value = '';
        });
        hofButtonStart.addEventListener('click', showHallOfFame);
        hofButtonResult.addEventListener('click', showHallOfFame);
        backButton.addEventListener('click', goBackToStart);
        window.addEventListener('beforeunload', cleanupSession);

    </script>
</body>
</html>