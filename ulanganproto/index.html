<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SuaraGuru - Penilai Otomatis</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Animasi Custom */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .pulse-mic { animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* Scrollbar Halus */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans min-h-screen flex flex-col">

    <!-- NOTIFIKASI TOAST -->
    <div id="toast-container" class="fixed bottom-5 right-5 z-50 flex flex-col gap-2"></div>

    <!-- LOADING SPINNER (Full Screen) -->
    <div id="loading-screen" class="fixed inset-0 bg-white z-[60] flex items-center justify-center">
        <div class="animate-spin text-blue-600">
            <i data-lucide="loader-2" width="48" height="48"></i>
        </div>
    </div>

    <!-- LOGIN PAGE -->
    <div id="login-view" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-lg max-w-md w-full border border-gray-100">
            <div class="flex justify-center mb-6 text-blue-600">
                <i data-lucide="volume-2" width="48" height="48"></i>
            </div>
            <h1 class="text-2xl font-bold text-center text-gray-800 mb-2">SuaraGuru</h1>
            <p class="text-center text-gray-500 mb-8">Masuk untuk mengelola nilai siswa Anda.</p>
            
            <form id="auth-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="email-input" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="guru@sekolah.id">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="password-input" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="******">
                </div>
                <button type="submit" id="auth-btn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition-colors">
                    Masuk
                </button>
            </form>
            
            <div class="mt-6 text-center">
                <button id="toggle-auth-mode" class="text-sm text-blue-600 hover:underline">
                    Belum punya akun? Daftar sekarang
                </button>
            </div>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div id="main-view" class="hidden flex-col min-h-screen w-full">
        
        <!-- HEADER -->
        <header class="bg-blue-600 text-white p-4 shadow-lg sticky top-0 z-40">
            <div class="max-w-4xl mx-auto flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <i data-lucide="volume-2" width="24" height="24"></i>
                    <h1 class="text-xl font-bold hidden md:block">SuaraGuru</h1>
                </div>
                
                <div class="flex items-center gap-4">
                    <div class="text-right hidden sm:block">
                        <div class="text-xs opacity-75">Login sebagai:</div>
                        <div id="user-email-display" class="text-sm font-semibold">user@email.com</div>
                    </div>
                    <button id="logout-btn" class="p-2 bg-blue-700 rounded-lg hover:bg-blue-800 transition-colors" title="Keluar">
                        <i data-lucide="log-out" width="18" height="18"></i>
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-4xl mx-auto p-4 space-y-6 w-full flex-grow">
            
            <!-- NAV TABS -->
            <div class="flex gap-2 border-b border-gray-200 pb-2 overflow-x-auto">
                <button onclick="switchTab('dashboard')" id="tab-dashboard" class="px-4 py-2 rounded-lg font-medium transition-colors whitespace-nowrap bg-blue-100 text-blue-700">Penilaian</button>
                <button onclick="switchTab('import')" id="tab-import" class="px-4 py-2 rounded-lg font-medium transition-colors whitespace-nowrap text-gray-500 hover:bg-gray-100">Impor Data</button>
                <button onclick="switchTab('list')" id="tab-list" class="px-4 py-2 rounded-lg font-medium transition-colors whitespace-nowrap text-gray-500 hover:bg-gray-100">Data Tabel (<span id="student-count-badge">0</span>)</button>
            </div>

            <!-- DASHBOARD CONTENT -->
            <div id="content-dashboard" class="space-y-6 fade-in">
                <!-- Search & Input Card -->
                <div class="bg-white rounded-xl shadow-md p-6 border border-gray-100 relative">
                    <div class="mb-6 text-center">
                        <h2 class="text-2xl font-semibold text-gray-700 mb-2">Siapa yang akan dinilai?</h2>
                        <p class="text-gray-500 text-sm">Ketik nama siswa, tekan Enter, lalu ucapkan nilainya.</p>
                    </div>

                    <!-- Search Box -->
                    <div class="relative max-w-lg mx-auto mb-8">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i data-lucide="search" class="text-gray-400" width="20"></i>
                        </div>
                        <input type="text" id="student-search" class="w-full pl-10 pr-4 py-4 text-lg border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all shadow-sm" placeholder="Ketik nama siswa..." autocomplete="off">
                        
                        <!-- Suggestions Dropdown -->
                        <div id="search-suggestions" class="hidden absolute top-full left-0 right-0 mt-2 bg-white rounded-xl shadow-xl border border-gray-100 z-50 overflow-hidden max-h-60 overflow-y-auto">
                            <!-- Suggestion items will be injected here -->
                        </div>
                    </div>

                    <!-- Active Grading Area -->
                    <div id="grading-area" class="hidden bg-blue-50 rounded-xl p-6 border border-blue-100">
                        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                            <div class="text-center md:text-left">
                                <div class="text-sm text-blue-600 font-bold uppercase tracking-wide">Sedang Menilai</div>
                                <h3 id="active-student-name" class="text-3xl font-bold text-gray-800">Nama Siswa</h3>
                                <p id="active-student-class" class="text-gray-600">Kelas: -</p>
                            </div>

                            <div class="flex items-center gap-4 bg-white p-2 rounded-xl shadow-sm border border-gray-200">
                                <button id="mic-btn" class="p-4 rounded-full transition-all bg-blue-100 text-blue-600 hover:bg-blue-200">
                                    <i data-lucide="mic" width="28" height="28"></i>
                                </button>

                                <div class="relative">
                                    <input type="number" id="score-input" class="w-24 text-center text-3xl font-bold p-2 border-b-2 border-gray-300 focus:border-blue-500 outline-none bg-transparent" placeholder="0" min="0" max="100">
                                    <label class="block text-xs text-center text-gray-400 mt-1">Nilai</label>
                                </div>

                                <button id="save-score-btn" class="bg-green-500 hover:bg-green-600 text-white p-3 rounded-lg shadow-md transition-colors">
                                    <i data-lucide="save" width="24" height="24"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mt-4 text-center h-6 text-sm">
                            <p id="transcript-display" class="text-gray-400 text-xs italic"></p>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                    <h3 class="font-semibold text-gray-700 mb-4 flex items-center gap-2">
                        <i data-lucide="check" class="text-green-500" width="18"></i> Terakhir Dinilai
                    </h3>
                    <div id="recent-list" class="space-y-2">
                        <!-- Recent items injected here -->
                        <p class="text-gray-400 text-sm text-center py-4">Belum ada nilai yang masuk.</p>
                    </div>
                </div>
            </div>

            <!-- IMPORT CONTENT -->
            <div id="content-import" class="hidden bg-white rounded-xl shadow-md p-6 fade-in">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <i data-lucide="upload" class="text-blue-500" width="24"></i> Impor Data Siswa
                </h2>
                <p class="text-gray-600 mb-4 text-sm">
                    Salin data dari Excel dan tempel di sini. Format 2 kolom: <strong>Nama Siswa</strong> dan <strong>Kelas</strong>.
                </p>
                
                <textarea id="import-textarea" class="w-full h-64 p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 outline-none font-mono text-sm" placeholder="Andi Pratama&#9;X-1&#10;Budi Santoso&#9;X-2"></textarea>

                <div class="flex justify-between items-center mt-4">
                    <button id="delete-all-btn" class="text-red-500 hover:text-red-700 text-sm flex items-center gap-1">
                        <i data-lucide="trash-2" width="16"></i> Hapus Database
                    </button>
                    <button id="process-import-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 disabled:bg-gray-300 transition-colors font-medium">
                        Simpan ke Cloud
                    </button>
                </div>
            </div>

            <!-- LIST CONTENT -->
            <div id="content-list" class="hidden bg-white rounded-xl shadow-md p-6 fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">Data Semua Siswa</h2>
                    <button id="export-btn" class="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm">
                        <i data-lucide="download" width="18"></i> Ekspor CSV
                    </button>
                </div>

                <div class="overflow-x-auto max-h-[60vh]">
                    <table class="w-full text-left text-sm relative">
                        <thead class="bg-gray-100 text-gray-600 uppercase sticky top-0">
                            <tr>
                                <th class="p-3 rounded-tl-lg">Nama</th>
                                <th class="p-3">Kelas</th>
                                <th class="p-3">Nilai</th>
                                <th class="p-3 rounded-tr-lg">Status</th>
                            </tr>
                        </thead>
                        <tbody id="student-table-body" class="divide-y divide-gray-100">
                            <!-- Rows injected here -->
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, writeBatch, query, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyAyopuyvzjIXIZT-LE8_7bVP8vxVIlcQtU",
            authDomain: "apps-f1563.firebaseapp.com",
            projectId: "apps-f1563",
            storageBucket: "apps-f1563.firebasestorage.app",
            messagingSenderId: "330620144262",
            appId: "1:330620144262:web:8ad8a32685b352ec0edf07",
            measurementId: "G-TRS9JGPPX0"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Konstanta
        const APP_ID = "suaraguru_v1";
        
        // --- STATE GLOBAL ---
        let currentUser = null;
        let studentsData = [];
        let selectedStudent = null;
        let isRegistering = false;
        let recognition = null;
        let isListening = false;

        // --- REFERENSI DOM ---
        const els = {
            loadingScreen: document.getElementById('loading-screen'),
            loginView: document.getElementById('login-view'),
            mainView: document.getElementById('main-view'),
            authForm: document.getElementById('auth-form'),
            emailInput: document.getElementById('email-input'),
            passInput: document.getElementById('password-input'),
            authBtn: document.getElementById('auth-btn'),
            toggleAuthBtn: document.getElementById('toggle-auth-mode'),
            userEmailDisplay: document.getElementById('user-email-display'),
            logoutBtn: document.getElementById('logout-btn'),
            
            // Search
            searchInput: document.getElementById('student-search'),
            suggestionsBox: document.getElementById('search-suggestions'),
            
            // Grading Area
            gradingArea: document.getElementById('grading-area'),
            activeName: document.getElementById('active-student-name'),
            activeClass: document.getElementById('active-student-class'),
            scoreInput: document.getElementById('score-input'),
            micBtn: document.getElementById('mic-btn'),
            saveScoreBtn: document.getElementById('save-score-btn'),
            transcript: document.getElementById('transcript-display'),
            
            // Import
            importText: document.getElementById('import-textarea'),
            importBtn: document.getElementById('process-import-btn'),
            deleteBtn: document.getElementById('delete-all-btn'),
            
            // Lists
            recentList: document.getElementById('recent-list'),
            tableBody: document.getElementById('student-table-body'),
            countBadge: document.getElementById('student-count-badge'),
            exportBtn: document.getElementById('export-btn')
        };

        // --- INISIALISASI IKON ---
        lucide.createIcons();

        // --- AUTH LOGIC ---
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            els.loadingScreen.classList.add('hidden');
            
            if (user) {
                els.loginView.classList.add('hidden');
                els.mainView.classList.remove('hidden');
                els.mainView.classList.add('flex');
                els.userEmailDisplay.textContent = user.email;
                initDataListener(user.uid);
            } else {
                els.loginView.classList.remove('hidden');
                els.mainView.classList.add('hidden');
                els.mainView.classList.remove('flex');
                studentsData = [];
            }
        });

        els.authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = els.emailInput.value;
            const pass = els.passInput.value;
            
            showToast('Memproses...', 'info');
            
            try {
                if (isRegistering) {
                    await createUserWithEmailAndPassword(auth, email, pass);
                    showToast('Akun berhasil dibuat!', 'success');
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                    showToast('Login berhasil', 'success');
                }
            } catch (err) {
                let msg = "Terjadi kesalahan.";
                if (err.code === 'auth/invalid-credential') msg = "Email atau password salah.";
                if (err.code === 'auth/email-already-in-use') msg = "Email sudah terdaftar.";
                if (err.code === 'auth/weak-password') msg = "Password terlalu lemah (min 6 karakter).";
                showToast(msg, 'error');
            }
        });

        els.toggleAuthBtn.addEventListener('click', (e) => {
            e.preventDefault();
            isRegistering = !isRegistering;
            els.authBtn.textContent = isRegistering ? 'Daftar Akun Baru' : 'Masuk';
            els.toggleAuthBtn.textContent = isRegistering ? 'Sudah punya akun? Masuk' : 'Belum punya akun? Daftar sekarang';
        });

        els.logoutBtn.addEventListener('click', () => signOut(auth));

        // --- FIRESTORE LOGIC ---
        let unsubscribeSnapshot = null;

        function initDataListener(uid) {
            if (unsubscribeSnapshot) unsubscribeSnapshot();

            const studentsRef = collection(db, 'artifacts', APP_ID, 'users', uid, 'students');
            const q = query(studentsRef); // Client side sorting for simple lists

            unsubscribeSnapshot = onSnapshot(q, (snapshot) => {
                const list = snapshot.docs.map(doc => ({
                    docId: doc.id,
                    ...doc.data()
                }));
                
                // Sort by ID
                list.sort((a, b) => a.id - b.id);
                
                studentsData = list;
                renderApp();
            }, (error) => {
                console.error("Error:", error);
                showToast("Gagal mengambil data", "error");
            });
        }

        async function saveToFirestore(student, newScore) {
            if (!currentUser) return;
            try {
                const docRef = doc(db, 'artifacts', APP_ID, 'users', currentUser.uid, 'students', student.docId);
                await setDoc(docRef, {
                    ...student,
                    score: newScore,
                    timestamp: new Date().toISOString()
                }, { merge: true });
                showToast(`Nilai ${newScore} tersimpan!`, 'success');
                resetGradingArea();
            } catch (error) {
                console.error(error);
                showToast("Gagal menyimpan nilai", "error");
            }
        }

        // --- RENDER FUNCTIONS ---
        function renderApp() {
            // Update counts
            els.countBadge.textContent = studentsData.length;
            
            // Render Table
            renderTable();
            
            // Render Recent
            renderRecent();
        }

        function renderTable() {
            if (studentsData.length === 0) {
                els.tableBody.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-gray-400">Data kosong.</td></tr>`;
                return;
            }

            els.tableBody.innerHTML = studentsData.map(s => `
                <tr class="hover:bg-gray-50 border-b border-gray-100 last:border-0">
                    <td class="p-3 font-medium text-gray-800">${s.name}</td>
                    <td class="p-3 text-gray-500">${s.class}</td>
                    <td class="p-3 font-bold text-blue-600">${s.score !== null ? s.score : '-'}</td>
                    <td class="p-3">
                        <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium ${s.score !== null ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                            ${s.score !== null ? 'Selesai' : 'Belum'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function renderRecent() {
            const graded = studentsData.filter(s => s.score !== null)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 5);

            if (graded.length === 0) {
                els.recentList.innerHTML = `<p class="text-gray-400 text-sm text-center py-4">Belum ada nilai yang masuk.</p>`;
                return;
            }

            els.recentList.innerHTML = graded.map(s => `
                <div class="flex justify-between items-center p-3 hover:bg-gray-50 rounded-lg border-b border-gray-50 last:border-0">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-xs">
                            ${s.class.substring(0,2)}
                        </div>
                        <div>
                            <div class="font-medium text-gray-800">${s.name}</div>
                            <div class="text-xs text-gray-500">${new Date(s.timestamp).toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'})}</div>
                        </div>
                    </div>
                    <span class="font-bold text-lg text-blue-600">${s.score}</span>
                </div>
            `).join('');
        }

        // --- SEARCH & SELECT ---
        els.searchInput.addEventListener('input', (e) => {
            const queryText = e.target.value.toLowerCase();
            if (!queryText) {
                els.suggestionsBox.classList.add('hidden');
                return;
            }

            const matches = studentsData.filter(s => 
                s.name.toLowerCase().includes(queryText) || 
                s.class.toLowerCase().includes(queryText)
            ).slice(0, 5);

            if (matches.length > 0) {
                els.suggestionsBox.innerHTML = matches.map((s, idx) => `
                    <div class="suggestion-item p-3 px-4 hover:bg-blue-50 cursor-pointer flex justify-between items-center ${idx === 0 ? 'bg-blue-50/50' : ''}" data-id="${s.id}">
                        <div>
                            <div class="font-semibold text-gray-800 pointer-events-none">${s.name}</div>
                            <div class="text-xs text-gray-500 pointer-events-none">${s.class}</div>
                        </div>
                        ${s.score !== null ? `<span class="text-green-600 font-bold bg-green-100 px-2 py-1 rounded text-xs pointer-events-none">${s.score}</span>` : ''}
                    </div>
                `).join('');
                els.suggestionsBox.classList.remove('hidden');
                
                // Add click events
                document.querySelectorAll('.suggestion-item').forEach(item => {
                    item.addEventListener('click', () => selectStudent(parseInt(item.dataset.id)));
                });
            } else {
                els.suggestionsBox.innerHTML = `<div class="p-4 text-center text-gray-400">Tidak ada siswa ditemukan</div>`;
                els.suggestionsBox.classList.remove('hidden');
            }
        });

        els.searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const firstItem = document.querySelector('.suggestion-item');
                if (firstItem) {
                    selectStudent(parseInt(firstItem.dataset.id));
                }
            }
        });

        function selectStudent(id) {
            selectedStudent = studentsData.find(s => s.id === id);
            if (!selectedStudent) return;

            els.searchInput.value = selectedStudent.name;
            els.suggestionsBox.classList.add('hidden');
            
            // Show Grading Area
            els.activeName.textContent = selectedStudent.name;
            els.activeClass.textContent = `Kelas: ${selectedStudent.class}`;
            els.scoreInput.value = '';
            els.gradingArea.classList.remove('hidden');
            
            // Focus and start listening
            setTimeout(() => {
                els.scoreInput.focus();
                startListening();
            }, 100);
        }

        function resetGradingArea() {
            selectedStudent = null;
            els.searchInput.value = '';
            els.gradingArea.classList.add('hidden');
            els.searchInput.focus();
            els.suggestionsBox.classList.add('hidden');
        }

        // --- SPEECH RECOGNITION ---
        els.micBtn.addEventListener('click', startListening);

        function startListening() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showToast('Browser tidak mendukung suara.', 'error');
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (recognition) recognition.stop();
            
            recognition = new SpeechRecognition();
            recognition.lang = 'id-ID';
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.onstart = () => {
                isListening = true;
                els.micBtn.classList.remove('bg-blue-100', 'text-blue-600');
                els.micBtn.classList.add('bg-red-500', 'text-white', 'pulse-mic');
                els.transcript.textContent = "Mendengarkan...";
            };

            recognition.onend = () => {
                isListening = false;
                els.micBtn.classList.add('bg-blue-100', 'text-blue-600');
                els.micBtn.classList.remove('bg-red-500', 'text-white', 'pulse-mic');
            };

            recognition.onresult = (event) => {
                const text = event.results[0][0].transcript;
                els.transcript.textContent = `Terdeteksi: "${text}"`;
                parseScore(text);
            };

            recognition.start();
        }

        function parseScore(text) {
            let score = null;
            const lowerText = text.toLowerCase();
            const textNumbers = {
                'nol': 0, 'satu': 1, 'dua': 2, 'tiga': 3, 'empat': 4, 'lima': 5, 
                'enam': 6, 'tujuh': 7, 'delapan': 8, 'sembilan': 9, 'sepuluh': 10,
                'seratus': 100
            };

            const digitMatch = text.match(/\d+/);
            if (digitMatch) {
                score = parseInt(digitMatch[0]);
            } else {
                for (const [key, value] of Object.entries(textNumbers)) {
                    if (lowerText.includes(key)) {
                        score = value;
                        break;
                    }
                }
            }

            if (score !== null && score >= 0 && score <= 100) {
                els.scoreInput.value = score;
                saveToFirestore(selectedStudent, score);
            } else {
                showToast("Tidak ada angka valid terdeteksi", "error");
            }
        }

        els.scoreInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && els.scoreInput.value) {
                saveToFirestore(selectedStudent, parseInt(els.scoreInput.value));
            }
        });

        els.saveScoreBtn.addEventListener('click', () => {
             if (els.scoreInput.value) {
                saveToFirestore(selectedStudent, parseInt(els.scoreInput.value));
            }
        });

        // --- IMPORT & EXPORT ---
        els.importBtn.addEventListener('click', async () => {
            const text = els.importText.value;
            if (!text.trim() || !currentUser) return;

            const lines = text.split('\n');
            const newStudents = [];
            let currentMaxId = studentsData.length > 0 ? Math.max(...studentsData.map(s => s.id || 0)) : 0;

            lines.forEach(line => {
                const parts = line.split(/\t|,/);
                if (parts.length >= 1) {
                    const name = parts[0].trim();
                    if (name) {
                        currentMaxId++;
                        newStudents.push({
                            id: currentMaxId,
                            name: name,
                            class: parts[1] ? parts[1].trim() : 'Umum',
                            score: null,
                            timestamp: null
                        });
                    }
                }
            });

            if (newStudents.length === 0) return;
            
            showToast('Sedang menyimpan ke cloud...', 'info');

            try {
                const batch = writeBatch(db);
                newStudents.forEach(student => {
                    const docRef = doc(collection(db, 'artifacts', APP_ID, 'users', currentUser.uid, 'students'));
                    batch.set(docRef, student);
                });
                await batch.commit();
                els.importText.value = '';
                showToast(`Berhasil impor ${newStudents.length} siswa!`, 'success');
                switchTab('dashboard');
            } catch (err) {
                console.error(err);
                showToast('Gagal impor data', 'error');
            }
        });

        els.deleteBtn.addEventListener('click', async () => {
            if(confirm("Hapus SEMUA data siswa?")) {
                const batch = writeBatch(db);
                studentsData.forEach(s => {
                    const docRef = doc(db, 'artifacts', APP_ID, 'users', currentUser.uid, 'students', s.docId);
                    batch.delete(docRef);
                });
                await batch.commit();
                showToast('Data dihapus.', 'success');
            }
        });

        els.exportBtn.addEventListener('click', () => {
             const headers = "Nama,Kelas,Nilai,Waktu Input\n";
             const rows = studentsData.map(s => 
                `"${s.name}","${s.class}","${s.score !== null ? s.score : ''}","${s.timestamp ? new Date(s.timestamp).toLocaleString('id-ID') : ''}"`
            ).join("\n");

            const csvContent = "data:text/csv;charset=utf-8," + encodeURI(headers + rows);
            const link = document.createElement("a");
            link.setAttribute("href", csvContent);
            link.setAttribute("download", "Rekap_Nilai.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // --- UTILS ---
        window.switchTab = (tabName) => {
            ['dashboard', 'import', 'list'].forEach(t => {
                const content = document.getElementById(`content-${t}`);
                const btn = document.getElementById(`tab-${t}`);
                
                if (t === tabName) {
                    content.classList.remove('hidden');
                    btn.classList.remove('text-gray-500', 'hover:bg-gray-100');
                    btn.classList.add('bg-blue-100', 'text-blue-700');
                } else {
                    content.classList.add('hidden');
                    btn.classList.add('text-gray-500', 'hover:bg-gray-100');
                    btn.classList.remove('bg-blue-100', 'text-blue-700');
                }
            });
        };

        function showToast(msg, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            let colorClass = type === 'error' ? 'bg-red-100 text-red-700 border-red-200' : 
                             type === 'success' ? 'bg-green-100 text-green-700 border-green-200' : 
                             'bg-blue-100 text-blue-700 border-blue-200';
            
            toast.className = `p-4 rounded-lg shadow-md border ${colorClass} fade-in flex items-center gap-2`;
            toast.innerHTML = `<span class="font-medium">${msg}</span>`;
            
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Set default tab
        switchTab('dashboard');
    </script>
</body>
</html>