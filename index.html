<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Crusader - Semester Quest</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts: Medieval Style -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=MedievalSharp&family=Metamorphous&display=swap" rel="stylesheet">

    <!-- LaTeX MathJax -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        /* --- STRONGHOLD THEME VARIABLES --- */
        :root {
            --wood-dark: #3e2723;
            --wood-light: #5d4037;
            --parchment: #f3e5ab;
            --stone-gray: #546e7a;
            --royal-red: #880e4f;
            --gold-accent: #ffd700;
        }

        body { 
            font-family: 'MedievalSharp', cursive; 
            background-color: #1a120b; 
            color: #2c1810;
            background-image: url('https://www.transparenttextures.com/patterns/dark-wood.png');
        }

        .title-font { font-family: 'Cinzel', serif; }
        .text-parchment { color: #f3e5ab; }
        
        /* Custom Scrollbar styled like rough iron/wood */
        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track { background: #2c1810; border-left: 1px solid #5d4037; }
        ::-webkit-scrollbar-thumb { 
            background: #8d6e63; 
            border: 2px solid #3e2723; 
            border-radius: 2px;
        }
        ::-webkit-scrollbar-thumb:hover { background: #a1887f; }

        /* UI Containers */
        .stone-border {
            border: 4px solid #78909c;
            border-radius: 4px;
            box-shadow: 
                inset 2px 2px 0px #cfd8dc,
                inset -2px -2px 0px #37474f,
                4px 4px 10px rgba(0,0,0,0.5);
            background-color: #455a64;
        }

        .parchment-bg {
            background-color: #f3e5ab;
            background-image: url('https://www.transparenttextures.com/patterns/aged-paper.png');
            border: 2px solid #d7ccc8;
            box-shadow: inset 0 0 40px rgba(139, 69, 19, 0.2);
            color: #3e2723;
        }

        .wood-panel {
            background-color: #4e342e;
            background-image: linear-gradient(90deg, transparent 50%, rgba(0,0,0,0.2) 50%);
            background-size: 40px 100%;
            border: 3px solid #3e2723;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.7);
            color: #d7ccc8;
        }

        /* Buttons */
        .btn-medieval {
            font-family: 'Cinzel', serif;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 2px solid #3e2723;
            box-shadow: 0 4px 0 #3e2723;
            transition: all 0.1s;
        }
        .btn-medieval:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #3e2723;
        }
        .btn-red { background: #880e4f; color: #ffecb3; border-color: #4a001f; box-shadow: 0 4px 0 #4a001f; }
        .btn-gold { background: #fbc02d; color: #3e2723; border-color: #f57f17; box-shadow: 0 4px 0 #f57f17; }
        .btn-stone { background: #78909c; color: #263238; border-color: #37474f; box-shadow: 0 4px 0 #37474f; }
        .btn-blue { background: #1565c0; color: #e3f2fd; border-color: #0d47a1; box-shadow: 0 4px 0 #0d47a1; }

        /* Map Styling */
        .map-wrapper {
            background-color: #d7ccc8; /* Sand color fallback */
            border: 8px solid #3e2723;
            border-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0h20v20H0z' fill='%233e2723'/%3E%3C/svg%3E") 30 repeat;
            border-radius: 8px;
            overflow-y: auto;
            position: relative;
            height: 80vh;
            box-shadow: inset 0 0 100px rgba(0,0,0,0.5);
        }

        .map-scroll-content {
            /* Using a desert/texture map or repeating pattern */
            background-color: #e6c288;
            background-image: url('https://arafx.vercel.app/bgmap.webp');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            width: 100%;
            height: 2500px;
            position: relative;
        }

        /* Map Nodes (Castles) */
        .level-node { 
            transition: all 0.3s ease; 
            cursor: pointer; 
            z-index: 20; 
            background-color: #5d4037;
            border: 3px solid #8d6e63;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .level-node:hover { transform: scale(1.15) translateY(-5px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.6); }
        .level-node.locked { filter: grayscale(100%) brightness(40%); cursor: not-allowed; border-color: #424242; background: #212121; }
        .level-node.completed { background-color: #2e7d32; border-color: #81c784; box-shadow: 0 0 15px #66bb6a; }
        .level-node.pending { background-color: #f9a825; border-color: #fff176; animation: bounce-castle 2s infinite; }

        @keyframes bounce-castle {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* Modal Overrides */
        .modal-parchment {
            background-color: #f9fbe7;
            background-image: url('https://www.transparenttextures.com/patterns/parchment.png');
            border: 10px solid transparent;
            border-image: url("data:image/svg+xml,%3Csvg width='30' height='30' viewBox='0 0 30 30' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0h30v30H0z' fill='%235d4037'/%3E%3Crect x='2' y='2' width='26' height='26' stroke='%238d6e63' stroke-width='2' fill='none'/%3E%3C/svg%3E") 30 stretch;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            color: #333;
        }

        /* Game Specific */
        .photon { border-radius: 50%; cursor: pointer; animation: popIn 0.3s ease-out; box-shadow: 0 0 10px gold; }
        @keyframes popIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }
        
        .battery-container { width: 200px; height: 30px; background: #212121; border: 3px solid #757575; border-radius: 4px; position: relative; overflow: hidden; }
        .battery-fill { height: 100%; background: linear-gradient(90deg, #e65100, #ffb300); width: 0%; transition: width 0.2s; }

        /* Shop Cards */
        .avatar-card { 
            background: #3e2723; 
            border: 2px solid #5d4037; 
            transition: all 0.2s; 
            cursor: pointer; 
        }
        .avatar-card:hover { transform: translateY(-5px); border-color: #d7ccc8; }
        .avatar-card.selected { border-color: #ffd700; background: #4e342e; box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); }
        .avatar-card.locked { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

        /* Leaderboard */
        .rank-1 { color: #b71c1c; font-size: 1.5em; text-shadow: 1px 1px 0 #ffeb3b; }
        .rank-2 { color: #616161; font-weight: bold; }
        .rank-3 { color: #795548; font-weight: bold; }
        .current-user-row { background-color: rgba(255, 215, 0, 0.2); border-left: 4px solid #ffd700; }

        /* Castle Upgrade Styles */
        .castle-level-card {
            text-align: center;
            padding: 20px;
            background-color: #eefebe;
            border: 2px dashed #8d6e63;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .castle-icon-large {
            font-size: 5rem;
            color: #5d4037;
            margin-bottom: 10px;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.2);
        }

        /* --- GLOWING WELCOME ANIMATION --- */
        #intro-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 1.5s ease-out;
        }

        .glowing-text {
            font-family: 'Cinzel', serif;
            font-size: 3rem;
            color: #ffecb3;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 4px;
            animation: neon-medieval 3s infinite alternate;
            padding: 20px;
        }

        @keyframes neon-medieval {
            0% {
                text-shadow: 
                    0 0 10px #bf360c,
                    0 0 20px #bf360c;
                opacity: 0.7;
                transform: scale(0.95);
            }
            100% {
                text-shadow: 
                    0 0 20px #ff6f00,
                    0 0 40px #ffca28,
                    0 0 60px #ffca28;
                opacity: 1;
                transform: scale(1.05);
            }
        }

        /* Initial Hide for Login Form to Fade In */
        #login-form-container {
            opacity: 0;
            transform: translateY(20px);
            transition: all 1.5s ease-out;
        }

        /* --- BOSS BATTLE STYLES --- */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .shake-effect { animation: shake 0.5s; }
        
        .boss-container {
            background-color: #212121;
            border: 4px solid #880e4f;
            border-radius: 8px;
            padding: 10px;
            position: relative;
            overflow: hidden;
        }
        .hp-bar-bg { width: 100%; height: 20px; bg-gray-700; border: 2px solid white; border-radius: 10px; overflow: hidden; background: #424242; }
        .hp-bar-fill { height: 100%; transition: width 0.3s; }
        .boss-hp { background: linear-gradient(90deg, #c62828, #ff5252); }
        .player-hp { background: linear-gradient(90deg, #2e7d32, #66bb6a); }
    </style>
</head>
<body>

    <script>
        // --- 1. SETUP FIREBASE & SUPABASE ---
        // (SAMA PERSIS DENGAN FILE ASLI)
        const firebaseConfig = {
            apiKey: "AIzaSyDXITJqU0LJbhooNjDWhuZOxp3poDrK5Ss",
            authDomain: "mabessa-36cf1.firebaseapp.com",
            projectId: "mabessa-36cf1",
            storageBucket: "mabessa-36cf1.firebasestorage.app",
            messagingSenderId: "87095823856",
            appId: "1:87095823856:web:9d894e54734ec7eec0a135",
            measurementId: "G-DMVR71M6KR"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const SUPABASE_URL = "https://ggzbopqnncapbrhszagn.supabase.co"; 
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdnemJvcHFubmNhcGJyaHN6YWduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4NTA4NzEsImV4cCI6MjA2OTQyNjg3MX0.NFfanxR8cMzhLNAQFvGQgArkmyxecD8rQZowCbHsgkQ";
        
        let supabaseClient = null;
        try {
            if (SUPABASE_URL.includes("supabase.co")) {
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            }
        } catch (e) { console.error("Supabase init error:", e); }

        const GEMINI_API_KEY = ""; // Opsional

        let currentUserData = null;
        let currentUserDocId = null;

        // Medieval Sounds (Placeholder Logic, using same URLs for function)
        const sounds = {
            correct: new Audio('https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3'),
            wrong: new Audio('https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3'),
            complete: new Audio('https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3'),
            bgm: new Audio('https://arafx.vercel.app/bgm.mp3') // You might want to change this to lute music later!
        };
        sounds.bgm.loop = true; sounds.bgm.volume = 0.2; let isMuted = false;

        function playSound(name) { if(!isMuted && sounds[name]) { sounds[name].currentTime=0; sounds[name].play().catch(()=>{}); }}
        function toggleMute() { isMuted=!isMuted; isMuted?sounds.bgm.pause():sounds.bgm.play().catch(()=>{}); document.getElementById('mute-btn').innerHTML = isMuted?'<i class="fas fa-volume-mute"></i>':'<i class="fas fa-volume-up"></i>'; }
    </script>

    <!-- INTRO OVERLAY -->
    <div id="intro-overlay">
        <h1 class="glowing-text">
            SELAMAT DATANG<br>
            <span style="font-size: 0.6em; color: #ffab00;">PARA KSATRIA FISIKA</span>
        </h1>
    </div>

    <!-- 1. LOGIN PAGE (CASTLE GATE) -->
    <div id="login-page" class="flex flex-col items-center justify-center min-h-screen px-4 bg-[url('https://www.transparenttextures.com/patterns/brick-wall.png')] bg-cover bg-stone-900">
        
        <!-- Login Form Container (Initially Hidden) -->
        <div id="login-form-container" class="relative w-full max-w-md p-8 text-center bg-stone-800/90 border-8 border-stone-600 rounded-t-full shadow-2xl">
            <!-- Torch decoration -->
            <div class="absolute -left-4 top-20 text-4xl animate-pulse text-orange-500"><i class="fas fa-fire"></i></div>
            <div class="absolute -right-4 top-20 text-4xl animate-pulse text-orange-500"><i class="fas fa-fire"></i></div>

            <div class="mb-6">
                <i class="fas fa-shield-alt text-6xl text-amber-600 drop-shadow-lg mb-4"></i>
                <h1 class="text-4xl text-amber-500 mb-2 title-font leading-relaxed drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)]">
                    ENERGY<br>CRUSADE
                </h1>
                <p class="text-stone-400 text-sm italic font-serif">"Taklukkan Ilmu Fisika, Bangun Kejayaan"</p>
            </div>

            <div class="space-y-4 p-6 bg-[#3e2723] rounded-lg border-2 border-[#5d4037]">
                <input type="text" id="login-nisn" onkeypress="if(event.key==='Enter') handleLogin()" placeholder="Nama Tuan / NISN" class="w-full p-3 bg-[#efebe9] text-[#3e2723] rounded font-serif border-2 border-[#8d6e63] focus:border-amber-500 focus:outline-none placeholder-stone-500">
                <input type="password" id="login-pass" onkeypress="if(event.key==='Enter') handleLogin()" placeholder="Kata Sandi Rahasia" class="w-full p-3 bg-[#efebe9] text-[#3e2723] rounded font-serif border-2 border-[#8d6e63] focus:border-amber-500 focus:outline-none placeholder-stone-500">
                
                <button onclick="handleLogin()" class="w-full btn-medieval btn-red py-4 rounded text-lg font-bold shadow-lg mt-4 flex items-center justify-center gap-2">
                    <i class="fas fa-dungeon"></i> MASUK GERBANG
                </button>
            </div>
            <p id="login-error" class="text-red-400 mt-4 text-xs hidden animate-bounce font-bold bg-black/50 p-2 rounded"></p>
        </div>
    </div>

    <!-- 2. STUDENT DASHBOARD (THE CASTLE) -->
    <div id="student-dashboard" class="hidden min-h-screen flex flex-col h-screen overflow-hidden bg-[#2c1810]">
        <!-- Header / Castle Battlement -->
        <nav class="bg-[#3e2723] border-b-4 border-[#1a120b] p-3 z-50 shadow-xl relative">
            <!-- decorative studs -->
            <div class="absolute bottom-0 left-0 w-full h-1 bg-repeat-x" style="background-image: linear-gradient(90deg, #1a120b 50%, transparent 50%); background-size: 20px 100%;"></div>
            
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <!-- Mobile Sidebar Toggle -->
                    <button onclick="toggleSidebar()" class="md:hidden btn-medieval btn-stone text-white px-3 py-2 rounded text-xs border-2 border-stone-500">
                        <i class="fas fa-scroll"></i>
                    </button>

                    <div id="avatar-display" class="w-12 h-12 rounded bg-stone-700 flex items-center justify-center border-4 border-amber-600 shadow-lg">
                        <i class="fas fa-chess-knight text-white text-2xl"></i>
                    </div>
                    <div>
                        <h2 id="student-name" class="font-bold text-amber-100 text-lg title-font drop-shadow-md">Sir Student</h2>
                        <div class="flex items-center gap-2 text-xs text-amber-200/70">
                            <span id="student-xp" class="text-yellow-400 font-bold bg-black/30 px-2 rounded">0 Gold</span>
                            <span id="student-class" class="border-l border-amber-800 pl-2 font-serif">Legion X</span>
                        </div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="toggleMute()" id="mute-btn" class="btn-medieval btn-stone px-3 py-1 rounded text-xs"><i class="fas fa-volume-up"></i></button>
                    <!-- NEW Castle Button -->
                    <button onclick="openCastle()" class="btn-medieval btn-blue px-3 py-1 rounded text-xs font-bold flex items-center gap-1">
                        <i class="fas fa-hammer"></i> <span class="hidden md:inline">BENTENG</span>
                    </button>
                    <!-- Leaderboard Button -->
                    <button onclick="openLeaderboard()" class="btn-medieval btn-gold px-3 py-1 rounded text-xs font-bold flex items-center gap-1">
                        <i class="fas fa-crown"></i> <span class="hidden md:inline">TAHTA</span>
                    </button>
                    <button onclick="openShop()" class="btn-medieval btn-red px-3 py-1 rounded text-xs font-bold flex items-center gap-1">
                        <i class="fas fa-store-alt"></i> <span class="hidden md:inline">PASAR</span>
                    </button>
                    <button onclick="logout()" class="text-red-400 hover:text-red-300 text-xs px-2"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>
        </nav>

        <div class="flex-grow flex flex-col md:flex-row overflow-hidden relative">
            <!-- Sidebar (The Scroll) - Updated for Mobile Overlay -->
            <div id="sidebar-panel" class="md:w-1/4 wood-panel p-4 overflow-y-auto hidden md:block z-30 absolute md:relative w-full h-full top-0 left-0 bg-[#4e342e]">
                
                <!-- Mobile Close Button -->
                <div class="flex justify-between items-center md:hidden mb-4 border-b border-amber-900 pb-2">
                    <span class="text-amber-500 font-bold title-font">GULUNGAN MISI</span>
                    <button onclick="toggleSidebar()" class="text-red-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
                </div>

                <!-- Status Misi -->
                <div class="text-center mb-6">
                    <h3 class="title-font text-amber-500 border-b-2 border-amber-900 pb-1 mb-2 inline-block">TITAH RAJA</h3>
                    <div class="bg-[#3e2723] p-4 rounded border border-[#5d4037] shadow-inner text-left">
                        <p id="mission-status-text" class="text-sm text-amber-100 italic">Menunggu perintah...</p>
                    </div>
                </div>

                <div class="space-y-3 mb-6">
                    <div class="flex justify-between text-xs text-amber-200/60 border-b border-amber-900 pb-1">
                        <span>Wilayah Takluk</span>
                        <span id="stat-level-count" class="font-bold text-amber-100">0/15</span>
                    </div>
                </div>

                <!-- Materi Sidebar -->
                <div class="mt-6 border-t-2 border-amber-900 pt-4">
                    <h3 class="title-font text-sm text-amber-400 mb-3 flex items-center gap-2">
                        <i class="fas fa-scroll"></i> GULUNGAN ILMU <span id="mat-lvl-badge" class="text-[9px] bg-red-900 px-2 py-0.5 rounded text-white ml-auto border border-red-700">Bab 1</span>
                    </h3>
                    <div id="material-list" class="space-y-2 max-h-[300px] overflow-y-auto pr-1">
                        <p class="text-xs text-stone-400 italic text-center py-2">Membuka segel...</p>
                    </div>
                    <!-- Helper Text for Level 5 -->
                    <div id="lkpd-hint" class="hidden mt-4 p-3 bg-amber-900/40 border border-amber-600 rounded text-xs text-amber-200 flex items-start gap-2">
                        <i class="fas fa-exclamation-circle mt-1"></i> 
                        <span>Ambil gulungan tugas (LKPD) di sini sebelum masuk ke arena simulasi!</span>
                    </div>
                </div>
            </div>

            <!-- Map Area (The World) -->
            <div class="md:w-3/4 w-full bg-black relative">
                <div class="map-wrapper" id="map-wrapper">
                    <div class="map-scroll-content" id="map-content"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. UNIVERSAL MODAL (THE SCROLL) -->
    <div id="game-modal" class="modal opacity-0 pointer-events-none fixed inset-0 flex items-center justify-center z-[100]">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="closeModal()"></div>
        
        <!-- Parchment Container -->
        <div class="relative w-full max-w-2xl mx-4 modal-parchment rounded-sm flex flex-col max-h-[90vh]">
            
            <!-- Wax Seal Close Button -->
            <button onclick="closeModal()" class="absolute -top-4 -right-4 w-10 h-10 bg-red-800 rounded-full border-4 border-red-900 text-white flex items-center justify-center shadow-lg hover:bg-red-700 z-50">
                <i class="fas fa-times"></i>
            </button>

            <div class="p-6 border-b-2 border-[#a1887f] flex justify-between items-center bg-[#eefebe]/50">
                <div>
                    <h3 id="modal-title" class="text-2xl font-bold text-[#3e2723] title-font drop-shadow-sm">Misi 1</h3>
                    <span id="modal-type-badge" class="text-[10px] bg-[#3e2723] text-amber-100 px-3 py-1 rounded-full uppercase tracking-wider font-bold">Quiz</span>
                </div>
            </div>

            <div class="p-8 overflow-y-auto flex-grow custom-scrollbar">
                <!-- Intro -->
                <div id="view-intro">
                    <p id="modal-desc" class="text-[#4e342e] mb-8 text-lg font-serif italic leading-relaxed text-center border-y border-[#d7ccc8] py-4"></p>
                    <div id="modal-status-msg" class="hidden p-4 rounded mb-6 text-center text-sm font-bold border-2"></div>
                    <button id="btn-start-action" onclick="startLevelAction()" class="w-full btn-medieval btn-red py-3 rounded shadow-lg text-lg flex items-center justify-center gap-3">
                        <i class="fas fa-sword"></i> MULAI PERJUANGAN
                    </button>
                </div>

                <!-- Quiz -->
                <div id="view-quiz" class="hidden">
                    <div class="flex justify-between mb-4 text-xs font-bold text-[#5d4037] uppercase tracking-widest">
                        <span>Tantangan <span id="q-curr">1</span>/<span id="q-total">0</span></span>
                    </div>
                    <p id="q-text" class="text-xl font-bold text-[#271c19] mb-8 font-serif">Memuat teka-teki...</p>
                    <div id="q-options" class="space-y-4"></div>
                    <div id="q-feedback" class="hidden mt-6 p-4 bg-[#d7ccc8] rounded border-l-4 border-[#3e2723]">
                        <h4 id="fb-title" class="font-bold text-lg mb-2 title-font">Jawaban</h4>
                        <p id="fb-desc" class="text-sm text-[#3e2723] mb-4"></p>
                        <button onclick="nextQuestion()" class="btn-medieval btn-stone px-6 py-2 rounded text-sm w-full">Lanjut <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>

                <!-- BOSS BATTLE VIEW -->
                <div id="view-boss" class="hidden">
                    <div class="boss-container text-center">
                        <!-- Boss Image Area -->
                        <div class="relative w-full h-48 mb-4 rounded border-2 border-stone-600 bg-black overflow-hidden flex justify-center items-center">
                            <img id="boss-image" src="" class="h-full object-cover" alt="Boss">
                            <div class="absolute bottom-0 w-full bg-black/60 text-white font-bold py-1 title-font" id="boss-name">THE BOSS</div>
                        </div>

                        <!-- HP Bars -->
                        <div class="flex gap-4 mb-6">
                            <div class="w-1/2">
                                <div class="text-xs text-green-400 font-bold text-left mb-1">DARAHMU</div>
                                <div class="hp-bar-bg"><div id="player-hp-bar" class="hp-bar-fill player-hp" style="width: 100%;"></div></div>
                            </div>
                            <div class="w-1/2">
                                <div class="text-xs text-red-400 font-bold text-right mb-1">DARAH BOSS</div>
                                <div class="hp-bar-bg"><div id="boss-hp-bar" class="hp-bar-fill boss-hp" style="width: 100%;"></div></div>
                            </div>
                        </div>

                        <!-- Question Area -->
                        <div class="bg-[#eefebe] p-4 rounded border border-[#8d6e63] mb-4">
                            <p id="boss-q-text" class="text-[#3e2723] font-serif font-bold">Bersiap bertarung...</p>
                        </div>

                        <!-- Options -->
                        <div id="boss-options" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <!-- Buttons injected by JS -->
                        </div>
                    </div>
                </div>

                <!-- Upload & Simulation (Level 5 PhET) -->
                <div id="view-upload" class="hidden">
                    <!-- PhET Container -->
                    <div id="phet-container" class="hidden mb-6 w-full h-[400px] bg-[#3e2723] rounded border-4 border-[#5d4037] overflow-hidden relative shadow-inner">
                        <div class="absolute inset-0 flex items-center justify-center text-amber-100/50 text-xs">
                            <i class="fas fa-cog fa-spin mr-2"></i> Membangun Arena...
                        </div>
                        <iframe id="phet-frame" src="" width="100%" height="100%" scrolling="no" allowfullscreen style="position:relative; z-index:10;"></iframe>
                        
                        <a id="phet-fullscreen-btn" href="#" target="_blank" class="absolute top-2 right-2 z-20 btn-medieval btn-stone text-xs px-3 py-1 opacity-90 hover:opacity-100 flex items-center gap-2" title="Buka Layar Penuh">
                            <i class="fas fa-expand"></i> Luaskan
                        </a>
                    </div>

                    <div class="border-4 border-dashed border-[#8d6e63] rounded-lg p-8 text-center hover:bg-[#d7ccc8]/30 transition bg-[#efebe9]/50">
                        <i class="fas fa-scroll text-5xl text-[#5d4037] mb-3"></i>
                        <p class="text-sm text-[#4e342e] mb-4 font-bold">Serahkan Laporan (PDF/Gambar)</p>
                        <input type="file" id="file-input" class="hidden" accept=".pdf, .jpg, .jpeg, .png" onchange="previewFile()">
                        <label for="file-input" class="cursor-pointer btn-medieval btn-stone px-4 py-2 rounded text-sm inline-block">Pilih Dokumen</label>
                        <p id="file-name" class="mt-2 text-xs text-red-700 font-bold"></p>
                    </div>
                    <textarea id="upload-note" class="w-full mt-4 p-3 bg-[#efebe9] border-2 border-[#8d6e63] rounded text-[#3e2723] font-serif" rows="3" placeholder="Pesan untuk Tuan Guru..."></textarea>
                    <button onclick="submitUpload()" id="btn-upload-submit" class="w-full mt-4 btn-medieval btn-green bg-[#2e7d32] text-white border-[#1b5e20] hover:bg-[#1b5e20] py-3 rounded font-bold">KIRIM MERPATI POS</button>
                </div>

                <!-- Game Canvas -->
                <div id="view-game" class="hidden text-center">
                    <div id="game-canvas" class="bg-[#212121] border-4 border-[#424242] rounded p-4 min-h-[300px] flex flex-col items-center justify-center mb-4 relative overflow-hidden shadow-inner"></div>
                    <p id="game-instruction" class="text-xs text-[#5d4037] italic mb-2 font-bold"></p>
                </div>

                <!-- Result -->
                <div id="view-result" class="hidden text-center py-10">
                    <div class="text-6xl mb-6 text-amber-600 drop-shadow-md" id="res-icon"><i class="fas fa-flag"></i></div>
                    <h2 class="text-3xl font-bold text-[#3e2723] mb-3 title-font" id="res-title">Kemenangan!</h2>
                    <p class="text-[#5d4037] text-lg mb-8 font-serif" id="res-msg"></p>
                    <button onclick="closeModal()" class="btn-medieval btn-stone px-8 py-3 rounded font-bold">Kembali ke Peta</button>
                </div>

                <!-- Shop -->
                <div id="view-shop" class="hidden">
                    <div class="flex justify-between items-center mb-6 bg-[#3e2723] p-4 rounded border border-[#5d4037] shadow-lg">
                        <span class="text-sm text-amber-100">Harta Karun:</span>
                        <span id="shop-balance" class="text-yellow-400 font-bold title-font text-xl">0 Gold</span>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-6" id="shop-items"></div>
                </div>

                <!-- NEW: View Castle (Base Building) -->
                <div id="view-castle" class="hidden">
                    <div class="text-center mb-6">
                        <h2 class="title-font text-[#3e2723] text-2xl font-bold">Markas Komando</h2>
                        <p class="text-[#5d4037] text-xs italic">Bangun bentengmu untuk kejayaan!</p>
                    </div>
                    
                    <div id="castle-display" class="castle-level-card">
                        <!-- Content Injected by JS -->
                    </div>

                    <div class="bg-[#efebe9] p-4 rounded border border-[#8d6e63] text-sm text-[#3e2723] mb-4">
                        <p><strong>Tips:</strong> Kumpulkan Gold (XP) dari misi untuk memperkuat benteng pertahananmu dari serangan ketidaktahuan!</p>
                    </div>
                </div>

                <!-- Leaderboard -->
                <div id="view-leaderboard" class="hidden">
                    <div class="text-center mb-6">
                        <i class="fas fa-crown text-5xl text-yellow-600 mb-2 drop-shadow-md"></i>
                        <h2 class="title-font text-[#3e2723] text-xl font-bold">Aula Para Pahlawan</h2>
                        <p class="text-[#5d4037] text-xs italic">Siapa yang terkuat di kerajaan?</p>
                    </div>
                    <div class="bg-[#fff8e1] rounded border-2 border-[#8d6e63] overflow-hidden shadow-inner">
                        <div class="overflow-y-auto max-h-[400px] custom-scrollbar">
                            <table class="w-full text-left text-sm text-[#3e2723]">
                                <thead class="bg-[#d7ccc8] text-xs uppercase font-bold text-[#3e2723] sticky top-0 z-10">
                                    <tr>
                                        <th class="p-3 text-center border-b border-[#a1887f]">#</th>
                                        <th class="p-3 border-b border-[#a1887f]">Ksatria</th>
                                        <th class="p-3 text-right border-b border-[#a1887f]">Kejayaan (XP)</th>
                                    </tr>
                                </thead>
                                <tbody id="leaderboard-list" class="divide-y divide-[#d7ccc8]">
                                    <tr><td colspan="3" class="p-4 text-center text-xs italic">Scribe sedang mencatat...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Material Viewer -->
                <div id="view-material" class="hidden">
                    <div id="mat-content-container" class="w-full h-[400px] bg-black rounded border-4 border-[#3e2723] flex items-center justify-center overflow-hidden"></div>
                    <div class="mt-4 text-center">
                        <a id="mat-open-link" href="#" target="_blank" class="text-[#880e4f] font-bold text-sm hover:underline"><i class="fas fa-external-link-alt"></i> Buka di Lembar Baru</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. ADMIN DASHBOARD (THE KEEP) -->
    <div id="admin-dashboard" class="hidden min-h-screen pb-10 bg-[#1a120b] bg-[url('https://www.transparenttextures.com/patterns/dark-wood.png')]">
        <nav class="bg-[#212121] border-b-4 border-[#b71c1c] p-4 sticky top-0 z-50 shadow-lg">
            <div class="container mx-auto flex justify-between items-center">
                <span class="font-bold text-amber-500 title-font text-lg"><i class="fas fa-chess-king mr-2"></i>RUANG TAHTA (GURU)</span>
                <button onclick="logout()" class="text-red-400 text-sm border border-red-900 px-3 py-1 rounded hover:bg-red-900/50">Tinggalkan Tahta</button>
            </div>
        </nav>

        <div class="container mx-auto mt-8 px-4 grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Admin Panels styled as stone blocks -->
            <div class="lg:col-span-1 space-y-8">
                <!-- Import Siswa -->
                <div class="stone-border p-6">
                    <h3 class="text-amber-400 font-bold mb-4 flex items-center gap-2 title-font"><i class="fas fa-users"></i> Sensus Rakyat</h3>
                    <textarea id="import-area" rows="2" class="w-full p-2 bg-[#263238] text-xs text-white border border-[#37474f] rounded mb-3" placeholder="Nama [TAB] Kelas [TAB] NISN"></textarea>
                    <button onclick="processImport()" class="btn-medieval btn-stone w-full py-2 text-xs font-bold bg-[#37474f] text-white hover:bg-[#455a64]">CATAT PENDUDUK</button>
                </div>

                <!-- Kelola Materi -->
                <div class="stone-border p-6 relative overflow-hidden">
                    <h3 class="text-cyan-300 font-bold mb-4 flex items-center gap-2 title-font"><i class="fas fa-book"></i> Perpustakaan</h3>
                    <div class="space-y-3">
                        <select id="mat-level" class="w-full p-2 bg-[#263238] text-xs text-white border border-[#37474f] rounded"></select>
                        <select id="mat-type" class="w-full p-2 bg-[#263238] text-xs text-white border border-[#37474f] rounded">
                            <option value="youtube">Video (YouTube)</option>
                            <option value="pdf">Dokumen (PDF)</option>
                            <option value="web">Gulungan Web</option>
                        </select>
                        <input id="mat-title" type="text" class="w-full p-2 bg-[#263238] text-xs text-white border border-[#37474f] rounded" placeholder="Judul Materi">
                        <input id="mat-link" type="text" class="w-full p-2 bg-[#263238] text-xs text-white border border-[#37474f] rounded" placeholder="Link (URL)">
                        <button onclick="saveMaterial()" class="btn-medieval w-full py-2 text-xs font-bold bg-[#006064] text-cyan-100 border-[#00838f] hover:bg-[#00838f]">
                            SIMPAN KE RAK
                        </button>
                    </div>
                </div>

                <!-- Bank Soal -->
                <div class="stone-border p-6">
                    <h3 class="text-green-400 font-bold mb-4 flex items-center gap-2 title-font"><i class="fas fa-scroll"></i> Gudang Soal</h3>
                    <div class="mb-4">
                        <button onclick="downloadQuestionTemplate()" class="text-xs text-blue-300 hover:underline mb-2 flex items-center gap-1"><i class="fas fa-download"></i> Unduh Cetakan</button>
                        <input type="file" id="csv-questions" accept=".csv" class="w-full text-xs text-slate-400">
                    </div>
                    <button onclick="processQuestionImport()" class="btn-medieval w-full py-2 text-xs font-bold bg-[#1b5e20] text-green-100 border-[#2e7d32] hover:bg-[#2e7d32] mb-4">IMPORT CSV</button>
                    
                    <hr class="border-[#37474f] my-4">
                    
                    <h3 class="text-purple-300 font-bold mb-2 flex items-center gap-2 title-font"><i class="fas fa-file-export"></i> Arsip Nilai</h3>
                    <button onclick="downloadGrades()" class="btn-medieval w-full py-2 text-xs font-bold bg-[#4a148c] text-purple-100 border-[#6a1b9a] hover:bg-[#6a1b9a]">UNDUH LAPORAN</button>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-8">
                <!-- Validation -->
                <div class="stone-border p-0 overflow-hidden min-h-[300px]">
                    <div class="p-4 bg-[#37474f] border-b border-[#263238] flex justify-between items-center">
                        <h3 class="text-white font-bold title-font"><i class="fas fa-gavel mr-2"></i>Pengadilan Tugas</h3>
                        <div class="flex items-center gap-3">
                            <button onclick="approveSelected()" class="btn-medieval bg-green-700 text-white px-3 py-1 rounded text-xs hover:bg-green-600 font-bold hidden" id="btn-bulk-acc">
                                <i class="fas fa-check-circle mr-1"></i> ACC Massal
                            </button>
                            <span class="text-xs text-slate-300" id="adm-pending">0 Menunggu</span>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm text-slate-300">
                            <thead class="bg-[#263238] text-xs uppercase font-bold text-slate-400">
                                <tr>
                                    <th class="p-3 w-4"><input type="checkbox" id="check-all" onclick="toggleAll(this)" class="cursor-pointer"></th>
                                    <th class="p-3">Siswa</th><th class="p-3">Misi</th><th class="p-3">Bukti</th><th class="p-3">Voniss</th>
                                </tr>
                            </thead>
                            <tbody id="admin-task-list" class="divide-y divide-[#37474f]"></tbody>
                        </table>
                    </div>
                </div>
                <!-- Progress -->
                <div class="stone-border p-0 overflow-hidden">
                     <div class="p-4 bg-[#37474f] border-b border-[#263238] flex flex-col md:flex-row justify-between items-center">
                        <h3 class="text-white font-bold title-font">Kemajuan Pasukan</h3>
                        <input type="text" id="search-student" onkeyup="renderStudentProgressTable()" placeholder="Cari Nama..." class="bg-[#263238] border border-[#546e7a] rounded px-2 py-1 text-xs text-white placeholder-slate-500">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm text-slate-300">
                            <thead class="bg-[#263238] text-xs uppercase font-bold text-slate-400">
                                <tr>
                                    <th class="p-3 sticky left-0 bg-[#37474f] border-r border-[#263238] z-10">Nama</th>
                                    <th class="p-3 text-center border-r border-[#263238]">Kelas</th>
                                    <th class="p-3 text-center border-r border-[#263238]">Avatar</th>
                                    <th class="p-3 text-center border-r border-[#263238]">Gold (XP)</th>
                                    <th class="p-3 text-center border-r border-[#263238]">Benteng</th>
                                    <th class="p-1 text-center">1</th><th class="p-1 text-center">2</th><th class="p-1 text-center">3</th><th class="p-1 text-center">4</th><th class="p-1 text-center">5</th>
                                    <th class="p-1 text-center">6</th><th class="p-1 text-center">7</th><th class="p-1 text-center">8</th><th class="p-1 text-center">9</th><th class="p-1 text-center">10</th>
                                    <th class="p-1 text-center">11</th><th class="p-1 text-center">12</th><th class="p-1 text-center">13</th><th class="p-1 text-center">14</th><th class="p-1 text-center">15</th>
                                    <th class="p-3 text-center border-l border-[#263238] text-amber-400">NILAI</th>
                                </tr>
                            </thead>
                            <tbody id="student-progress-list" class="divide-y divide-[#37474f]"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGIC (EXACT COPY OF ORIGINAL LOGIC) -->
    <script>
        // --- ANIMATION SCRIPT ---
        // Menangani transisi dari Intro Screen ke Login Form
        window.addEventListener('load', () => {
            setTimeout(() => {
                const intro = document.getElementById('intro-overlay');
                intro.style.opacity = '0';
                
                // Setelah fade out selesai (1.5s sesuai CSS), hilangkan elemen dan munculkan login form
                setTimeout(() => {
                    intro.style.display = 'none';
                    const loginForm = document.getElementById('login-form-container');
                    loginForm.style.opacity = '1';
                    loginForm.style.transform = 'translateY(0)';
                }, 1500); 
            }, 3000); // Teks tampil selama 3 detik sebelum mulai fade out
        });

        // --- DATA LEVEL ---
        // UPDATED LEVELS 4, 9, 14 TO BOSS MODE
        const levels = [
            { id: 1, type: 'quiz', title: "Energi & Kehidupan", desc: "Konsep Dasar.", icon: "fa-leaf", top: "95%", left: "10%" },
            { id: 2, type: 'quiz', title: "Konsep Usaha", desc: "Definisi W = F.s.", icon: "fa-running", top: "89%", left: "30%" },
            { id: 3, type: 'game', gameType: 'word_scramble', title: "Game: Istilah", desc: "Susun kata.", icon: "fa-gamepad", top: "83%", left: "50%" },
            
            // BOSS 1
            { id: 4, type: 'boss', title: "BOSS: Silent Assassins", desc: "Kalahkan pembunuh bayangan dengan ilmu Energi Mekanik!", icon: "fa-skull", top: "77%", left: "70%", bossImg: "https://arafx.vercel.app/thesilentassassins.jpg" },
            
            { id: 5, type: 'upload', title: "Lab: Skate Park", desc: "Simulasi PhET & Analisis.", icon: "fa-skating", top: "71%", left: "50%" }, 
            { id: 6, type: 'quiz', title: "Daya & Efisiensi", desc: "Menghitung Daya.", icon: "fa-tachometer-alt", top: "65%", left: "30%" },
            { id: 7, type: 'game', gameType: 'energy_sort', title: "Game: Pilah", desc: "Pilah Energi.", icon: "fa-recycle", top: "59%", left: "10%" },
            { id: 8, type: 'quiz', title: "Energi Surya", desc: "Panel Surya.", icon: "fa-solar-panel", top: "53%", left: "30%" },
            
            // BOSS 2
            { id: 9, type: 'boss', title: "BOSS: Black Tyrant", desc: "Hentikan tirani polusi dengan pengetahuan Angin & Air!", icon: "fa-dragon", top: "47%", left: "50%", bossImg: "https://arafx.vercel.app/theblacktyrant.jpg" },
            
            { id: 10, type: 'upload', title: "Prototipe", desc: "Desain alat.", icon: "fa-pencil-ruler", top: "41%", left: "70%" },
            { id: 11, type: 'quiz', title: "Biomassa", desc: "Energi Organik.", icon: "fa-fire", top: "35%", left: "50%" },
            { id: 12, type: 'game', gameType: 'click_target', title: "Game: Foton", desc: "Tangkap Foton.", icon: "fa-bolt", top: "29%", left: "30%" },
            { id: 13, type: 'quiz', title: "Lingkungan", desc: "Dampak Emisi.", icon: "fa-smog", top: "23%", left: "10%" },
            
            // BOSS 3
            { id: 14, type: 'boss', title: "BOSS: Righteous Paladin", desc: "Buktikan kelayakanmu tentang Masa Depan!", icon: "fa-shield-alt", top: "17%", left: "30%", bossImg: "https://arafx.vercel.app/therighteouspaladin.jpg" },
            
            { id: 15, type: 'upload', title: "FINAL PROJECT", desc: "Laporan Akhir.", icon: "fa-flag-checkered", top: "8%", left: "50%" }
        ];

        // --- SHOP DATA ---
        const avatars = [
            { id: 'blue', name: 'Blue Knight', color: 'bg-blue-800', cost: 0 },
            { id: 'red', name: 'Red Crusader', color: 'bg-red-800', cost: 300 },
            { id: 'green', name: 'Forest Ranger', color: 'bg-green-800', cost: 500 },
            { id: 'yellow', name: 'King Gold', color: 'bg-yellow-600', cost: 1000 },
            { id: 'purple', name: 'Royal Mage', color: 'bg-purple-800', cost: 2000 }
        ];

        // --- NEW CASTLE LEVELS ---
        const castleLevels = [
            { id: 1, name: "Perkemahan Liar", cost: 0, icon: "fa-campground", desc: "Tempat istirahat sederhana." },
            { id: 2, name: "Gubuk Kayu", cost: 200, icon: "fa-home", desc: "Perlindungan dasar dari elemen." },
            { id: 3, name: "Menara Batu", cost: 500, icon: "fa-dungeon", desc: "Struktur kokoh untuk memantau musuh." },
            { id: 4, name: "Benteng Besi", cost: 1000, icon: "fa-chess-rook", desc: "Pertahanan yang sulit ditembus." },
            { id: 5, name: "Istana Agung", cost: 2000, icon: "fa-crown", desc: "Simbol kejayaan tertinggi!" }
        ];

        // --- AUTH ---
        async function handleLogin() {
            const nisn = document.getElementById('login-nisn').value;
            const pass = document.getElementById('login-pass').value;
            if(nisn === "ADMIN" && pass === "admin123") {
                switchPage('admin-dashboard'); loadAdminData(); initAdminMaterials(); return;
            }
            try {
                await auth.signInAnonymously();
                const snap = await db.collection('users').where('nisn', '==', nisn).get();
                if(snap.empty || snap.docs[0].data().password !== pass) throw "Login Gagal! Gerbang tertutup.";
                currentUserData = snap.docs[0].data();
                currentUserDocId = snap.docs[0].id;
                playSound('bgm');
                switchPage('student-dashboard');
                setupStudentListener();
                setTimeout(() => scrollToLevel(calculateMaxLevel(currentUserData)), 500);
            } catch (e) { document.getElementById('login-error').innerText = e; document.getElementById('login-error').classList.remove('hidden'); }
        }

        function switchPage(page) {
            ['login-page', 'student-dashboard', 'admin-dashboard'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(page).classList.remove('hidden');
        }
        function logout() { auth.signOut(); location.reload(); }

        // --- STUDENT LOGIC ---
        function setupStudentListener() {
            db.collection('users').doc(currentUserDocId).onSnapshot(doc => {
                currentUserData = doc.data();
                renderMap();
                updateSidebarStats();
                updateAvatarDisplay();
            });
        }
        function updateAvatarDisplay() {
            const colorClass = avatars.find(a => a.id === (currentUserData.avatar || 'blue'))?.color || 'bg-blue-800';
            document.getElementById('avatar-display').className = `w-12 h-12 rounded flex items-center justify-center border-2 border-white transition-colors duration-300 ${colorClass}`;
        }
        function calculateMaxLevel(data) {
            for(let i=1; i<=15; i++) if(data.stats[`level_${i}_status`] !== 'approved') return i;
            return 15;
        }
        function updateSidebarStats() {
            const max = calculateMaxLevel(currentUserData);
            let totalXP = 0;
            for(let i=1; i<=15; i++) if(currentUserData.stats[`level_${i}_status`] === 'approved') totalXP += (currentUserData.stats[`level_${i}_xp`] || 0);
            document.getElementById('student-xp').innerText = `${totalXP} Gold`;
            document.getElementById('student-name').innerText = currentUserData.nama;
            document.getElementById('stat-level-count').innerText = `${Math.min(max, 15)}/15 Wilayah`;
            const st = currentUserData.stats[`level_${max}_status`];
            const txt = document.getElementById('mission-status-text');
            txt.innerText = st==='pending' ? "Menunggu titah raja..." : st==='rejected' ? "DITOLAK! Perbaiki segera." : `Misi Aktif: Wilayah ${max}`;
            txt.className = st==='rejected' ? "text-red-400 font-bold" : "text-amber-100 italic";
            
            // LOAD MATERI UNTUK LEVEL AKTIF
            loadStudentMaterials(max);
            
            // Show hint only on level 5
            const hint = document.getElementById('lkpd-hint');
            if(max === 5) hint.classList.remove('hidden');
            else hint.classList.add('hidden');
        }
        function renderMap() {
            const c = document.getElementById('map-content'); c.innerHTML = "";
            const max = calculateMaxLevel(currentUserData);
            levels.forEach(l => {
                const st = currentUserData.stats[`level_${l.id}_status`] || 'locked';
                let cls = "level-node absolute w-16 h-16 rounded-full flex items-center justify-center shadow-lg bg-[#5d4037] border-2 border-[#8d6e63] text-stone-300";
                
                if(st === 'approved') cls = "level-node absolute w-16 h-16 rounded-full flex items-center justify-center shadow-lg completed bg-[#2e7d32] border-[#81c784] text-white";
                else if(st === 'pending') cls = "level-node absolute w-16 h-16 rounded-full flex items-center justify-center shadow-lg pending bg-[#f9a825] border-[#fff176] text-white";
                else if(st === 'rejected') cls = "level-node absolute w-16 h-16 rounded-full flex items-center justify-center shadow-lg bg-[#c62828] border-[#ef5350] text-white";
                else if(l.id === max && st !== 'approved') cls = "level-node absolute w-16 h-16 rounded-full flex items-center justify-center shadow-lg bg-[#1565c0] border-[#42a5f5] text-white animate-pulse border-4";
                else if(l.id > max) cls += " locked";
                
                const node = document.createElement('div'); node.className = cls;
                node.style.top = l.top; node.style.left = l.left;
                node.onclick = () => openLevelModal(l.id);
                // Changing icons to be more 'castle' like conceptually but keeping fontawesome
                let icon = l.icon;
                if (l.type === 'boss') icon = "fa-skull-crossbones"; // Special icon for boss
                if (st==='approved') icon = "fa-flag"; // Completed castles have flags
                
                node.innerHTML = `<i class="fas ${icon} text-2xl"></i><span class="absolute -bottom-8 w-32 text-center text-[10px] font-bold bg-black/70 px-2 py-1 rounded text-white left-1/2 -translate-x-1/2 border border-[#8d6e63] font-serif">${l.id}. ${l.title}</span>`;
                c.appendChild(node);
            });
        }
        function scrollToLevel(id) {
            const n = levels.find(l => l.id === id);
            if(n) document.getElementById('map-wrapper').scrollTo({ top: (parseFloat(n.top)/100)*2500 - 300, behavior: 'smooth' });
        }

        // --- MATERIAL SYSTEM ---
        function initAdminMaterials() {
            const sel = document.getElementById('mat-level');
            sel.innerHTML = "";
            levels.forEach(l => {
                sel.innerHTML += `<option value="${l.id}">Wilayah ${l.id}: ${l.title}</option>`;
            });
        }

        async function saveMaterial() {
            const level = parseInt(document.getElementById('mat-level').value);
            const title = document.getElementById('mat-title').value;
            const link = document.getElementById('mat-link').value;
            const type = document.getElementById('mat-type').value;

            if(!title || !link) return alert("Mohon isi judul dan link!");

            try {
                await db.collection('materials').add({
                    level: level,
                    title: title,
                    link: link,
                    type: type, 
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert("Gulungan materi berhasil disimpan di perpustakaan!");
                document.getElementById('mat-title').value = "";
                document.getElementById('mat-link').value = "";
            } catch(e) {
                console.error(e);
                alert("Gagal menyimpan materi.");
            }
        }

        function loadStudentMaterials(level) {
            const container = document.getElementById('material-list');
            document.getElementById('mat-lvl-badge').innerText = `Wilayah ${level}`;
            
            db.collection('materials').where('level', '==', level).onSnapshot(snapshot => {
                container.innerHTML = "";
                if(snapshot.empty) {
                    container.innerHTML = `<p class="text-xs text-stone-400 italic text-center py-2">Belum ada gulungan ilmu.</p>`;
                    return;
                }
                
                snapshot.forEach(doc => {
                    const d = doc.data();
                    let iconClass = "fa-link";
                    if (d.type === 'youtube') iconClass = "fa-play-circle";
                    else if (d.type === 'pdf') iconClass = "fa-file-pdf";
                    else if (d.type === 'web') iconClass = "fa-globe";

                    const item = document.createElement('div');
                    item.className = "bg-[#4e342e] p-3 rounded border border-[#5d4037] hover:bg-[#5d4037] transition cursor-pointer flex items-center gap-3 group";
                    item.onclick = () => openMaterialViewer(d);
                    item.innerHTML = `
                        <div class="bg-black/30 w-8 h-8 rounded flex items-center justify-center group-hover:bg-amber-900/50 transition">
                            <i class="fas ${iconClass} text-amber-400 text-sm"></i>
                        </div>
                        <span class="text-xs text-amber-100 font-bold truncate">${d.title}</span>
                    `;
                    container.appendChild(item);
                });
            });
        }

        function openMaterialViewer(material) {
            if (material.type === 'web') {
                window.open(material.link, '_blank');
                return;
            }

            // Hide other views
            ['intro','quiz','upload','game','result','shop','material','leaderboard','castle','boss'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden'));
            document.getElementById('view-material').classList.remove('hidden');
            
            const container = document.getElementById('mat-content-container');
            const openLink = document.getElementById('mat-open-link');
            container.innerHTML = "";
            openLink.href = material.link;

            if (material.type === 'youtube') {
                let content = material.link;
                if (content.trim().startsWith('<iframe')) {
                    content = content.replace(/width="[^"]+"/, 'width="100%"').replace(/height="[^"]+"/, 'height="100%"');
                    container.innerHTML = content;
                } else {
                    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
                    const match = content.match(regExp);
                    if (match && match[2].length === 11) {
                        const videoId = match[2];
                        container.innerHTML = `<iframe width="100%" height="100%" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
                    } else {
                        container.innerHTML = `<div class="text-center p-6 text-white">Video tidak dapat diputar. <a href="${material.link}" target="_blank" class="text-amber-400 underline">Buka di Tab Baru</a></div>`;
                    }
                }
            } else if (material.type === 'pdf') {
                container.innerHTML = `<iframe src="${material.link}" width="100%" height="100%" style="border:none;"></iframe>`;
            }

            document.getElementById('modal-title').innerText = "Gulungan Ilmu";
            document.getElementById('modal-type-badge').innerText = material.type.toUpperCase();
            document.getElementById('game-modal').classList.remove('opacity-0', 'pointer-events-none');
        }

        // --- SHOP SYSTEM ---
        function openShop() {
            ['intro','quiz','upload','game','result','shop','material','leaderboard','castle','boss'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden'));
            document.getElementById('view-shop').classList.remove('hidden');
            
            let totalXP = 0;
            for(let i=1; i<=15; i++) if(currentUserData.stats[`level_${i}_status`] === 'approved') totalXP += (currentUserData.stats[`level_${i}_xp`] || 0);
            const spent = currentUserData.spent_xp || 0;
            const balance = totalXP - spent;
            
            document.getElementById('shop-balance').innerText = `${balance} Gold`;
            const container = document.getElementById('shop-items'); container.innerHTML = "";
            const unlocked = currentUserData.unlocked_avatars || ['blue'];
            const current = currentUserData.avatar || 'blue';

            avatars.forEach(av => {
                const isOwned = unlocked.includes(av.id);
                const isSelected = current === av.id;
                let btnHtml = "";
                
                if (isSelected) btnHtml = `<span class="text-green-400 text-xs font-bold"><i class="fas fa-check"></i> DIPAKAI</span>`;
                else if (isOwned) btnHtml = `<button onclick="equipAvatar('${av.id}')" class="btn-medieval btn-stone text-white px-2 py-1 rounded text-xs w-full">PAKAI</button>`;
                else btnHtml = `<button onclick="buyAvatar('${av.id}', ${av.cost})" class="btn-medieval btn-gold text-[#3e2723] px-2 py-1 rounded text-xs w-full ${balance < av.cost ? 'opacity-50 cursor-not-allowed' : ''}">BELI (${av.cost})</button>`;

                const div = document.createElement('div');
                div.className = `avatar-card p-4 rounded-lg flex flex-col items-center ${isSelected ? 'selected' : ''}`;
                div.innerHTML = `
                    <div class="w-16 h-16 rounded flex items-center justify-center mb-3 border-2 border-[#a1887f] ${av.color} shadow-lg"><i class="fas fa-user-astronaut text-white text-2xl"></i></div>
                    <span class="text-sm font-bold text-[#d7ccc8] mb-3 font-serif">${av.name}</span>
                    ${btnHtml}
                `;
                container.appendChild(div);
            });
            
            document.getElementById('modal-title').innerText = "Pasar Tentara";
            document.getElementById('modal-type-badge').innerText = "MARKET";
            document.getElementById('game-modal').classList.remove('opacity-0', 'pointer-events-none');
        }

        async function buyAvatar(id, cost) {
            let totalXP = 0;
            for(let i=1; i<=15; i++) if(currentUserData.stats[`level_${i}_status`] === 'approved') totalXP += (currentUserData.stats[`level_${i}_xp`] || 0);
            const balance = totalXP - (currentUserData.spent_xp || 0);
            
            if(balance >= cost) {
                if(confirm(`Rekrut pasukan ini seharga ${cost} Gold?`)) {
                    playSound('correct');
                    const unlocked = currentUserData.unlocked_avatars || ['blue'];
                    await db.collection('users').doc(currentUserDocId).update({
                        spent_xp: (currentUserData.spent_xp || 0) + cost,
                        unlocked_avatars: [...unlocked, id]
                    });
                    openShop(); 
                }
            } else {
                playSound('wrong');
                alert("Gold tidak cukup! Selesaikan misi untuk mendapatkan upeti.");
            }
        }

        async function equipAvatar(id) {
            await db.collection('users').doc(currentUserDocId).update({ avatar: id });
            playSound('correct');
            openShop();
        }

        // --- CASTLE BUILDING SYSTEM ---
        function openCastle() {
            // Hide other views
            ['intro','quiz','upload','game','result','shop','material','leaderboard','castle','boss'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden'));
            document.getElementById('view-castle').classList.remove('hidden');
            
            document.getElementById('modal-title').innerText = "Markas Komando";
            document.getElementById('modal-type-badge').innerText = "BASE";
            document.getElementById('game-modal').classList.remove('opacity-0', 'pointer-events-none');

            // Calculate Balance
            let totalXP = 0;
            for(let i=1; i<=15; i++) if(currentUserData.stats[`level_${i}_status`] === 'approved') totalXP += (currentUserData.stats[`level_${i}_xp`] || 0);
            const spent = currentUserData.spent_xp || 0;
            const balance = totalXP - spent;

            const currentLevel = currentUserData.castle_level || 1;
            const currentCastle = castleLevels.find(c => c.id === currentLevel);
            const nextCastle = castleLevels.find(c => c.id === currentLevel + 1);

            const display = document.getElementById('castle-display');
            
            let upgradeHtml = "";
            if (nextCastle) {
                const canAfford = balance >= nextCastle.cost;
                upgradeHtml = `
                    <div class="mt-4 pt-4 border-t border-[#8d6e63]">
                        <p class="text-xs text-[#5d4037] mb-2">Peningkatan Selanjutnya:</p>
                        <h4 class="font-bold text-[#3e2723] mb-1">${nextCastle.name}</h4>
                        <button onclick="upgradeCastle(${nextCastle.id}, ${nextCastle.cost})" 
                            class="btn-medieval ${canAfford ? 'btn-green bg-[#2e7d32] text-white' : 'bg-gray-400 text-gray-700 cursor-not-allowed'} px-6 py-2 rounded text-sm w-full"
                            ${!canAfford ? 'disabled' : ''}>
                            Tingkatkan (${nextCastle.cost} Gold)
                        </button>
                        ${!canAfford ? `<p class="text-[10px] text-red-600 mt-1 font-bold">Kurang ${nextCastle.cost - balance} Gold</p>` : ''}
                    </div>
                `;
            } else {
                upgradeHtml = `<div class="mt-4 pt-4 border-t border-[#8d6e63] text-green-700 font-bold">Benteng Maksimal Tercapai!</div>`;
            }

            display.innerHTML = `
                <i class="fas ${currentCastle.icon} castle-icon-large"></i>
                <h3 class="text-xl font-bold text-[#3e2723] title-font">${currentCastle.name}</h3>
                <p class="text-sm text-[#5d4037] italic mb-4">${currentCastle.desc}</p>
                <div class="text-xs bg-[#fff8e1] p-2 rounded inline-block border border-[#8d6e63]">
                    Saldo Saat Ini: <span class="font-bold text-amber-600">${balance} Gold</span>
                </div>
                ${upgradeHtml}
            `;
        }

        async function upgradeCastle(levelId, cost) {
            if(confirm(`Tingkatkan benteng ke Level ${levelId} seharga ${cost} Gold?`)) {
                playSound('correct');
                await db.collection('users').doc(currentUserDocId).update({
                    spent_xp: (currentUserData.spent_xp || 0) + cost,
                    castle_level: levelId
                });
                alert("Pembangunan selesai! Bentengmu semakin kuat.");
                openCastle(); 
            }
        }

        // --- GAME/MODAL ---
        let activeLevel = null;
        let currentQs = [];
        let currentQIdx = 0;
        let quizScore = 0; 
        let levelStartTime = 0;
        
        async function openLevelModal(id) {
            const max = calculateMaxLevel(currentUserData);
            const st = currentUserData.stats[`level_${id}_status`];
            if(id > max && st !== 'approved') return;

            activeLevel = id;
            levelStartTime = Date.now(); 

            const l = levels.find(x => x.id === id);
            document.getElementById('modal-title').innerText = `Wilayah ${id}: ${l.title}`;
            document.getElementById('modal-type-badge').innerText = l.type.toUpperCase();
            document.getElementById('modal-desc').innerText = l.desc;
            
            ['intro','quiz','upload','game','result','shop','material','leaderboard','castle','boss'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden'));
            document.getElementById('view-intro').classList.remove('hidden');
            
            const btn = document.getElementById('btn-start-action');
            const msg = document.getElementById('modal-status-msg');
            msg.className = "hidden"; btn.classList.remove('hidden');

            if(st === 'approved') { 
                msg.className="block p-4 bg-green-100 border-2 border-green-600 text-green-900 rounded mb-6 text-center font-bold"; 
                msg.innerHTML="<i class='fas fa-check-circle'></i> WILAYAH DITAKLUKKAN"; 
                btn.classList.add('hidden'); 
            } else if(st === 'pending') { 
                msg.className="block p-4 bg-yellow-100 border-2 border-yellow-600 text-yellow-900 rounded mb-6 text-center font-bold"; 
                msg.innerHTML="<i class='fas fa-hourglass-half'></i> MENUNGGU KEPUTUSAN RAJA"; 
                btn.classList.add('hidden'); 
            } else if(st === 'rejected') { 
                msg.className="block p-4 bg-red-100 border-2 border-red-600 text-red-900 rounded mb-6 text-center font-bold"; 
                msg.innerHTML=`<i class='fas fa-times-circle'></i> DITOLAK: "${currentUserData.stats[`level_${id}_note`]||'Revisi Strategi.'}"`; 
            }
            
            document.getElementById('game-modal').classList.remove('opacity-0', 'pointer-events-none');
        }
        function closeModal() { 
            document.getElementById('game-modal').classList.add('opacity-0', 'pointer-events-none');
            document.getElementById('phet-frame').src = "";
            if(gameInterval) clearInterval(gameInterval);
            if(gameTimer) clearTimeout(gameTimer);
        }

        async function startLevelAction() {
            document.getElementById('view-intro').classList.add('hidden');
            const type = levels.find(l => l.id === activeLevel).type;
            
            if(type === 'quiz') {
                await startQuiz();
            }
            else if(type === 'boss') {
                await startBossBattle();
            }
            else if(type === 'upload') {
                document.getElementById('view-upload').classList.remove('hidden');
                const phetContainer = document.getElementById('phet-container');
                const phetFrame = document.getElementById('phet-frame');
                const phetBtn = document.getElementById('phet-fullscreen-btn');
                
                if (activeLevel === 5) {
                    phetContainer.classList.remove('hidden');
                    const url = "https://phet.colorado.edu/sims/html/energy-skate-park/latest/energy-skate-park_en.html";
                    phetFrame.src = url;
                    if(phetBtn) phetBtn.href = url;
                } else {
                    phetContainer.classList.add('hidden');
                    phetFrame.src = ""; 
                }
            }
            else {
                startGame(levels.find(l => l.id === activeLevel).gameType);
            }
        }

        // --- BOSS BATTLE LOGIC ---
        let bossState = { hp: 100, maxHp: 100, playerHp: 3, maxPlayerHp: 3, questions: [], currentQ: 0 };

        async function startBossBattle() {
            document.getElementById('view-boss').classList.remove('hidden');
            const levelData = levels.find(l => l.id === activeLevel);
            
            document.getElementById('boss-image').src = levelData.bossImg;
            document.getElementById('boss-name').innerText = levelData.title;
            
            // Fetch Questions
            bossState.questions = [];
            bossState.currentQ = 0;
            bossState.hp = 100;
            bossState.playerHp = 3; 
            
            updateBossUI();

            try {
                const snap = await db.collection('questions').where('level', '==', activeLevel).get();
                snap.forEach(doc => bossState.questions.push(doc.data()));
                
                if(bossState.questions.length === 0) {
                    alert("Boss belum memiliki soal serangan! Hubungi Guru.");
                    closeModal();
                    return;
                }
                
                renderBossQuestion();
            } catch(e) { console.error(e); }
        }

        function updateBossUI() {
            document.getElementById('boss-hp-bar').style.width = `${bossState.hp}%`;
            document.getElementById('player-hp-bar').style.width = `${(bossState.playerHp/3)*100}%`;
        }

        function renderBossQuestion() {
            if (bossState.currentQ >= bossState.questions.length) {
                // Out of questions - loop or reshuffle? Let's loop for boss
                bossState.currentQ = 0;
            }
            
            const q = bossState.questions[bossState.currentQ];
            document.getElementById('boss-q-text').innerText = q.q;
            
            const div = document.getElementById('boss-options'); div.innerHTML = "";
            q.opts.forEach((o, i) => {
                const btn = document.createElement('button');
                btn.className = "p-3 bg-[#3e2723] text-amber-100 border border-[#5d4037] rounded hover:bg-[#5d4037] text-left text-sm font-bold transition";
                btn.innerText = o;
                btn.onclick = () => handleBossAnswer(i, q.a);
                div.appendChild(btn);
            });
        }

        function handleBossAnswer(selected, correct) {
            const bossView = document.getElementById('view-boss');
            
            if (selected === correct) {
                // Player Hits Boss
                playSound('correct');
                const damage = 100 / Math.min(bossState.questions.length, 5); // Minimum 5 hits to kill or question count
                bossState.hp = Math.max(0, bossState.hp - damage);
                
                // Animation
                document.getElementById('boss-image').classList.add('shake-effect');
                setTimeout(()=>document.getElementById('boss-image').classList.remove('shake-effect'), 500);

                if (bossState.hp <= 0) {
                    finishLevel(100, 'boss');
                    return;
                }
            } else {
                // Boss Hits Player
                playSound('wrong');
                bossState.playerHp--;
                bossView.classList.add('shake-effect');
                setTimeout(()=>bossView.classList.remove('shake-effect'), 500);

                if (bossState.playerHp <= 0) {
                    alert("Ksatria Gugur! Cobalah lagi dengan strategi yang lebih baik.");
                    closeModal();
                    return;
                }
            }
            
            updateBossUI();
            bossState.currentQ++;
            setTimeout(renderBossQuestion, 800); // Slight delay for impact
        }

        // --- QUIZ (Standard) ---
        async function startQuiz() {
            document.getElementById('view-quiz').classList.remove('hidden');
            document.getElementById('q-feedback').classList.add('hidden'); 
            
            currentQs = []; quizScore = 0; currentQIdx = 0;
            try {
                const snap = await db.collection('questions').where('level', '==', activeLevel).get();
                snap.forEach(doc => currentQs.push(doc.data()));
            } catch(e) { console.error(e); }

            if(currentQs.length === 0) currentQs = [{q:"Soal belum tersedia di gudang senjata.", opts:["A","B","C","D"], a:0, exp:"-" }];
            renderQuestion(0);
        }

        function renderQuestion(idx) {
            document.getElementById('q-feedback').classList.add('hidden'); 
            
            if(idx >= currentQs.length) { 
                const finalScore = Math.round((quizScore / currentQs.length) * 100);
                playSound('complete');
                finishLevel(finalScore, 'quiz'); 
                return; 
            }
            
            const q = currentQs[idx];
            document.getElementById('q-curr').innerText = idx + 1;
            document.getElementById('q-total').innerText = currentQs.length;
            document.getElementById('q-text').innerText = q.q;
            
            const div = document.getElementById('q-options'); div.innerHTML = "";
            q.opts.forEach((o, i) => {
                const btn = document.createElement('button');
                btn.className = "option-btn w-full text-left p-4 rounded border-2 border-[#8d6e63] bg-[#efebe9] text-[#3e2723] hover:bg-[#d7ccc8] font-serif font-bold transition";
                btn.innerText = o;
                btn.onclick = () => showFeedback(i, q, idx);
                div.appendChild(btn);
            });
        }

        function showFeedback(userAnswerIdx, questionData, currentIdx) {
            const opts = document.getElementById('q-options').children;
            for(let btn of opts) btn.disabled = true;

            const isCorrect = userAnswerIdx === questionData.a;
            if(isCorrect) {
                quizScore++;
                playSound('correct');
                opts[userAnswerIdx].classList.add('bg-green-200', 'border-green-600', 'text-green-900');
            } else {
                playSound('wrong');
                opts[userAnswerIdx].classList.add('bg-red-200', 'border-red-600', 'text-red-900');
                opts[questionData.a].classList.add('bg-green-200', 'border-green-600', 'text-green-900'); 
            }

            const fbBox = document.getElementById('q-feedback');
            const fbTitle = document.getElementById('fb-title');
            const fbDesc = document.getElementById('fb-desc');
            
            fbBox.classList.remove('hidden', 'bg-green-100', 'bg-red-100', 'border-green-600', 'border-red-600');
            
            if(isCorrect) {
                fbBox.classList.add('bg-green-100', 'border-l-green-600');
                fbTitle.innerText = "TEPAT!";
                fbTitle.className = "font-bold text-lg mb-2 title-font text-green-800";
            } else {
                fbBox.classList.add('bg-red-100', 'border-l-red-600');
                fbTitle.innerText = "MELESET!";
                fbTitle.className = "font-bold text-lg mb-2 title-font text-red-800";
            }
            
            fbDesc.innerText = questionData.exp || "Tidak ada petunjuk tambahan.";
            
            currentQIdx = currentIdx + 1; 
        }

        function nextQuestion() { renderQuestion(currentQIdx); }

        // --- UPLOAD LOGIC ---
        function previewFile() {
            const f = document.getElementById('file-input').files[0];
            if(f) document.getElementById('file-name').innerText = f.name;
        }

        async function compressImage(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.src = URL.createObjectURL(file);
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width; canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    let quality = 0.9; const maxBytes = 130 * 1024;
                    function tryCompress() {
                        canvas.toBlob((blob) => {
                            if (!blob) { reject(new Error("Gagal kompresi")); return; }
                            if (blob.size <= maxBytes || quality <= 0.1) {
                                resolve(new File([blob], file.name.replace(/\.[^/.]+$/, "") + ".webp", { type: "image/webp", lastModified: Date.now() }));
                            } else { quality -= 0.1; tryCompress(); }
                        }, 'image/webp', quality);
                    }
                    tryCompress();
                };
                img.onerror = (err) => reject(err);
            });
        }

        async function submitUpload() {
            let f = document.getElementById('file-input').files[0];
            const note = document.getElementById('upload-note').value;
            const btn = document.getElementById('btn-upload-submit');
            
            if(!f) return alert("Pilih dokumen terlebih dahulu!");
            if(!supabaseClient) return alert("Koneksi Supabase Terputus!");

            btn.innerText = "Mengirim Merpati..."; btn.disabled = true;

            try {
                if (f.type.startsWith('image/')) {
                    try { f = await compressImage(f); } catch (err) { console.error(err); alert("Gagal kompresi, mengirim file asli."); }
                } else if (f.type === 'application/pdf') {
                    if (f.size > 2 * 1024 * 1024) throw new Error("Ukuran PDF terlalu besar (Max 2MB).");
                } else {
                    if(f.size > 5 * 1024 * 1024) throw new Error("File terlalu besar (Max 5MB).");
                }

                const path = `${currentUserData.nisn}_${Date.now()}_${f.name.replace(/[^a-zA-Z0-9.]/g,'_')}`;
                const { data, error } = await supabaseClient.storage.from('tugas-uploads').upload(path, f);
                if(error) throw error;
                const { data: { publicUrl } } = supabaseClient.storage.from('tugas-uploads').getPublicUrl(path);
                
                await submitToFirestore(activeLevel, publicUrl, 'upload', note);
                playSound('complete');
                showResult(100, "Laporan Diterima!");
            } catch(e) { alert("Gagal Kirim: " + e.message); } finally { btn.innerText = "KIRIM MERPATI POS"; btn.disabled = false; }
        }

        // --- MINI GAMES ---
        let gameInterval, gameTimer, gameState = {};

        function startGame(type) {
            document.getElementById('view-game').classList.remove('hidden');
            const canvas = document.getElementById('game-canvas');
            canvas.innerHTML = ""; 
            
            if (type === 'word_scramble') {
                gameState = { words: ["ENERGI", "KINETIK", "POTENSIAL", "MEKANIK", "SURYA", "USAHA", "JOULE", "WATT", "NEWTON", "GRAVITASI", "TURBIN", "GENERATOR", "LISTRIK", "MAGNET", "GESEKAN", "FOSIL", "BATUBARA", "MINYAK", "NUKLIR", "URANIUM"], current: 0, score: 0, target: null, scrambled: null };
                renderWordScramble();
            } else if (type === 'energy_sort') {
                gameState = { items: [{n:"Matahari",t:"ren"},{n:"Batu Bara",t:"non"},{n:"Angin",t:"ren"},{n:"Minyak",t:"non"},{n:"Gas",t:"non"}], idx: 0, score: 0 };
                renderEnergySort();
            } else if (type === 'click_target') {
                gameState = { score: 0, time: 30 };
                renderClickTarget();
            }
        }

        function renderWordScramble() {
            const canvas = document.getElementById('game-canvas');
            if(gameState.current >= 3) { finishLevel(Math.round((gameState.score/3)*100), 'game'); return; }
            if (!gameState.target) {
                gameState.target = gameState.words[Math.floor(Math.random()*gameState.words.length)];
                gameState.scrambled = gameState.target.split('').sort(()=>0.5-Math.random()).join('');
            }
            canvas.innerHTML = `
                <div class="text-center">
                    <p class="text-xs text-stone-400 mb-2">Kode Sandi ${gameState.current+1}/3</p>
                    <h2 class="text-4xl font-bold text-amber-500 mb-6 font-mono tracking-widest">${gameState.scrambled}</h2>
                    <div id="hint-display" class="mb-4 text-green-400 text-sm font-bold min-h-[20px]"></div>
                    <input type="text" id="gm-input" class="bg-stone-800 border border-stone-600 p-2 text-center text-white uppercase rounded w-48 mb-4 focus:outline-none focus:border-amber-500" placeholder="JAWABAN...">
                    <br>
                    <div class="flex justify-center gap-2">
                        <button id="gm-hint" class="btn-medieval bg-purple-700 text-white px-4 py-2 rounded text-xs">Petunjuk</button>
                        <button id="gm-check" class="btn-medieval bg-blue-700 text-white px-6 py-2 rounded text-xs">Serang</button>
                    </div>
                </div>
            `;
            document.getElementById('gm-hint').onclick = () => document.getElementById('hint-display').innerText = `Huruf pertama: "${gameState.target[0]}"`;
            document.getElementById('gm-check').onclick = () => {
                const ans = document.getElementById('gm-input').value.toUpperCase();
                if(ans === gameState.target) { playSound('correct'); gameState.score++; } else { playSound('wrong'); alert(`Gagal! Sandinya adalah: ${gameState.target}`); }
                gameState.current++; gameState.target = null; renderWordScramble();
            };
        }

        function renderEnergySort() {
            const canvas = document.getElementById('game-canvas');
            if(gameState.idx >= gameState.items.length) { finishLevel(Math.round((gameState.score/gameState.items.length)*100), 'game'); return; }
            const item = gameState.items[gameState.idx];
            canvas.innerHTML = `<div class="text-center w-full"><div class="mb-8"><span class="text-6xl animate-bounce inline-block text-amber-500"><i class="fas fa-box-open"></i></span><h2 class="text-2xl font-bold text-white mt-4 font-serif">${item.n}</h2></div><div class="flex gap-4 justify-center"><button onclick="checkSort('ren')" class="btn-medieval bg-green-700 text-white px-4 py-3 rounded w-1/2">Terbarukan</button><button onclick="checkSort('non')" class="btn-medieval bg-red-700 text-white px-4 py-3 rounded w-1/2">Tak Terbarukan</button></div></div>`;
        }
        window.checkSort = (t) => {
            if(t === gameState.items[gameState.idx].t) { playSound('correct'); gameState.score++; } else playSound('wrong');
            gameState.idx++; renderEnergySort();
        };

        function renderClickTarget() {
            const canvas = document.getElementById('game-canvas');
            canvas.innerHTML = `<div class="absolute top-2 right-2 text-yellow-400 font-mono text-xl" id="gm-timer">30s</div><div class="absolute top-2 left-2 battery-container"><div class="battery-fill" id="gm-battery"></div></div><div id="gm-play-area" class="w-full h-full relative"></div>`;
            gameTimer = setInterval(() => {
                gameState.time--; document.getElementById('gm-timer').innerText = gameState.time+'s';
                if(gameState.time<=0) { clearInterval(gameTimer); clearInterval(gameInterval); playSound('complete'); finishLevel(Math.min(gameState.score,100), 'game'); }
            }, 1000);
            gameInterval = setInterval(() => spawnPhoton(), 800);
        }
        function spawnPhoton() {
            const area = document.getElementById('gm-play-area'); if(!area) return;
            const dot = document.createElement('div'); dot.className = "photon bg-yellow-400 shadow-[0_0_10px_yellow] absolute";
            const size = Math.random()*30+20; dot.style.width=size+'px'; dot.style.height=size+'px';
            dot.style.left = Math.random()*(area.clientWidth-50)+'px'; dot.style.top = Math.random()*(area.clientHeight-50)+'px';
            dot.onclick = () => { playSound('correct'); gameState.score+=10; dot.remove(); document.getElementById('gm-battery').style.width = Math.min(gameState.score,100)+'%'; if(gameState.score>=100) { clearInterval(gameTimer); clearInterval(gameInterval); playSound('complete'); finishLevel(100,'game'); } };
            area.appendChild(dot); setTimeout(()=>dot.remove(), 1500);
        }

        // --- SUBMISSION & RESULT ---
        async function finishLevel(score, type) {
            const duration = Math.round((Date.now() - levelStartTime) / 1000);
            let speedBonus = type === 'upload' ? 0 : Math.max(0, 50 - duration);
            const totalXP = Math.round(score + speedBonus);
            await submitToFirestore(activeLevel, score, type, '-', totalXP, duration);
            playSound('complete');
            showResult(score, `Wilayah Ditaklukkan! (+${totalXP} Gold)`);
        }

        async function submitToFirestore(lvl, content, type, note, xp=0, time=0) {
            await db.collection('submissions').add({
                nisn: currentUserData.nisn, nama: currentUserData.nama, level: lvl,
                content, type, note, xp, time, status: 'pending', timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            const upd = {}; 
            upd[`stats.level_${lvl}_status`] = 'pending';
            upd[`stats.level_${lvl}_xp`] = xp; 
            upd[`stats.level_${lvl}_time`] = time;
            await db.collection('users').doc(currentUserDocId).update(upd);
        }

        function showResult(score, msg) {
            ['intro','quiz','upload','game','result','shop','leaderboard','castle','boss'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden'));
            document.getElementById('view-result').classList.remove('hidden');
            document.getElementById('res-msg').innerText = `${msg} (Skor Pertempuran: ${score})`;
        }

        // --- LEADERBOARD LOGIC ---
        async function openLeaderboard() {
            ['intro','quiz','upload','game','result','shop','material','leaderboard','castle','boss'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden'));
            document.getElementById('view-leaderboard').classList.remove('hidden');
            
            document.getElementById('modal-title').innerText = "Aula Pahlawan";
            document.getElementById('modal-type-badge').innerText = "RANK";
            document.getElementById('game-modal').classList.remove('opacity-0', 'pointer-events-none');

            const tbody = document.getElementById('leaderboard-list');
            tbody.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-xs italic">Scribe sedang menghitung...</td></tr>`;

            try {
                const snapshot = await db.collection('users').get();
                const allUsers = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    let totalXP = 0;
                    for(let i=1; i<=15; i++) {
                        if(data.stats[`level_${i}_status`] === 'approved') totalXP += (data.stats[`level_${i}_xp`] || 0);
                    }
                    allUsers.push({ name: data.nama, class: data.kelas, avatar: data.avatar || 'blue', xp: totalXP, isMe: data.nisn === currentUserData.nisn });
                });
                allUsers.sort((a, b) => b.xp - a.xp);
                tbody.innerHTML = "";
                allUsers.slice(0, 50).forEach((u, index) => {
                    let rankDisplay = index + 1;
                    let rankClass = "text-stone-600 font-bold";
                    let rowClass = "border-b border-[#a1887f] hover:bg-[#d7ccc8]";
                    if (index === 0) { rankDisplay = '<i class="fas fa-crown"></i>'; rankClass = "rank-1"; }
                    else if (index === 1) { rankDisplay = '2'; rankClass = "rank-2"; }
                    else if (index === 2) { rankDisplay = '3'; rankClass = "rank-3"; }
                    if (u.isMe) rowClass += " current-user-row";

                    // Map avatars for display logic if needed, simplifed here
                    const row = `
                        <tr class="${rowClass}">
                            <td class="p-3 text-center ${rankClass}">${rankDisplay}</td>
                            <td class="p-3 flex items-center gap-3">
                                <i class="fas fa-user-shield text-[#5d4037]"></i>
                                <div>
                                    <div class="font-bold text-[#3e2723] text-xs font-serif uppercase">${u.name} ${u.isMe ? '(Anda)' : ''}</div>
                                    <div class="text-[10px] text-[#795548]">${u.class}</div>
                                </div>
                            </td>
                            <td class="p-3 text-right font-bold text-[#bf360c] title-font text-xs">${u.xp} Gold</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } catch (e) { console.error(e); tbody.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-xs text-red-700">Gagal memuat catatan.</td></tr>`; }
        }

        // --- ADMIN FUNCTIONS (Standard) ---
        function downloadQuestionTemplate() {
            const csv = "Level,Pertanyaan,Opsi A,Opsi B,Opsi C,Opsi D,Index Jawaban (0-3),Penjelasan (Opsional)\n1,Energi matahari?,Air,Surya,Angin,Tanah,1,Karena matahari memancarkan foton.";
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = "template_soal_v2.csv"; a.click();
        }
        function downloadGrades() { 
            let csv = "Nama,NISN,Kelas,Total XP,Nilai Akhir (Skala 100),Predikat,Waktu Total (detik)";
            for(let i=1; i<=15; i++) csv += `,L${i}_Status,L${i}_Skor/Info,L${i}_Waktu(dtk)`;
            csv += "\n";
            db.collection('users').get().then(snap => {
                snap.forEach(doc => {
                    const d = doc.data();
                    let totalXP = 0; let totalTime = 0;
                    let row = `"${d.nama}",${d.nisn},${d.kelas}`;
                    
                    // Calc totals & detail columns
                    let levelCols = "";
                    for(let i=1; i<=15; i++) {
                        const st = d.stats[`level_${i}_status`] || '-';
                        const xp = d.stats[`level_${i}_xp`] || 0;
                        const time = d.stats[`level_${i}_time`] || 0;
                        if(st === 'approved') { totalXP += xp; totalTime += time; }
                        levelCols += `,${st},${xp},${time}`;
                    }
                    
                    // --- NILAI AKHIR CALCULATION ---
                    // Base 70 + (TotalXP / MaxPossibleXP * 30)
                    // Max XP approx: 15 levels * 140 avg XP = 2100
                    const maxPossibleXP = 2100;
                    let finalGrade = 70 + ((totalXP / maxPossibleXP) * 30);
                    // Cap at 100
                    finalGrade = Math.min(100, Math.max(70, finalGrade)).toFixed(2);
                    
                    let predikat = "C";
                    if(finalGrade >= 90) predikat = "A (Sangat Baik)";
                    else if(finalGrade >= 80) predikat = "B (Baik)";
                    else predikat = "C (Cukup)";

                    row += `,${totalXP},${finalGrade},"${predikat}",${totalTime}${levelCols}\n`;
                    csv += row;
                });
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `Rekap_Nilai_Fisika_${new Date().toISOString().slice(0,10)}.csv`; a.click();
            });
        }
        async function processQuestionImport() { /* Same logic */
            const file = document.getElementById('csv-questions').files[0];
            if(!file) return alert("Pilih file!");
            const reader = new FileReader();
            reader.onload = async (e) => {
                const lines = e.target.result.split('\n');
                const batch = db.batch();
                let c = 0;
                for(let i=1; i<lines.length; i++) {
                    const l = lines[i].trim();
                    if(!l) continue;
                    const p = l.split(',');
                    if(p.length >= 7) {
                        const lvl = parseInt(p[0]);
                        if(!isNaN(lvl)) {
                            batch.set(db.collection('questions').doc(), { level: lvl, q: p[1], opts: [p[2],p[3],p[4],p[5]], a: parseInt(p[6]), exp: p[7]||"" });
                            c++;
                        }
                    }
                }
                await batch.commit(); alert(`Berhasil import ${c} soal!`);
            };
            reader.readAsText(file);
        }
        function loadAdminData() { /* Same logic */
            db.collection('submissions').where('status','==','pending').onSnapshot(snap => {
                const l = document.getElementById('admin-task-list'); l.innerHTML = "";
                document.getElementById('adm-pending').innerText = `${snap.size} Menunggu`;
                const bulkBtn = document.getElementById('btn-bulk-acc');
                if (snap.size > 0) bulkBtn.classList.remove('hidden'); else bulkBtn.classList.add('hidden');
                snap.forEach(doc => {
                    const d = doc.data();
                    let ct = d.type === 'upload' ? `<a href="${d.content}" target="_blank" class="text-blue-400 underline">Lihat Bukti</a>` : `<span class="text-yellow-400 font-bold">${d.content}</span>`;
                    l.innerHTML += `
                    <tr class="border-b border-[#546e7a] hover:bg-[#455a64]">
                        <td class="p-3"><input type="checkbox" class="task-cb cursor-pointer" value="${doc.id}" data-nisn="${d.nisn}" data-level="${d.level}" data-nama="${d.nama}"></td>
                        <td class="p-3">${d.nama}<br><span class="text-xs text-slate-400">Wilayah ${d.level}</span></td>
                        <td class="p-3 text-xs">${ct}</td>
                        <td class="p-3 flex gap-2">
                            <button onclick="admAct('${doc.id}','${d.nisn}',${d.level},'approved')" class="text-green-400 hover:text-green-300"><i class="fas fa-check"></i></button>
                            <button onclick="admAct('${doc.id}','${d.nisn}',${d.level},'rejected')" class="text-red-400 hover:text-red-300"><i class="fas fa-times"></i></button>
                        </td>
                    </tr>`;
                });
            });
            db.collection('users').orderBy('nama').onSnapshot(snap => { window.allStd = []; snap.forEach(d=>window.allStd.push(d.data())); renderStudentProgressTable(); });
        }
        function toggleAll(source) { const checkboxes = document.querySelectorAll('.task-cb'); for(let i=0; i<checkboxes.length; i++) checkboxes[i].checked = source.checked; }
        async function approveSelected() { /* Same logic */
            const checkboxes = document.querySelectorAll('.task-cb:checked');
            if(checkboxes.length === 0) return alert("Pilih tugas!");
            if(!confirm(`ACC ${checkboxes.length} tugas?`)) return;
            let promises = [];
            checkboxes.forEach(cb => {
                const id = cb.value; const nisn = cb.dataset.nisn; const level = parseInt(cb.dataset.level);
                const p = (async () => {
                    await db.collection('submissions').doc(id).update({status: 'approved'});
                    const u = await db.collection('users').where('nisn','==',nisn).get();
                    if(!u.empty) { const upd={}; upd[`stats.level_${level}_status`] = 'approved'; await u.docs[0].ref.update(upd); }
                })();
                promises.push(p);
            });
            try { await Promise.all(promises); alert("Berhasil ACC!"); document.getElementById('check-all').checked = false; } catch(e) { console.error(e); alert("Error."); }
        }
        async function admAct(id, nisn, lvl, act) { /* Same logic */
            let note = ""; if(act==='rejected') note = prompt("Alasan penolakan:") || "Revisi";
            const batch = db.batch();
            batch.update(db.collection('submissions').doc(id), {status: act});
            const u = await db.collection('users').where('nisn','==',nisn).get();
            if(!u.empty) { const upd={}; upd[`stats.level_${lvl}_status`]=act; if(act==='rejected') upd[`stats.level_${lvl}_note`]=note; batch.update(u.docs[0].ref, upd); }
            await batch.commit();
        }
        function renderStudentProgressTable() {
            const k = document.getElementById('search-student').value.toLowerCase();
            const l = document.getElementById('student-progress-list'); l.innerHTML = "";
            
            // Helper for colors and icons
            const getAvatarColor = (id) => avatars.find(a => a.id === id)?.color || 'bg-blue-800';
            const getCastleIcon = (lvl) => castleLevels.find(c => c.id === (lvl||1))?.icon || 'fa-campground';

            window.allStd.filter(s=>s.nama.toLowerCase().includes(k)).forEach(s => {
                let totalXP = 0;
                let levelCols = "";
                
                // Calculate XP and build level dots
                for(let i=1; i<=15; i++) {
                    const st = s.stats[`level_${i}_status`];
                    if(st === 'approved') totalXP += (s.stats[`level_${i}_xp`] || 0);
                    let c = "text-slate-600"; if(st==='approved') c="text-green-400"; else if(st==='pending') c="text-yellow-400"; else if(st==='rejected') c="text-red-400";
                    levelCols += `<td class="p-1 text-center ${c}"></td>`;
                }
                
                // Live Grade Calculation
                const maxPossibleXP = 2100;
                let finalGrade = 70 + ((totalXP / maxPossibleXP) * 30);
                finalGrade = Math.min(100, Math.max(70, finalGrade)).toFixed(1);
                
                const avColor = getAvatarColor(s.avatar);
                const castleIcon = getCastleIcon(s.castle_level);

                const rowHTML = `
                    <td class="p-3 sticky left-0 bg-[#37474f] text-white text-xs border-r border-[#263238] z-10 font-bold whitespace-nowrap">${s.nama}</td>
                    <td class="p-3 text-center text-xs border-r border-[#263238] text-stone-300">${s.kelas || '-'}</td>
                    <td class="p-3 text-center border-r border-[#263238]">
                        <div class="w-6 h-6 rounded-full ${avColor} flex items-center justify-center border border-white mx-auto shadow-sm" title="${s.avatar || 'blue'}">
                            <i class="fas fa-user-astronaut text-white text-[10px]"></i>
                        </div>
                    </td>
                    <td class="p-3 text-center text-xs font-bold text-amber-400 border-r border-[#263238]">${totalXP}</td>
                    <td class="p-3 text-center border-r border-[#263238]">
                        <i class="fas ${castleIcon} text-stone-400 text-sm" title="Level Benteng: ${s.castle_level || 1}"></i>
                    </td>
                    ${levelCols}
                    <td class="p-3 text-center border-l border-[#263238] text-amber-400 font-bold pixel-font">${finalGrade}</td>
                `;
                
                l.innerHTML += `<tr class="border-b border-[#263238] hover:bg-[#455a64] transition-colors">${rowHTML}</tr>`;
            });
        }
        async function processImport() { /* Same logic */
            const r = document.getElementById('import-area').value.trim(); if(!r) return;
            const b = db.batch(); r.split('\n').forEach(l=>{const[n,k,ni]=l.split('\t'); if(ni) b.set(db.collection('users').doc(),{nama:n,kelas:k,nisn:ni,password:ni,stats:{}})});
            await b.commit(); alert("Siswa diimport");
        }

        // --- MOBILE SIDEBAR TOGGLE ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar-panel');
            sidebar.classList.toggle('hidden');
        }
    </script>
</body>
</html>