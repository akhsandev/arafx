<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIM BK Digital - Sistem Informasi Bimbingan Konseling</title>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS for utility classes -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Library Animasi: Anime.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    
    <!-- Library Grafik: Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Library Notifikasi: Toastify.js -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    
    <!-- Library Ikon: Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom Styles for Glassmorphism, Animations, and Theme */
        :root {
            --bg-color: #0f172a; /* Slate 900 */
            --primary-color: #38bdf8; /* Sky 400 */
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --font-color: #e2e8f0; /* Slate 200 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--font-color);
            background-image:
                radial-gradient(at 27% 37%, hsla(215, 98%, 61%, 0.1) 0px, transparent 50%),
                radial-gradient(at 97% 21%, hsla(125, 98%, 72%, 0.1) 0px, transparent 50%),
                radial-gradient(at 52% 99%, hsla(355, 98%, 61%, 0.1) 0px, transparent 50%),
                radial-gradient(at 10% 29%, hsla(256, 96%, 61%, 0.1) 0px, transparent 50%),
                radial-gradient(at 97% 96%, hsla(38, 60%, 74%, 0.1) 0px, transparent 50%),
                radial-gradient(at 33% 50%, hsla(222, 67%, 73%, 0.1) 0px, transparent 50%),
                radial-gradient(at 79% 53%, hsla(343, 68%, 79%, 0.1) 0px, transparent 50%);
            overflow: hidden;
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 1.5rem;
        }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.3); }

        .page-enter { opacity: 0; transform: translateY(20px); transition: opacity 0.5s ease, transform 0.5s ease; }
        .page-enter-active { opacity: 1; transform: translateY(0); }
        
        .sidebar-link { transition: all 0.3s ease; position: relative; }
        .sidebar-link:hover, .sidebar-link.active { background: var(--glass-bg); color: white; }
        .sidebar-link.active::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 4px; height: 60%; background-color: var(--primary-color); border-radius: 0 4px 4px 0; }

        .input-glass { background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); transition: all 0.3s ease; }
        .input-glass:focus { background: rgba(0,0,0,0.3); border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.4); }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(15, 23, 42, 0.8); backdrop-filter: blur(8px); display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: all 0.3s ease-in-out; z-index: 50; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { transform: scale(0.9); transition: all 0.3s ease-in-out; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        
        .tab-btn { border-bottom: 2px solid transparent; transition: all 0.3s ease; }
        .tab-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        
        .profile-field {
            border-bottom: 1px solid var(--glass-border);
        }
        .profile-field:last-child {
            border-bottom: none;
        }

    </style>
</head>
<body class="h-screen w-screen flex items-center justify-center">

    <!-- Login Screen -->
    <div id="login-screen" class="w-full max-w-md">
       <div class="glass-panel p-8 text-center">
            <div class="flex items-center justify-center gap-3 mb-2">
                <div class="w-12 h-12 bg-sky-500/20 rounded-lg flex items-center justify-center">
                    <i data-lucide="shield-check" class="text-sky-400 w-8 h-8"></i>
                </div>
                <h1 class="text-3xl font-bold text-white">SIM BK Digital</h1>
            </div>
            <p class="text-slate-400 mb-8">Silakan login untuk melanjutkan</p>
            <form id="login-form">
                <div class="space-y-4 text-left">
                    <input type="email" id="email" class="input-glass w-full p-3 rounded-lg" placeholder="Email" required>
                    <input type="password" id="password" class="input-glass w-full p-3 rounded-lg" placeholder="Password" required>
                </div>
                <button type="submit" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-4 rounded-lg mt-8 transition-all flex items-center justify-center gap-2">
                    <i data-lucide="log-in" class="w-5 h-5"></i> Login
                </button>
            </form>
        </div>
    </div>
    
    <!-- Main Application (Hidden by default) -->
    <div id="main-app" class="hidden w-full h-full p-4 gap-4">
        <nav id="sidebar" class="glass-panel h-full w-64 p-6 flex flex-col justify-between">
            <div>
                <div class="flex items-center gap-3 mb-10">
                    <div class="w-10 h-10 bg-sky-500/20 rounded-lg flex items-center justify-center">
                        <i data-lucide="shield-check" class="text-sky-400"></i>
                    </div>
                    <h1 class="text-xl font-bold text-white">SIM BK</h1>
                </div>
                <ul class="space-y-3" id="nav-links">
                    <li><a href="#/dashboard" class="sidebar-link flex items-center gap-4 p-3 rounded-lg"><i data-lucide="layout-dashboard"></i> Dashboard</a></li>
                    <li><a href="#/janji-temu" class="sidebar-link flex items-center gap-4 p-3 rounded-lg"><i data-lucide="calendar-plus"></i> Janji Temu</a></li>
                    <li><a href="#/siswa" class="sidebar-link flex items-center gap-4 p-3 rounded-lg"><i data-lucide="users"></i> Data Siswa</a></li>
                    <li><a href="#/pelanggaran" class="sidebar-link flex items-center gap-4 p-3 rounded-lg"><i data-lucide="siren"></i> Master Pelanggaran</a></li>
                </ul>
            </div>
            <div class="border-t border-slate-700 pt-4">
                 <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <img id="user-avatar" src="https://placehold.co/40x40/38bdf8/ffffff?text=?" class="rounded-full" alt="User Avatar">
                        <div>
                            <p id="user-name" class="font-semibold text-white">Loading...</p>
                            <p id="user-email" class="text-xs text-slate-400">...</p>
                        </div>
                    </div>
                    <button id="logout-btn" title="Logout" class="text-slate-400 hover:text-red-400 transition-colors"><i data-lucide="log-out"></i></button>
                 </div>
            </div>
        </nav>

        <main id="app-content" class="glass-panel flex-1 h-full overflow-y-auto p-8">
            <!-- Dynamic content will be loaded here -->
        </main>
    </div>

    <!-- Modals -->
    <div id="import-modal" class="modal-overlay">
        <div class="modal-content glass-panel w-full max-w-2xl p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-white">Impor Data Siswa</h3>
                <button id="close-modal-btn" class="text-slate-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div>
                <p class="text-slate-300 mb-2">Salin data dari spreadsheet (Excel, Google Sheets) dan tempel di bawah.</p>
                <p class="text-xs text-amber-400 bg-amber-500/10 p-2 rounded-md mb-4">Format Wajib: <code class="font-mono">NISN, NAMA LENGKAP, KELAS</code>. Setiap siswa di baris baru.</p>
                <textarea id="import-textarea" class="input-glass w-full h-48 p-3 rounded-lg text-sm font-mono" placeholder="Contoh:&#10;0012345678,Budi Hartono,12 IPA 1&#10;0087654321,Cahaya Putri,12 IPS 2"></textarea>
                <div class="flex justify-end gap-4 mt-6">
                    <button id="cancel-import-btn" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-all">Batal</button>
                    <button id="submit-import-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg transition-all flex items-center gap-2">
                        <i data-lucide="upload-cloud"></i> Impor Data
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="add-violation-modal" class="modal-overlay">
        <div class="modal-content glass-panel w-full max-w-lg p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-white">Tambah Pelanggaran</h3>
                <button id="close-violation-modal-btn" class="text-slate-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <form id="add-violation-form">
                <div class="space-y-4">
                    <div>
                        <label for="violation-type" class="block mb-2 text-sm font-medium text-slate-300">Jenis Pelanggaran</label>
                        <select id="violation-type" class="input-glass w-full p-3 rounded-lg" required>
                            <option value="">Pilih jenis pelanggaran...</option>
                        </select>
                    </div>
                    <div>
                        <label for="violation-notes" class="block mb-2 text-sm font-medium text-slate-300">Catatan (Opsional)</label>
                        <textarea id="violation-notes" class="input-glass w-full h-24 p-3 rounded-lg text-sm" placeholder="Contoh: Terlambat 15 menit saat upacara."></textarea>
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-violation-btn" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-all">Batal</button>
                    <button type="submit" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-all flex items-center gap-2">
                        <i data-lucide="plus-circle"></i> Tambah
                    </button>
                </div>
            </form>
        </div>
    </div>
    <div id="add-counseling-modal" class="modal-overlay">
        <div class="modal-content glass-panel w-full max-w-2xl p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-white">Tambah Catatan Konseling</h3>
                <button id="close-counseling-modal-btn" class="text-slate-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <form id="add-counseling-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="counseling-service" class="block mb-2 text-sm font-medium text-slate-300">Jenis Layanan</label>
                        <select id="counseling-service" class="input-glass w-full p-3 rounded-lg" required>
                            <option>Konseling Individu</option>
                            <option>Konseling Kelompok</option>
                            <option>Bimbingan Karir</option>
                            <option>Bimbingan Belajar</option>
                            <option>Konsultasi Orang Tua</option>
                        </select>
                    </div>
                     <div>
                        <label for="counseling-topic" class="block mb-2 text-sm font-medium text-slate-300">Topik / Permasalahan</label>
                        <input type="text" id="counseling-topic" class="input-glass w-full p-3 rounded-lg" placeholder="cth: Kesulitan konsentrasi belajar" required>
                    </div>
                    <div class="md:col-span-2">
                        <label for="counseling-notes" class="block mb-2 text-sm font-medium text-slate-300">Catatan Sesi (Rahasia)</label>
                        <textarea id="counseling-notes" class="input-glass w-full h-28 p-3 rounded-lg text-sm" placeholder="Jelaskan detail sesi di sini..."></textarea>
                    </div>
                     <div class="md:col-span-2">
                        <label for="counseling-followup" class="block mb-2 text-sm font-medium text-slate-300">Rencana Tindak Lanjut</label>
                        <textarea id="counseling-followup" class="input-glass w-full h-20 p-3 rounded-lg text-sm" placeholder="cth: Akan dipantau perkembangannya minggu depan."></textarea>
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-counseling-btn" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-all">Batal</button>
                    <button type="submit" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg transition-all flex items-center gap-2">
                        <i data-lucide="save"></i> Simpan Catatan
                    </button>
                </div>
            </form>
        </div>
    </div>
    <div id="add-appointment-modal" class="modal-overlay">
        <div class="modal-content glass-panel w-full max-w-lg p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-white">Buat Janji Temu</h3>
                <button id="close-appointment-modal-btn" class="text-slate-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <form id="add-appointment-form">
                 <p class="mb-4">Untuk siswa: <strong id="appointment-student-name" class="text-white"></strong></p>
                <div class="space-y-4">
                    <div>
                        <label for="appointment-date" class="block mb-2 text-sm font-medium text-slate-300">Tanggal Janji Temu</label>
                        <input type="datetime-local" id="appointment-date" class="input-glass w-full p-3 rounded-lg" required>
                    </div>
                    <div>
                        <label for="appointment-topic" class="block mb-2 text-sm font-medium text-slate-300">Topik / Tujuan</label>
                        <input type="text" id="appointment-topic" class="input-glass w-full p-3 rounded-lg" placeholder="cth: Konsultasi pemilihan jurusan" required>
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-appointment-btn" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-all">Batal</button>
                    <button type="submit" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg transition-all flex items-center gap-2">
                        <i data-lucide="calendar-plus"></i> Buat Jadwal
                    </button>
                </div>
            </form>
        </div>
    </div>
    <div id="import-profile-json-modal" class="modal-overlay">
        <div class="modal-content glass-panel w-full max-w-3xl p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-white">Impor Profil Siswa (dari JSON)</h3>
                <button id="close-profile-json-modal-btn" class="text-slate-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div>
                <p class="text-slate-300 mb-2">Buka file <code class="font-mono bg-slate-700 px-1 rounded">profil_siswa.json.txt</code>, salin semua isinya, dan tempel di bawah.</p>
                <textarea id="import-profile-json-textarea" class="input-glass w-full h-64 p-3 rounded-lg text-xs font-mono" placeholder="Tempel teks JSON Anda di sini..."></textarea>
                <div class="flex justify-end gap-4 mt-6">
                    <button id="cancel-profile-json-import-btn" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-all">Batal</button>
                    <button id="submit-profile-json-import-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg transition-all flex items-center gap-2">
                        <i data-lucide="upload-cloud"></i> Impor Profil
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, writeBatch, doc, getDoc, getDocs, addDoc, updateDoc, increment, query, orderBy, serverTimestamp, limit, where, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyCs_e2dHSSI5Bdmgzi2cFXlspYpGoj9JlQ",
            authDomain: "sim-bk.firebaseapp.com",
            projectId: "sim-bk",
            storageBucket: "sim-bk.appspot.com",
            messagingSenderId: "665223064144",
            appId: "1:665223064144:web:510cfb7cf8c9cb711ebf55",
            measurementId: "G-SZ5E37FRVW"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const loginScreen = document.getElementById('login-screen');
        const mainApp = document.getElementById('main-app');
        const content = document.getElementById('app-content');
        const importModal = document.getElementById('import-modal');
        const addViolationModal = document.getElementById('add-violation-modal');
        const addCounselingModal = document.getElementById('add-counseling-modal');
        const addAppointmentModal = document.getElementById('add-appointment-modal');
        const importProfileJsonModal = document.getElementById('import-profile-json-modal');
        let currentUser = null;
        let currentStudentId = null;
        let violationChart = null; 

        // --- UTILITIES ---
        const showToast = (message, type = 'success') => {
            Toastify({
                text: message, duration: 3000, gravity: "top", position: "right",
                style: { background: type === 'success' ? "linear-gradient(to right, #00b09b, #96c93d)" : "linear-gradient(to right, #ff5f6d, #ffc371)" }
            }).showToast();
        };
        
        // --- TEMPLATES / VIEWS ---
        const templates = {
            dashboard: `
                <div class="page-content">
                    <h2 class="text-3xl font-bold text-white mb-2">Selamat Datang, <span id="dashboard-user-name">Pengguna</span>!</h2>
                    <p class="text-slate-400 mb-8">Berikut adalah ringkasan aktivitas bimbingan konseling.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="glass-panel p-6 flex items-center justify-between">
                            <div><p class="text-slate-400">Total Siswa</p><p id="total-siswa-stat" class="text-3xl font-bold text-white">...</p></div>
                            <i data-lucide="users" class="text-sky-400 w-8 h-8"></i>
                        </div>
                        <div class="glass-panel p-6 flex items-center justify-between">
                            <div><p class="text-slate-400">Konseling Bulan Ini</p><p id="total-konseling-stat" class="text-3xl font-bold text-white">...</p></div>
                            <i data-lucide="message-square-heart" class="text-emerald-400 w-8 h-8"></i>
                        </div>
                         <div class="glass-panel p-6 flex items-center justify-between">
                            <div><p class="text-slate-400">Janji Temu Baru</p><p id="total-appointment-stat" class="text-3xl font-bold text-white">...</p></div>
                            <i data-lucide="calendar-plus" class="text-amber-400 w-8 h-8"></i>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 glass-panel p-6">
                            <h3 class="font-bold text-white mb-4">Tren Pelanggaran (6 Bulan Terakhir)</h3>
                            <div class="relative h-80">
                                <canvas id="violation-chart"></canvas>
                            </div>
                        </div>
                        <div class="glass-panel p-6">
                            <h3 class="font-bold text-white mb-4">Siswa Perlu Perhatian</h3>
                            <div id="top-violators-list" class="space-y-3">
                                <p class="text-slate-400 text-sm">Memuat data...</p>
                            </div>
                        </div>
                    </div>
                </div>`,
            janjiTemu: `
                 <div class="page-content">
                    <h2 class="text-3xl font-bold text-white mb-8">Manajemen Janji Temu</h2>
                    <div id="appointments-container" class="space-y-6">
                        <div>
                            <h3 class="font-bold text-lg text-amber-400 mb-2">Akan Datang</h3>
                            <div id="upcoming-appointments" class="space-y-3"></div>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-slate-400 mb-2">Selesai</h3>
                            <div id="completed-appointments" class="space-y-3"></div>
                        </div>
                    </div>
                 </div>
            `,
            siswa: `
                <div class="page-content">
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="text-3xl font-bold text-white">Data Siswa</h2>
                        <div class="flex gap-4">
                             <button id="open-import-profile-json-modal-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 transition-all">
                                <i data-lucide="user-check"></i> Impor Profil (JSON)
                            </button>
                            <button id="open-import-modal-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 transition-all">
                                <i data-lucide="upload"></i> Impor Data
                            </button>
                        </div>
                    </div>
                    <div class="glass-panel p-2">
                        <table class="w-full text-left">
                            <thead class="border-b border-slate-700">
                                <tr>
                                    <th class="p-4">Nama</th><th class="p-4">NISN</th><th class="p-4">Kelas</th><th class="p-4">Poin Pelanggaran</th><th class="p-4">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="student-list"></tbody>
                        </table>
                    </div>
                </div>`,
            siswaDetail: `
                <div class="page-content">
                    <div class="flex justify-between items-start">
                         <a href="#/siswa" class="inline-flex items-center gap-2 text-sky-400 hover:text-sky-300 mb-6">
                            <i data-lucide="arrow-left"></i> Kembali ke Daftar Siswa
                        </a>
                        <button id="open-add-appointment-modal" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-3 rounded-lg flex items-center gap-2 text-sm">
                            <i data-lucide="calendar-plus"></i> Buat Janji Temu
                        </button>
                    </div>
                    <div id="student-profile-header" class="flex items-center gap-6 mb-8"></div>
                    <div class="mt-8">
                        <div class="border-b border-slate-700">
                            <nav class="-mb-px flex space-x-8" id="detail-tabs">
                                <button data-tab="profil" class="tab-btn py-4 px-1 text-sm font-medium active">Profil Siswa</button>
                                <button data-tab="pelanggaran" class="tab-btn py-4 px-1 text-sm font-medium">Riwayat Pelanggaran</button>
                                <button data-tab="konseling" class="tab-btn py-4 px-1 text-sm font-medium">Sesi Konseling</button>
                            </nav>
                        </div>
                        <div id="tab-content" class="mt-6"></div>
                    </div>
                </div>`,
            pelanggaran: `
                <div class="page-content">
                    <h2 class="text-3xl font-bold text-white mb-8">Master Data Pelanggaran</h2>
                     <p class="text-slate-400 mb-6">Di sini Anda dapat mengelola jenis pelanggaran dan poinnya.</p>
                     <div class="glass-panel p-2">
                        <table class="w-full text-left">
                            <thead class="border-b border-slate-700">
                                <tr><th class="p-4">Nama Pelanggaran</th><th class="p-4">Kategori</th><th class="p-4">Poin</th></tr>
                            </thead>
                            <tbody id="violation-types-list"></tbody>
                        </table>
                    </div>
                </div>
            `,
        };
        
        // --- RENDER FUNCTIONS ---
        const renderFunctions = {
            dashboard: async () => { 
                content.innerHTML = templates.dashboard;
                if(currentUser && currentUser.nama) {
                    document.getElementById('dashboard-user-name').textContent = currentUser.nama.split(' ')[0];
                }
                lucide.createIcons();
                
                try {
                    const studentsSnapshot = await getDocs(collection(db, "students"));
                    const allStudents = [];
                    studentsSnapshot.forEach(doc => allStudents.push({ id: doc.id, ...doc.data() }));

                    document.getElementById('total-siswa-stat').textContent = allStudents.length;

                    const topViolatorsList = document.getElementById('top-violators-list');
                    const sortedStudents = [...allStudents].sort((a, b) => (b.totalPoinPelanggaran || 0) - (a.totalPoinPelanggaran || 0));
                    topViolatorsList.innerHTML = '';
                    if(sortedStudents.length > 0) {
                        sortedStudents.slice(0, 5).forEach(student => {
                            if ((student.totalPoinPelanggaran || 0) > 0) {
                                const studentEl = document.createElement('a');
                                studentEl.href = `#/siswa/${student.id}`;
                                studentEl.className = 'flex items-center justify-between p-2 rounded-lg hover:bg-white/5 transition-colors';
                                studentEl.innerHTML = `
                                    <div>
                                        <p class="font-semibold text-white">${student.nama}</p>
                                        <p class="text-xs text-slate-400">${student.kelas}</p>
                                    </div>
                                    <span class="font-bold text-red-400">${student.totalPoinPelanggaran} Poin</span>`;
                                topViolatorsList.appendChild(studentEl);
                            }
                        });
                        if (topViolatorsList.innerHTML === '') {
                             topViolatorsList.innerHTML = `<p class="text-slate-400 text-sm">Tidak ada siswa dengan poin pelanggaran.</p>`;
                        }
                    } else {
                        topViolatorsList.innerHTML = `<p class="text-slate-400 text-sm">Belum ada data siswa.</p>`;
                    }

                    const counselingPromises = allStudents.map(s => getDocs(collection(db, `students/${s.id}/counselingLogs`)));
                    const violationPromises = allStudents.map(s => getDocs(collection(db, `students/${s.id}/violations`)));
                    const appointmentsQuery = query(collection(db, 'appointments'), where('counselorId', '==', auth.currentUser.uid), where('status', '==', 'akan datang'));
                    
                    const [allCounselingDocs, allViolationDocs, appointmentSnapshot] = await Promise.all([
                        Promise.all(counselingPromises),
                        Promise.all(violationPromises),
                        getDocs(appointmentsQuery)
                    ]);

                    document.getElementById('total-appointment-stat').textContent = appointmentSnapshot.size;

                    const currentMonth = new Date().getMonth();
                    const currentYear = new Date().getFullYear();
                    let monthlyCounselingCount = 0;
                    allCounselingDocs.forEach(snapshot => {
                        snapshot.forEach(doc => {
                            const logDate = doc.data().tanggal?.toDate();
                            if(logDate && logDate.getMonth() === currentMonth && logDate.getFullYear() === currentYear) {
                                monthlyCounselingCount++;
                            }
                        });
                    });
                    document.getElementById('total-konseling-stat').textContent = monthlyCounselingCount;

                    const violationCountsByMonth = {};
                    allViolationDocs.forEach(snapshot => {
                        snapshot.forEach(doc => {
                            const vioDate = doc.data().tanggal?.toDate();
                            if (vioDate) {
                                const monthKey = `${vioDate.getFullYear()}-${String(vioDate.getMonth() + 1).padStart(2, '0')}`;
                                violationCountsByMonth[monthKey] = (violationCountsByMonth[monthKey] || 0) + 1;
                            }
                        });
                    });

                    const chartLabels = [];
                    const chartData = [];
                    const monthNames = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Ags", "Sep", "Okt", "Nov", "Des"];
                    for (let i = 5; i >= 0; i--) {
                        const d = new Date();
                        d.setMonth(d.getMonth() - i);
                        const monthKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                        chartLabels.push(monthNames[d.getMonth()]);
                        chartData.push(violationCountsByMonth[monthKey] || 0);
                    }
                    
                    const ctx = document.getElementById('violation-chart').getContext('2d');
                    if (violationChart) violationChart.destroy();
                    violationChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: chartLabels,
                            datasets: [{
                                label: 'Jumlah Pelanggaran',
                                data: chartData,
                                borderColor: 'rgb(56, 189, 248)',
                                backgroundColor: 'rgba(56, 189, 248, 0.2)',
                                tension: 0.4,
                                fill: true,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { beginAtZero: true, grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#94a3b8' } },
                                x: { grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#94a3b8' } }
                            },
                            plugins: { legend: { display: false } }
                        }
                    });

                } catch (e) {
                    console.error("Error building dashboard:", e);
                    showToast("Gagal memuat data dashboard.", "error");
                }
            },
            janjiTemu: () => {
                content.innerHTML = templates.janjiTemu;
                const upcomingContainer = document.getElementById('upcoming-appointments');
                const completedContainer = document.getElementById('completed-appointments');

                const q = query(collection(db, 'appointments'), where("counselorId", "==", auth.currentUser.uid));
                
                onSnapshot(q, (snapshot) => {
                    upcomingContainer.innerHTML = '';
                    completedContainer.innerHTML = '';
                    
                    const now = new Date();
                    let upcomingCount = 0;
                    let completedCount = 0;

                    if(snapshot.empty) {
                         upcomingContainer.innerHTML = `<p class="text-slate-400 text-sm">Tidak ada janji temu yang akan datang.</p>`;
                         completedContainer.innerHTML = `<p class="text-slate-400 text-sm">Tidak ada riwayat janji temu.</p>`;
                         return;
                    }

                    const allAppointments = [];
                    snapshot.forEach(doc => {
                        allAppointments.push({ id: doc.id, ...doc.data() });
                    });

                    allAppointments.sort((a, b) => b.appointmentDate.toDate() - a.appointmentDate.toDate());

                    allAppointments.forEach(appt => {
                        const apptDate = appt.appointmentDate.toDate();
                        
                        const apptCard = document.createElement('div');
                        apptCard.className = 'glass-panel p-3 flex items-center justify-between';
                        
                        const dateString = apptDate.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                        const timeString = apptDate.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

                        apptCard.innerHTML = `
                             <div>
                                <p class="font-bold text-white">${appt.topic}</p>
                                <p class="text-sm text-slate-300">dengan <a href="#/siswa/${appt.studentId}" class="text-sky-400 hover:underline">${appt.studentName}</a></p>
                                <p class="text-xs text-slate-400 mt-1">${dateString} - ${timeString}</p>
                            </div>
                            <button data-id="${appt.id}" class="complete-appointment-btn bg-emerald-500 hover:bg-emerald-600 text-white font-bold p-2 rounded-lg flex items-center gap-2 text-xs">
                                <i data-lucide="check-circle"></i> Tandai Selesai
                            </button>
                        `;

                        if (appt.status === 'selesai' || apptDate < now) {
                            apptCard.querySelector('.complete-appointment-btn').remove();
                            completedContainer.appendChild(apptCard);
                            completedCount++;
                        } else {
                            upcomingContainer.appendChild(apptCard);
                            upcomingCount++;
                        }
                    });

                    if(upcomingCount === 0) upcomingContainer.innerHTML = `<p class="text-slate-400 text-sm">Tidak ada janji temu yang akan datang.</p>`;
                    if(completedCount === 0) completedContainer.innerHTML = `<p class="text-slate-400 text-sm">Tidak ada riwayat janji temu.</p>`;
                    lucide.createIcons();
                });
            },
            siswa: () => {
                content.innerHTML = templates.siswa;
                lucide.createIcons();
                const studentList = document.getElementById('student-list');
                
                onSnapshot(collection(db, "students"), (querySnapshot) => {
                    studentList.innerHTML = '';
                    if (querySnapshot.empty) {
                        studentList.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-slate-400">Belum ada data siswa.</td></tr>`;
                        return;
                    }
                    querySnapshot.forEach((doc) => {
                        const student = doc.data();
                        const row = document.createElement('tr');
                        row.className = 'border-b border-slate-800 hover:bg-white/5 transition-colors';
                        row.innerHTML = `
                            <td class="p-4">${student.nama || '-'}</td>
                            <td class="p-4">${student.nisn || '-'}</td>
                            <td class="p-4">${student.kelas || '-'}</td>
                            <td class="p-4 font-bold ${student.totalPoinPelanggaran > 0 ? 'text-red-400' : ''}">${student.totalPoinPelanggaran || 0}</td>
                            <td class="p-4"><a href="#/siswa/${doc.id}" class="text-sky-400 hover:text-sky-300 font-semibold">Detail</a></td>
                        `;
                        studentList.appendChild(row);
                    });
                });
            },
            siswaDetail: async (studentId) => {
                currentStudentId = studentId;
                content.innerHTML = templates.siswaDetail;

                const studentDocRef = doc(db, "students", studentId);
                const studentDocSnap = await getDoc(studentDocRef);
                if (!studentDocSnap.exists()) { content.innerHTML = `<p>Siswa tidak ditemukan.</p>`; return; }
                const student = studentDocSnap.data();

                const header = document.getElementById('student-profile-header');
                header.innerHTML = `
                    <div class="w-20 h-20 bg-sky-500/20 rounded-full flex items-center justify-center text-sky-400 text-4xl font-bold">
                        ${(student.nama || 'S').charAt(0)}
                    </div>
                    <div>
                        <h2 class="text-3xl font-bold text-white">${student.nama}</h2>
                        <p class="text-slate-400">${student.nisn} | ${student.kelas}</p>
                        <p class="mt-1 text-lg">Total Poin: <span class="font-bold text-red-400">${student.totalPoinPelanggaran || 0}</span></p>
                    </div>
                `;
                
                const renderTabContent = (tab) => {
                    const tabContent = document.getElementById('tab-content');
                    if (tab === 'profil') {
                        tabContent.innerHTML = `<div id="profile-content" class="text-slate-300">Memuat data profil...</div>`;
                        const profileContent = document.getElementById('profile-content');
                        
                        const q = query(collection(db, `students/${studentId}/studentProfiles`), limit(1));
                        getDocs(q).then(snapshot => {
                            if(snapshot.empty) {
                                profileContent.innerHTML = `<div class="text-center py-8 text-slate-400">Belum ada data profil siswa.</div>`;
                                return;
                            }
                            const profile = snapshot.docs[0].data();
                            profileContent.innerHTML = `
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                                    <div class="glass-panel p-6">
                                        <h4 class="font-bold text-lg text-white mb-4">Pribadi & Akademik</h4>
                                        <div class="space-y-3 text-sm">
                                            <div class="profile-field flex justify-between py-2"><span class="font-semibold text-slate-400">Hobi</span> <span class="text-right">${profile.hobi || '-'}</span></div>
                                            <div class="profile-field flex justify-between py-2"><span class="font-semibold text-slate-400">Bakat</span> <span class="text-right">${profile.bakat || '-'}</span></div>
                                            <div class="profile-field flex justify-between py-2"><span class="font-semibold text-slate-400">Cita-cita</span> <span class="text-right">${profile.citaCita || '-'}</span></div>
                                            <div class="profile-field flex justify-between py-2"><span class="font-semibold text-slate-400">Motivasi Sekolah</span> <span class="text-right">${profile.motivasiSekolah || '-'}</span></div>
                                        </div>
                                    </div>
                                    <div class="glass-panel p-6">
                                        <h4 class="font-bold text-lg text-white mb-4">Sosial & Perilaku</h4>
                                        <div class="space-y-3 text-sm">
                                            <div class="profile-field flex justify-between py-2"><span class="font-semibold text-slate-400">Kebiasaan Baik</span> <span class="text-right">${profile.kebiasaanBaik || '-'}</span></div>
                                            <div class="profile-field flex justify-between py-2"><span class="font-semibold text-slate-400">Perlu Diubah</span> <span class="text-right">${profile.perilakuPerluDiubah || '-'}</span></div>
                                            <div class="profile-field flex justify-between py-2"><span class="font-semibold text-slate-400">Pertemanan</span> <span class="text-right">${profile.hubunganPertemanan || '-'}</span></div>
                                        </div>
                                    </div>
                                    <div class="md:col-span-2 glass-panel p-6">
                                        <h4 class="font-bold text-lg text-white mb-4">Informasi Keluarga & Lainnya</h4>
                                         <div class="space-y-3 text-sm">
                                            <div class="profile-field flex justify-between py-2"><span class="font-semibold text-slate-400">Keluarga</span> <span class="text-right">${profile.infoKeluarga || '-'}</span></div>
                                            <div class="profile-field flex justify-between py-2"><span class="font-semibold text-slate-400">Riwayat Penyakit</span> <span class="text-right">${profile.riwayatPenyakit || '-'}</span></div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });

                    } else if (tab === 'pelanggaran') {
                        tabContent.innerHTML = `
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-white">Data Pelanggaran</h3>
                                <button id="open-add-violation-modal" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-lg flex items-center gap-2 text-sm">
                                    <i data-lucide="plus"></i> Tambah Pelanggaran
                                </button>
                            </div>
                            <div class="glass-panel p-2">
                                <table class="w-full text-left"><thead class="border-b border-slate-700"><tr><th class="p-3">Tanggal</th><th class="p-3">Pelanggaran</th><th class="p-3">Poin</th><th class="p-3">Catatan</th></tr></thead><tbody id="violations-list"></tbody></table>
                            </div>`;
                        const violationsList = document.getElementById('violations-list');
                        const q = query(collection(db, `students/${studentId}/violations`), orderBy("tanggal", "desc"));
                        onSnapshot(q, (snap) => {
                            violationsList.innerHTML = '';
                            if (snap.empty) {
                                violationsList.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-slate-400">Tidak ada riwayat pelanggaran.</td></tr>`;
                                return;
                            }
                            snap.forEach(vDoc => {
                                const violation = vDoc.data();
                                const date = violation.tanggal?.toDate().toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' }) || 'N/A';
                                const row = document.createElement('tr');
                                row.className = 'border-b border-slate-800 text-sm';
                                row.innerHTML = `
                                    <td class="p-3">${date}</td>
                                    <td class="p-3">${violation.namaPelanggaran}</td>
                                    <td class="p-3 font-bold text-red-400">${violation.poin}</td>
                                    <td class="p-3 text-slate-400">${violation.catatan || '-'}</td>
                                `;
                                violationsList.appendChild(row);
                            });
                        });
                    } else if (tab === 'konseling') {
                        tabContent.innerHTML = `
                             <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-white">Catatan Sesi Konseling</h3>
                                <button id="open-add-counseling-modal" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-3 rounded-lg flex items-center gap-2 text-sm">
                                    <i data-lucide="plus"></i> Tambah Catatan
                                </button>
                            </div>
                            <div id="counseling-logs-list" class="space-y-4"></div>`;
                        
                        const logsList = document.getElementById('counseling-logs-list');
                        const q = query(collection(db, `students/${studentId}/counselingLogs`), orderBy("tanggal", "desc"));
                        onSnapshot(q, (snap) => {
                            logsList.innerHTML = '';
                            if (snap.empty) {
                                logsList.innerHTML = `<div class="text-center py-8 text-slate-400">Belum ada catatan konseling.</div>`;
                                return;
                            }
                            snap.forEach(logDoc => {
                                const log = logDoc.data();
                                const date = log.tanggal?.toDate().toLocaleDateString('id-ID', { day:'2-digit', month:'long', year:'numeric', hour:'2-digit', minute:'2-digit' }) || 'N/A';
                                const logEl = document.createElement('div');
                                logEl.className = 'glass-panel p-4';
                                logEl.innerHTML = `
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="font-bold text-white">${log.topikPermasalahan}</p>
                                            <p class="text-sm text-sky-300">${log.jenisLayanan}</p>
                                        </div>
                                        <p class="text-xs text-slate-400">${date}</p>
                                    </div>
                                    <div class="mt-3 pt-3 border-t border-slate-700 text-sm space-y-2">
                                        <p><strong class="text-slate-300">Catatan Sesi:</strong> ${log.catatanSesi || '-'}</p>
                                        <p><strong class="text-slate-300">Tindak Lanjut:</strong> ${log.tindakLanjut || '-'}</p>
                                    </div>
                                `;
                                logsList.appendChild(logEl);
                            });
                        });
                    }
                    lucide.createIcons();
                };
                
                renderTabContent('profil');

                document.getElementById('detail-tabs').addEventListener('click', (e) => {
                    if (e.target.matches('.tab-btn')) {
                        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                        e.target.classList.add('active');
                        renderTabContent(e.target.dataset.tab);
                    }
                });
                lucide.createIcons();
            },
            pelanggaran: () => {
                content.innerHTML = templates.pelanggaran;
                lucide.createIcons();
                const listContainer = document.getElementById('violation-types-list');
                onSnapshot(collection(db, "violationTypes"), (snapshot) => {
                     listContainer.innerHTML = '';
                     if (snapshot.empty) {
                        listContainer.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-slate-400">Belum ada data master pelanggaran.</td></tr>`;
                        return;
                     }
                     snapshot.forEach(doc => {
                        const type = doc.data();
                        const row = document.createElement('tr');
                        row.className = 'border-b border-slate-800';
                        row.innerHTML = `
                            <td class="p-4">${type.nama}</td>
                            <td class="p-4 text-slate-400">${type.kategori}</td>
                            <td class="p-4 font-bold text-red-400">${type.poin}</td>
                        `;
                        listContainer.appendChild(row);
                     });
                });
            },
        };
        
        // --- ROUTER ---
        const router = () => {
            const path = window.location.hash.slice(1) || '/dashboard';
            const [_, routeKebab, param] = path.split('/');
            const routeCamel = routeKebab.replace(/-([a-z])/g, g => g[1].toUpperCase());
            
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            const activeLink = document.querySelector(`a[href="#/${routeKebab}"]`);
            if(activeLink) activeLink.classList.add('active');

            let renderFunc;
            if (routeCamel === 'siswa' && param) {
                renderFunc = () => renderFunctions.siswaDetail(param);
            } else {
                renderFunc = renderFunctions[routeCamel] || renderFunctions.dashboard;
            }
            
            content.classList.remove('page-enter-active');
            content.classList.add('page-enter');
            
            setTimeout(() => {
                if (typeof renderFunc === 'function') {
                    renderFunc();
                    anime({ targets: '.page-content > *', translateY: [20, 0], opacity: [0, 1], delay: anime.stagger(100) });
                    content.classList.add('page-enter-active');
                }
            }, 100);
        };
        
        // --- AUTHENTICATION LOGIC ---
        const loginForm = document.getElementById('login-form');
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showToast("Login berhasil!", "success");
            } catch (error) {
                console.error("Login error:", error.code);
                let message = "Terjadi kesalahan saat login.";
                if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                    message = "Email atau password salah.";
                }
                showToast(message, "error");
            }
        });

        document.getElementById('logout-btn').addEventListener('click', async () => {
            await signOut(auth);
            showToast("Anda telah logout.", "success");
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    currentUser = userDocSnap.data();
                    document.getElementById('user-name').textContent = currentUser.nama || 'Pengguna';
                    document.getElementById('user-email').textContent = user.email;
                    document.getElementById('user-avatar').src = `https://placehold.co/40x40/38bdf8/ffffff?text=${(currentUser.nama || 'U').charAt(0)}`;
                } else {
                    document.getElementById('user-name').textContent = 'Pengguna Tidak Dikenal';
                    document.getElementById('user-email').textContent = user.email;
                }

                loginScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');
                mainApp.classList.add('flex');
                
                lucide.createIcons();
                router();
            } else {
                currentUser = null;
                loginScreen.classList.remove('hidden');
                mainApp.classList.add('hidden');
                mainApp.classList.remove('flex');
            }
        });
        
        // --- ACTION LOGIC & EVENT LISTENERS ---
        const handleImport = async () => {
            const importButton = document.getElementById('submit-import-btn');
            const originalButtonHTML = importButton.innerHTML;
            importButton.innerHTML = `<span class="animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full"></span><span class="ml-2">Memproses...</span>`;
            importButton.disabled = true;

            const text = document.getElementById('import-textarea').value.trim();
            if (!text) {
                showToast("Area teks kosong, tidak ada data untuk diimpor.", "error");
                importButton.innerHTML = originalButtonHTML;
                lucide.createIcons();
                importButton.disabled = false;
                return;
            }

            const lines = text.split(/\r\n|\n|\r/).filter(line => line.trim() !== '');
            const studentsToImport = [];

            for (const line of lines) {
                const [nisn, nama, kelas] = line.split(/,|\t/).map(s => s.trim());
                if (nisn && nama && kelas) {
                    studentsToImport.push({
                        nisn, nama, kelas, 
                        totalPoinPelanggaran: 0, 
                        createdAt: serverTimestamp()
                    });
                }
            }

            if (studentsToImport.length === 0) {
                showToast("Format data tidak valid atau data kosong. Pastikan formatnya: NISN, NAMA, KELAS.", "error");
                importButton.innerHTML = originalButtonHTML;
                lucide.createIcons();
                importButton.disabled = false;
                return;
            }

            try {
                const batch = writeBatch(db);
                studentsToImport.forEach(student => {
                    const studentRef = doc(collection(db, "students"));
                    batch.set(studentRef, student);
                });
                await batch.commit();
                showToast(`${studentsToImport.length} data siswa berhasil diimpor!`, "success");
                importModal.classList.remove('visible');
                document.getElementById('import-textarea').value = '';
            } catch (error) {
                console.error("Error importing students: ", error);
                showToast("Terjadi kesalahan saat mengimpor data.", "error");
            } finally {
                importButton.innerHTML = originalButtonHTML;
                lucide.createIcons();
                importButton.disabled = false;
            }
        };

        const handleAddViolation = async (e) => {
            e.preventDefault();
            if (!currentStudentId) return;

            const violationSelect = document.getElementById('violation-type');
            const selectedOption = violationSelect.options[violationSelect.selectedIndex];
            
            if(!selectedOption || !selectedOption.dataset.violation) {
                showToast("Pilih jenis pelanggaran terlebih dahulu.", "error");
                return;
            }

            const violationData = JSON.parse(selectedOption.dataset.violation);
            const notes = document.getElementById('violation-notes').value;

            try {
                await addDoc(collection(db, `students/${currentStudentId}/violations`), {
                    namaPelanggaran: violationData.nama,
                    poin: violationData.poin,
                    catatan: notes,
                    tanggal: serverTimestamp()
                });

                const studentDocRef = doc(db, "students", currentStudentId);
                await updateDoc(studentDocRef, {
                    totalPoinPelanggaran: increment(violationData.poin)
                });
                
                showToast("Pelanggaran berhasil ditambahkan!", "success");
                addViolationModal.classList.remove('visible');
                e.target.reset();
            } catch (error) {
                console.error("Error adding violation:", error);
                showToast("Gagal menambahkan pelanggaran.", "error");
            }
        };
        
        const handleAddCounselingLog = async (e) => {
            e.preventDefault();
            if (!currentStudentId) return;

            const newLog = {
                jenisLayanan: document.getElementById('counseling-service').value,
                topikPermasalahan: document.getElementById('counseling-topic').value,
                catatanSesi: document.getElementById('counseling-notes').value,
                tindakLanjut: document.getElementById('counseling-followup').value,
                tanggal: serverTimestamp(),
                counselorId: auth.currentUser.uid,
                counselorName: currentUser.nama || 'Tanpa Nama'
            };

            try {
                await addDoc(collection(db, `students/${currentStudentId}/counselingLogs`), newLog);
                showToast("Catatan konseling berhasil disimpan.", "success");
                addCounselingModal.classList.remove('visible');
                e.target.reset();
            } catch (error) {
                console.error("Error saving counseling log:", error);
                showToast("Gagal menyimpan catatan.", "error");
            }
        };

        const handleAddAppointment = async (e) => {
            e.preventDefault();
            if(!currentStudentId) return;

            const studentDoc = await getDoc(doc(db, "students", currentStudentId));
            if(!studentDoc.exists()) {
                showToast("Data siswa tidak ditemukan.", "error");
                return;
            }

            const newAppt = {
                studentId: currentStudentId,
                studentName: studentDoc.data().nama,
                counselorId: auth.currentUser.uid,
                counselorName: currentUser.nama,
                appointmentDate: new Date(document.getElementById('appointment-date').value),
                topic: document.getElementById('appointment-topic').value,
                status: 'akan datang', // Status: akan datang, selesai
                createdAt: serverTimestamp()
            };

            try {
                await addDoc(collection(db, 'appointments'), newAppt);
                showToast("Janji temu berhasil dibuat.", "success");
                addAppointmentModal.classList.remove('visible');
                e.target.reset();
            } catch (error) {
                console.error("Error creating appointment:", error);
                showToast("Gagal membuat janji temu.", "error");
            }
        };
        
        const handleImportProfileJSON = async () => {
            const importButton = document.getElementById('submit-profile-json-import-btn');
            const originalButtonHTML = importButton.innerHTML;
            importButton.innerHTML = `<span class="animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full"></span><span class="ml-2">Memproses...</span>`;
            importButton.disabled = true;

            const text = document.getElementById('import-profile-json-textarea').value.trim();
            if (!text) {
                showToast("Area teks kosong, tidak ada data untuk diimpor.", "error");
                importButton.innerHTML = originalButtonHTML; lucide.createIcons(); importButton.disabled = false; return;
            }

            let profiles;
            try {
                profiles = JSON.parse(text);
                if (!Array.isArray(profiles)) throw new Error("Format JSON harus berupa array.");
            } catch (e) {
                showToast("Format JSON tidak valid. Pastikan Anda menyalin semuanya.", "error");
                importButton.innerHTML = originalButtonHTML; lucide.createIcons(); importButton.disabled = false; return;
            }

            const notFoundStudents = [];
            let processedCount = 0;

            try {
                const batch = writeBatch(db);
                const studentsSnapshot = await getDocs(collection(db, "students"));
                const studentsMap = new Map();
                studentsSnapshot.forEach(doc => {
                    studentsMap.set(doc.data().nama.toUpperCase().trim(), doc.id);
                });

                profiles.forEach(profile => {
                    if (profile.namaSiswa) {
                        const studentId = studentsMap.get(profile.namaSiswa.toUpperCase().trim());
                        if (studentId) {
                            const profileRef = doc(db, `students/${studentId}/studentProfiles`, "wawancaraAwal");
                            batch.set(profileRef, profile);
                            processedCount++;
                        } else {
                            notFoundStudents.push(profile.namaSiswa);
                        }
                    }
                });

                await batch.commit();

                if (processedCount > 0) showToast(`${processedCount} profil siswa berhasil diimpor!`, "success");
                if (notFoundStudents.length > 0) {
                    const limitedNotFound = notFoundStudents.slice(0, 3).join(", ");
                    const moreCount = notFoundStudents.length > 3 ? ` dan ${notFoundStudents.length - 3} lainnya` : '';
                    showToast(`Gagal menemukan siswa: ${limitedNotFound}${moreCount}`, "error");
                }
                if (processedCount === 0 && notFoundStudents.length > 0) showToast("Tidak ada nama siswa di file yang cocok.", "error");
                
                importProfileJsonModal.classList.remove('visible');
                document.getElementById('import-profile-json-textarea').value = '';

            } catch (e) {
                console.error("Error importing profiles from JSON:", e);
                showToast("Terjadi kesalahan teknis saat menyimpan data.", "error");
            } finally {
                importButton.innerHTML = originalButtonHTML;
                lucide.createIcons();
                importButton.disabled = false;
            }
        };

        document.body.addEventListener('click', async (e) => {
            if (e.target.closest('#open-import-modal-btn')) { importModal.classList.add('visible'); }
            if (e.target.closest('#open-import-profile-json-modal-btn')) { importProfileJsonModal.classList.add('visible'); }
            if (e.target.closest('#open-add-violation-modal')) {
                const select = document.getElementById('violation-type');
                select.innerHTML = '<option value="">Memuat...</option>';
                try {
                    const snapshot = await getDocs(collection(db, "violationTypes"));
                    select.innerHTML = '<option value="">Pilih jenis pelanggaran...</option>';
                    snapshot.forEach(doc => {
                        const violation = { id: doc.id, ...doc.data() };
                        const option = document.createElement('option');
                        option.value = violation.id;
                        option.textContent = `${violation.nama} (+${violation.poin} poin)`;
                        option.dataset.violation = JSON.stringify(violation);
                        select.appendChild(option);
                    });
                    addViolationModal.classList.add('visible');
                } catch(err) {
                     showToast("Gagal memuat data pelanggaran.", "error");
                     console.error("Error fetching violation types:", err);
                }
            }
            if (e.target.closest('#open-add-counseling-modal')) {
                addCounselingModal.classList.add('visible');
            }
            if (e.target.closest('#open-add-appointment-modal')) {
                const studentNameEl = document.getElementById('appointment-student-name');
                const studentDoc = await getDoc(doc(db, "students", currentStudentId));
                if (studentDoc.exists()) {
                    studentNameEl.textContent = studentDoc.data().nama;
                    addAppointmentModal.classList.add('visible');
                } else {
                    showToast("Gagal memuat nama siswa.", "error");
                }
            }
            if(e.target.closest('.complete-appointment-btn')){
                const appointmentId = e.target.closest('.complete-appointment-btn').dataset.id;
                try {
                    await updateDoc(doc(db, 'appointments', appointmentId), { status: 'selesai' });
                    showToast("Janji temu ditandai selesai.", "success");
                } catch(err) {
                    showToast("Gagal memperbarui status.", "error");
                }
            }
        });
        
        // Modal Listeners
        document.getElementById('close-modal-btn').addEventListener('click', () => importModal.classList.remove('visible'));
        document.getElementById('cancel-import-btn').addEventListener('click', () => importModal.classList.remove('visible'));
        document.getElementById('submit-import-btn').addEventListener('click', handleImport);

        document.getElementById('close-violation-modal-btn').addEventListener('click', () => addViolationModal.classList.remove('visible'));
        document.getElementById('cancel-violation-btn').addEventListener('click', () => addViolationModal.classList.remove('visible'));
        document.getElementById('add-violation-form').addEventListener('submit', handleAddViolation);
        
        document.getElementById('close-counseling-modal-btn').addEventListener('click', () => addCounselingModal.classList.remove('visible'));
        document.getElementById('cancel-counseling-btn').addEventListener('click', () => addCounselingModal.classList.remove('visible'));
        document.getElementById('add-counseling-form').addEventListener('submit', handleAddCounselingLog);
        
        document.getElementById('close-appointment-modal-btn').addEventListener('click', () => addAppointmentModal.classList.remove('visible'));
        document.getElementById('cancel-appointment-btn').addEventListener('click', () => addAppointmentModal.classList.remove('visible'));
        document.getElementById('add-appointment-form').addEventListener('submit', handleAddAppointment);
        
        document.getElementById('close-profile-json-modal-btn').addEventListener('click', () => importProfileJsonModal.classList.remove('visible'));
        document.getElementById('cancel-profile-json-import-btn').addEventListener('click', () => importProfileJsonModal.classList.remove('visible'));
        document.getElementById('submit-profile-json-import-btn').addEventListener('click', handleImportProfileJSON);
        
        window.addEventListener('hashchange', router);
        window.addEventListener('load', () => {
            lucide.createIcons();
        });
    </script>
</body>
</html>

