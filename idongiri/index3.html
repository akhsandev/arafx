<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IDONGIRI - Monitoring Pelanggaran Siswa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            transition: background-color 0.3s, color 0.3s;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        main {
            flex-grow: 1;
        }
        .tab-button.active { 
            border-color: #60A5FA; /* blue-400 */
            color: #60A5FA; /* blue-400 */
        }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; } /* slate-800 */
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; } /* slate-600 */
        ::-webkit-scrollbar-thumb:hover { background: #64748b; } /* slate-500 */

        .glass-panel {
            background: rgba(30, 41, 59, 0.75); /* slate-800 with alpha */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(55, 65, 81, 0.5); /* gray-700 with alpha */
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .custom-modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        .suggestion-item:hover {
            background-color: #374151; /* gray-700 */
        }
        .card-item {
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        .card-item:hover {
            transform: translateY(-5px);
        }

        /* Header glow effect for IDONGIRI title */
        .brand-title-glow {
            animation: brandGlowDark 2.5s infinite alternate;
        }

        @keyframes brandGlowDark {
            0%, 100% {
                text-shadow: 0 0 5px rgba(147, 197, 253, 0.6), /* blue-300 */
                             0 0 10px rgba(96, 165, 250, 0.4); /* blue-400 */
            }
            50% {
                text-shadow: 0 0 10px rgba(147, 197, 253, 0.8),
                             0 0 20px rgba(96, 165, 250, 0.6);
            }
        }
        
        .header-glassmorphism {
            background: rgba(15, 23, 42, 0.75); /* slate-900 with alpha */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        .pagination-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-100">

    <!-- Auth Screen -->
    <div id="authScreen" class="min-h-screen flex flex-col items-center justify-center p-4">
        <div class="bg-slate-800 p-8 rounded-xl shadow-2xl w-full max-w-md glass-panel">
            <div class="flex justify-center mb-4">
                <img src="https://arafx.vercel.app/logo.png" alt="Logo SMAN 1 Soppeng" class="h-16 w-16" 
                     onerror="this.alt='Logo tidak termuat'; this.style.display='none';">
            </div>
            <h1 class="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500 mb-1 text-center">IDONGIRI</h1>
            <p class="text-xs text-slate-400 mb-6 text-center">(Implementasi Disiplin Positif Murid)</p>
            
            <div id="authFormContainer">
                <form id="loginForm" class="space-y-6">
                    <div>
                        <label for="loginEmail" class="block text-sm font-medium text-slate-300">Email</label>
                        <input type="email" id="loginEmail" name="loginEmail" required class="mt-1 block w-full px-4 py-3 border border-slate-600 bg-slate-700 text-slate-200 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="anda@email.com">
                    </div>
                    <div>
                        <label for="loginPassword" class="block text-sm font-medium text-slate-300">Password</label>
                        <input type="password" id="loginPassword" name="loginPassword" required class="mt-1 block w-full px-4 py-3 border border-slate-600 bg-slate-700 text-slate-200 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="********">
                    </div>
                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-gradient-to-r from-blue-600 to-purple-700 hover:from-blue-700 hover:to-purple-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150">
                        Login
                    </button>
                    <p class="text-sm text-center text-slate-400">
                        Belum punya akun? <a href="#" id="showRegisterLink" class="font-medium text-blue-400 hover:text-blue-300">Daftar di sini</a>
                    </p>
                </form>

                <form id="registerForm" class="space-y-6 hidden">
                    <div>
                        <label for="registerEmail" class="block text-sm font-medium text-slate-300">Email</label>
                        <input type="email" id="registerEmail" name="registerEmail" required class="mt-1 block w-full px-4 py-3 border border-slate-600 bg-slate-700 text-slate-200 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="anda@email.com">
                    </div>
                    <div>
                        <label for="registerPassword" class="block text-sm font-medium text-slate-300">Password</label>
                        <input type="password" id="registerPassword" name="registerPassword" required class="mt-1 block w-full px-4 py-3 border border-slate-600 bg-slate-700 text-slate-200 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Minimal 6 karakter">
                    </div>
                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150">
                        Daftar
                    </button>
                    <p class="text-sm text-center text-slate-400">
                        Sudah punya akun? <a href="#" id="showLoginLink" class="font-medium text-blue-400 hover:text-blue-300">Login di sini</a>
                    </p>
                </form>
            </div>
            <p id="authError" class="mt-4 text-center text-red-400 text-sm"></p>
        </div>
    </div>

    <!-- Main App Screen (Hidden by default) -->
    <div id="appScreen" class="hidden flex-grow flex flex-col">
        <header class="p-4 shadow-lg sticky top-0 z-50 flex justify-between items-center header-glassmorphism">
            <div class="flex items-center">
                <img src="https://arafx.vercel.app/logo.png" alt="Logo SMAN 1 Soppeng" class="h-10 w-auto mr-3"
                     onerror="this.alt='Logo'; this.style.backgroundColor='#cbd5e1'; this.style.padding='2px'; this.style.borderRadius='8px';"> 
                <div>
                    <h1 class="text-2xl font-bold brand-title-glow text-white">IDONGIRI</h1>
                    <p class="text-xs text-slate-300 tracking-wide">(Implementasi Disiplin Positif Murid)</p>
                </div>
            </div>
            <div class="flex items-center">
                <span id="userEmailDisplay" class="mr-3 text-sm text-slate-300 hidden md:inline"></span>
                <button id="viewToggleButton" class="mr-3 p-2 rounded-full text-slate-300 hover:bg-white/20 transition-colors duration-200" title="Ganti Tampilan">
                    <svg id="cardViewIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zm0 7a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zm0 7a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zm0 7a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2zm0 7a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                    </svg>
                    <svg id="listViewIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                    </svg>
                </button>
                <button id="logoutButton" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg text-sm font-medium transition duration-150">Logout</button>
            </div>
        </header>

        <nav id="tabNavigationView" class="bg-slate-800/90 backdrop-blur-md shadow-sm sticky top-[72px] z-40 hidden"> 
            <div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8">
                <div class="relative flex items-center justify-center h-16">
                    <div class="flex space-x-1 sm:space-x-2 md:space-x-4">
                        <button data-tab="rekap" class="tab-button py-2 px-3 sm:px-4 font-medium text-sm text-slate-300 hover:text-blue-400 border-b-2 border-transparent hover:border-blue-400 transition duration-150">Rekap Pelanggaran</button>
                        <button data-tab="inputSiswa" class="tab-button py-2 px-3 sm:px-4 font-medium text-sm text-slate-300 hover:text-blue-400 border-b-2 border-transparent hover:border-blue-400 transition duration-150">Input Pelanggaran</button>
                        <button data-tab="grafik" class="tab-button py-2 px-3 sm:px-4 font-medium text-sm text-slate-300 hover:text-blue-400 border-b-2 border-transparent hover:border-blue-400 transition duration-150">Grafik Penanganan</button>
                        <button data-tab="database" class="tab-button py-2 px-3 sm:px-4 font-medium text-sm text-slate-300 hover:text-blue-400 border-b-2 border-transparent hover:border-blue-400 transition duration-150">Database Siswa</button>
                    </div>
                </div>
            </div>
        </nav>

        <main class="p-4 sm:p-6 lg:p-8 max-w-7xl mx-auto w-full flex-grow">
            <div id="loadingIndicator" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] hidden">
                <div class="bg-slate-700 p-5 rounded-lg shadow-xl text-center">
                    <svg class="animate-spin h-8 w-8 text-blue-400 mx-auto mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-slate-200 font-medium">Memproses...</p>
                </div>
            </div>
            <div id="messagePopup" class="fixed bottom-5 right-5 text-white py-3 px-5 rounded-lg shadow-xl z-[90] hidden transition-all duration-300 opacity-0 transform translate-y-10">
                <p id="messagePopupText"></p>
            </div>

            <div id="confirmationModal" class="fixed inset-0 z-[99] items-center justify-center custom-modal-backdrop hidden">
                <div class="bg-slate-800 p-6 rounded-xl shadow-2xl w-full max-w-sm glass-panel">
                    <h3 id="confirmationModalTitle" class="text-lg font-semibold text-slate-100 mb-4">Konfirmasi</h3>
                    <p id="confirmationModalMessage" class="text-sm text-slate-300 mb-6">Apakah Anda yakin?</p>
                    <div class="flex justify-end space-x-3">
                        <button id="confirmationModalCancel" class="py-2 px-4 border border-slate-600 rounded-lg text-sm font-medium text-slate-300 hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-400 transition duration-150">Batal</button>
                        <button id="confirmationModalConfirm" class="py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150">Ya, Lanjutkan</button>
                    </div>
                </div>
            </div>
            
            <div id="editDescriptionModal" class="fixed inset-0 z-[99] items-center justify-center custom-modal-backdrop hidden">
                <div class="bg-slate-800 p-6 rounded-xl shadow-2xl w-full max-w-md glass-panel">
                    <h3 class="text-lg font-semibold text-slate-100 mb-4">Edit Keterangan Pelanggaran</h3>
                    <textarea id="editDescriptionTextarea" rows="4" class="w-full p-2 border border-slate-600 rounded-md bg-slate-700 text-slate-200 focus:ring-blue-500 focus:border-blue-500"></textarea>
                    <div class="flex justify-end space-x-3 mt-4">
                        <button id="editDescriptionModalCancel" class="py-2 px-4 border border-slate-600 rounded-lg text-sm font-medium text-slate-300 hover:bg-slate-700">Batal</button>
                        <button id="editDescriptionModalSave" class="py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium">Simpan Perubahan</button>
                    </div>
                </div>
            </div>

            <div id="editStudentModal" class="fixed inset-0 z-[99] items-center justify-center custom-modal-backdrop hidden">
                <div class="bg-slate-800 p-6 rounded-xl shadow-2xl w-full max-w-md glass-panel">
                    <h3 class="text-lg font-semibold text-slate-100 mb-4">Edit Data Siswa</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="editStudentName" class="block text-sm font-medium text-slate-300">Nama Siswa</label>
                            <input type="text" id="editStudentName" class="mt-1 block w-full py-2 px-3 border border-slate-600 bg-slate-700 text-slate-200 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="editStudentClass" class="block text-sm font-medium text-slate-300">Pindahkan ke Kelas</label>
                            <select id="editStudentClass" class="mt-1 block w-full py-2 px-3 border border-slate-600 bg-slate-700 text-slate-200 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            </select>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button id="editStudentModalCancel" class="py-2 px-4 border border-slate-600 rounded-lg text-sm font-medium text-slate-300 hover:bg-slate-700">Batal</button>
                        <button id="editStudentModalSave" class="py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium">Simpan Perubahan</button>
                    </div>
                </div>
            </div>

            <!-- Card View Container -->
            <div id="cardViewContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div data-target-panel="rekapPanel" class="card-item glass-panel p-6 rounded-xl shadow-lg cursor-pointer hover:shadow-2xl flex flex-col items-center text-center">
                    <i class="fas fa-calendar-check fa-3x mb-4 text-blue-400"></i>
                    <h3 class="text-xl font-semibold text-slate-100">Rekap Pelanggaran</h3>
                    <p class="text-sm text-slate-400 mt-2">Lihat rekapitulasi pelanggaran siswa per bulan.</p>
                </div>
                <div data-target-panel="inputSiswaPanel" class="card-item glass-panel p-6 rounded-xl shadow-lg cursor-pointer hover:shadow-2xl flex flex-col items-center text-center">
                    <i class="fas fa-user-plus fa-3x mb-4 text-green-400"></i>
                    <h3 class="text-xl font-semibold text-slate-100">Input Pelanggaran</h3>
                    <p class="text-sm text-slate-400 mt-2">Catat pelanggaran siswa baru hari ini.</p>
                </div>
                <div data-target-panel="grafikPanel" class="card-item glass-panel p-6 rounded-xl shadow-lg cursor-pointer hover:shadow-2xl flex flex-col items-center text-center">
                    <i class="fas fa-chart-pie fa-3x mb-4 text-purple-400"></i>
                    <h3 class="text-xl font-semibold text-slate-100">Grafik Penanganan</h3>
                    <p class="text-sm text-slate-400 mt-2">Visualisasikan data penanganan pelanggaran.</p>
                </div>
                <div data-target-panel="databasePanel" class="card-item glass-panel p-6 rounded-xl shadow-lg cursor-pointer hover:shadow-2xl flex flex-col items-center text-center">
                    <i class="fas fa-database fa-3x mb-4 text-yellow-400"></i>
                    <h3 class="text-xl font-semibold text-slate-100">Database Siswa</h3>
                    <p class="text-sm text-slate-400 mt-2">Kelola data siswa dan kelas, serta reset data.</p>
                </div>
                <div data-target-panel="perhatianPanel" class="card-item glass-panel p-6 rounded-xl shadow-lg cursor-pointer hover:shadow-2xl flex flex-col items-center text-center lg:col-span-1 sm:col-span-2">
                    <i class="fas fa-exclamation-triangle fa-3x mb-4 text-orange-400"></i>
                    <h3 class="text-xl font-semibold text-slate-100">Perhatian Khusus</h3>
                    <p class="text-sm text-slate-400 mt-2">Daftar siswa dengan 3 atau lebih pelanggaran.</p>
                </div>
            </div>


            <!-- Rekap Panel -->
            <div id="rekapPanel" class="tab-content hidden glass-panel p-6 rounded-xl shadow-lg">
                <button class="back-to-menu-button mb-6 text-sm text-blue-400 hover:underline hidden">
                    <i class="fas fa-arrow-left mr-2"></i>Kembali ke Menu Utama
                </button>
                <h2 class="text-2xl font-semibold mb-6 text-slate-100">Rekap Pelanggaran</h2>
                <div class="flex flex-wrap items-center gap-4 mb-4">
                    <div>
                        <label for="rekapFilterBulan" class="block text-sm font-medium text-slate-300">Bulan</label>
                        <select id="rekapFilterBulan" class="mt-1 block w-full py-2 px-3 border border-slate-600 bg-slate-700 text-slate-200 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></select>
                    </div>
                    <div>
                        <label for="rekapFilterTahun" class="block text-sm font-medium text-slate-300">Tahun</label>
                        <select id="rekapFilterTahun" class="mt-1 block w-full py-2 px-3 border border-slate-600 bg-slate-700 text-slate-200 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></select>
                    </div>
                    <div>
                        <label for="rekapFilterKelas" class="block text-sm font-medium text-slate-300">Kelas</label>
                        <select id="rekapFilterKelas" class="mt-1 block w-full py-2 px-3 border border-slate-600 bg-slate-700 text-slate-200 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="">Semua Kelas</option>
                        </select>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-700">
                        <thead class="bg-slate-700/50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Tanggal</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Jam</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Nama Siswa</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Kelas</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Kategori</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Keterangan</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Status</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="rekapTableBody" class="bg-transparent divide-y divide-slate-700">
                        </tbody>
                    </table>
                </div>
                 <div id="rekapPaginationControls" class="flex flex-wrap items-center justify-between mt-4 text-sm">
                    <div>
                        <label for="rekapItemsPerPage" class="mr-2 text-slate-400">Item per halaman:</label>
                        <select id="rekapItemsPerPage" class="py-1 px-2 border border-slate-600 bg-slate-700 text-slate-200 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="20">20</option>
                            <option value="50">50</option>
                            <option value="All">Semua</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-4">
                        <span id="rekapPageInfo" class="text-slate-400"></span>
                        <button id="rekapPrevButton" class="pagination-button py-1 px-3 bg-slate-600 hover:bg-slate-500 rounded-md transition-colors">Sebelumnya</button>
                        <button id="rekapNextButton" class="pagination-button py-1 px-3 bg-slate-600 hover:bg-slate-500 rounded-md transition-colors">Berikutnya</button>
                    </div>
                </div>
            </div>

            <!-- Input Pelanggaran Panel -->
            <div id="inputSiswaPanel" class="tab-content hidden glass-panel p-6 rounded-xl shadow-lg">
                <button class="back-to-menu-button mb-6 text-sm text-blue-400 hover:underline hidden">
                     <i class="fas fa-arrow-left mr-2"></i>Kembali ke Menu Utama
                </button>
                <h2 class="text-2xl font-semibold mb-6 text-slate-100">Input Pelanggaran Siswa</h2>
                <form id="inputSiswaForm" class="space-y-6">
                    <div>
                        <label for="inputKelas" class="block text-sm font-medium text-slate-300">Kelas</label>
                        <select id="inputKelas" required class="mt-1 block w-full py-3 px-4 border border-slate-600 bg-slate-700 text-slate-200 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="">Pilih Kelas</option>
                        </select>
                    </div>
                    
                    <div id="studentSearchWrapper" class="hidden"> 
                        <label for="searchStudentNameInput" class="block text-sm font-medium text-slate-300">Nama Siswa</label>
                        <div class="relative mt-1">
                            <input type="text" id="searchStudentNameInput" autocomplete="off"
                                   class="block w-full py-3 px-4 border border-slate-600 bg-slate-700 text-slate-200 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                   placeholder="Ketik untuk mencari siswa...">
                            <div id="studentSuggestionsDropdown"
                                 class="absolute z-20 w-full bg-slate-700 border border-slate-600 rounded-md mt-1 max-h-60 overflow-y-auto shadow-lg hidden">
                            </div>
                        </div>
                    </div>
                    
                    <select id="inputNamaSiswa" name="inputNamaSiswa" required class="hidden"> 
                        <option value=""></option> 
                    </select>

                    <div>
                        <label for="inputKategori" class="block text-sm font-medium text-slate-300">Kategori Pelanggaran</label>
                        <select id="inputKategori" required class="mt-1 block w-full py-3 px-4 border border-slate-600 bg-slate-700 text-slate-200 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="">Pilih Kategori</option>
                            <option value="KETERLAMBATAN">Keterlambatan</option>
                            <option value="KERAPIAN">Kerapian</option>
                            <option value="MORAL">Moral</option>
                            <option value="BULLYING">Bullying</option>
                            <option value="PENYALAHGUNAAN NARKOBA">Penyalahgunaan Narkoba</option>
                        </select>
                    </div>

                    <div>
                        <label for="inputKeterangan" class="block text-sm font-medium text-slate-300">Keterangan</label>
                        <textarea id="inputKeterangan" rows="3" required class="mt-1 block w-full py-3 px-4 border border-slate-600 bg-slate-700 text-slate-200 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Contoh: Terlambat 15 menit"></textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="inputTanggal" class="block text-sm font-medium text-slate-300">Tanggal</label>
                            <input type="date" id="inputTanggal" readonly class="mt-1 block w-full py-3 px-4 border border-slate-600 bg-slate-700 text-slate-200 rounded-lg shadow-sm sm:text-sm">
                        </div>
                        <div>
                            <label for="inputJam" class="block text-sm font-medium text-slate-300">Jam</label>
                            <input type="time" id="inputJam" readonly class="mt-1 block w-full py-3 px-4 border border-slate-600 bg-slate-700 text-slate-200 rounded-lg shadow-sm sm:text-sm">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300">Status Penanganan</label>
                        <div class="mt-2 space-y-2 sm:space-y-0 sm:flex sm:space-x-4">
                            <div class="flex items-center">
                                <input id="statusBelum" name="statusPenanganan" type="radio" value="Belum Ditangani" checked class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-slate-600 bg-slate-700">
                                <label for="statusBelum" class="ml-2 block text-sm text-slate-200">Belum Ditangani</label>
                            </div>
                            <div class="flex items-center">
                                <input id="statusSudah" name="statusPenanganan" type="radio" value="Sudah Ditangani" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-slate-600 bg-slate-700">
                                <label for="statusSudah" class="ml-2 block text-sm text-slate-200">Sudah Ditangani</label>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" id="cancelInputSiswa" class="py-2 px-6 border border-slate-600 rounded-lg text-sm font-medium text-slate-300 hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-400 transition duration-150">Batal</button>
                        <button type="submit" class="py-2 px-6 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-gradient-to-r from-blue-600 to-purple-700 hover:from-blue-700 hover:to-purple-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150">Simpan</button>
                    </div>
                </form>
            </div>

            <!-- Grafik Penanganan Panel -->
            <div id="grafikPanel" class="tab-content hidden glass-panel p-6 rounded-xl shadow-lg">
                 <button class="back-to-menu-button mb-6 text-sm text-blue-400 hover:underline hidden">
                     <i class="fas fa-arrow-left mr-2"></i>Kembali ke Menu Utama
                </button>
                <h2 class="text-2xl font-semibold mb-6 text-slate-100">Grafik Penanganan Pelanggaran</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="p-4 border border-slate-700 rounded-lg shadow-sm bg-slate-800/50">
                        <h3 class="text-lg font-medium text-slate-300 mb-1">Total Pelanggaran Bulan Ini</h3>
                        <p id="totalKeterlambatanText" class="text-3xl font-bold text-blue-400">0</p>
                    </div>
                     <div class="p-4 border border-slate-700 rounded-lg shadow-sm bg-slate-800/50">
                        <h3 class="text-lg font-medium text-slate-300 mb-1">Persentase Penanganan</h3>
                        <p id="persentasePenangananText" class="text-3xl font-bold text-green-400">0%</p>
                    </div>
                </div>
                <div class="mt-8 h-64 md:h-80 relative">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>

            <!-- Database Siswa Panel -->
            <div id="databasePanel" class="tab-content hidden glass-panel p-6 rounded-xl shadow-lg">
                 <button class="back-to-menu-button mb-6 text-sm text-blue-400 hover:underline hidden">
                     <i class="fas fa-arrow-left mr-2"></i>Kembali ke Menu Utama
                </button>
                <h2 class="text-2xl font-semibold mb-6 text-slate-100">Kelola Data Siswa & Kelas</h2>
                <div class="mb-8">
                    <h3 class="text-xl font-semibold mb-2 text-slate-100">Import Data Siswa</h3>
                    <p class="text-sm text-slate-400 mb-4">Tempel data siswa dengan format: <strong>Nama Siswa, Kelas</strong> (satu siswa per baris).</p>
                    <textarea id="pasteDataSiswa" rows="6" class="mt-1 block w-full py-3 px-4 border border-slate-600 bg-slate-700 text-slate-200 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Tempel data di sini..."></textarea>
                    <button id="importDataSiswaButton" class="mt-4 py-2 px-6 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150">Import Data Siswa</button>
                    <div id="importResult" class="mt-4 text-sm text-slate-400"></div>
                </div>
                
                <div class="mb-8">
                    <h3 class="text-xl font-semibold mb-2 text-slate-100">Daftar Kelas & Siswa</h3>
                    <p class="text-sm text-slate-400 mb-4">Klik nama kelas untuk melihat dan mengelola daftar siswa.</p>
                    <div id="classManagementContainer" class="space-y-4 max-h-96 overflow-y-auto">
                        <!-- Daftar kelas dan siswa akan diisi oleh JavaScript -->
                    </div>
                </div>

                <div>
                    <h3 class="text-xl font-semibold mb-2 text-slate-100">Reset Aplikasi</h3>
                     <p class="text-sm text-slate-400 mb-4">Gunakan tombol di bawah untuk memulai tahun ajaran baru. Tindakan ini akan menghapus **semua data** (siswa, kelas, dan riwayat pelanggaran) dan tidak dapat diurungkan.</p>
                    <button id="resetTahunAjaranButton" class="py-2 px-6 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-gradient-to-r from-red-500 to-orange-600 hover:from-red-600 hover:to-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150">
                        Reset Total Tahun Ajaran
                    </button>
                </div>
            </div>
            
             <!-- Perhatian Khusus Panel -->
            <div id="perhatianPanel" class="tab-content hidden glass-panel p-6 rounded-xl shadow-lg">
                 <button class="back-to-menu-button mb-6 text-sm text-blue-400 hover:underline hidden">
                     <i class="fas fa-arrow-left mr-2"></i>Kembali ke Menu Utama
                </button>
                <h2 class="text-2xl font-semibold mb-6 text-slate-100">Siswa Perlu Perhatian Khusus</h2>
                <p class="text-sm text-slate-400 mb-4">Berikut adalah daftar siswa yang tercatat melakukan pelanggaran 3 kali atau lebih.</p>
                <div id="perhatianListContainer" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                    <!-- List will be populated by JS -->
                </div>
            </div>

        </main>
        <footer class="text-center p-4 mt-8 text-sm text-slate-500">
            <p>by: @_ara.v2</p>
        </footer>
    </div>

    <script type="module">
        // Konfigurasi Firebase (BARU)
        const firebaseConfig = {
            apiKey: "AIzaSyAYyegImdtLuI_7TeALDgsdG4quuFyeqrs",
            authDomain: "tugas-4971f.firebaseapp.com",
            databaseURL: "https://tugas-4971f-default-rtdb.firebaseio.com",
            projectId: "tugas-4971f",
            storageBucket: "tugas-4971f.firebasestorage.app",
            messagingSenderId: "1007302051502",
            appId: "1:1007302051502:web:c1561705559fcb61500f3f", 
            measurementId: "G-K2JZHEX4PE"
        };

        // Import fungsi Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signOut as firebaseSignOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getDatabase, 
            ref, 
            set, 
            push, 
            onValue, 
            get, 
            update,
            remove, 
            serverTimestamp,
            query, 
            orderByChild,
            equalTo
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        const currentAppId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId; 
        const basePath = `artifacts/${currentAppId}/public/data`;
        const classesPath = `${basePath}/classes`;
        const studentsPath = `${basePath}/students`;
        const violationRecordsPath = `${basePath}/violationRecords`; // Renamed for clarity

        // DOM Elements
        const authScreen = document.getElementById('authScreen');
        const appScreen = document.getElementById('appScreen');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const showRegisterLink = document.getElementById('showRegisterLink');
        const showLoginLink = document.getElementById('showLoginLink');
        const authError = document.getElementById('authError');
        const userEmailDisplay = document.getElementById('userEmailDisplay');
        const logoutButton = document.getElementById('logoutButton');
        
        const viewToggleButton = document.getElementById('viewToggleButton');
        const cardViewIcon = document.getElementById('cardViewIcon');
        const listViewIcon = document.getElementById('listViewIcon');
        const cardViewContainer = document.getElementById('cardViewContainer');
        const tabNavigationView = document.getElementById('tabNavigationView');
        const cardItems = document.querySelectorAll('.card-item');
        const backToMenuButtons = document.querySelectorAll('.back-to-menu-button');


        const loadingIndicator = document.getElementById('loadingIndicator');
        const messagePopup = document.getElementById('messagePopup');
        const messagePopupText = document.getElementById('messagePopupText');
        
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmationModalTitle = document.getElementById('confirmationModalTitle');
        const confirmationModalMessage = document.getElementById('confirmationModalMessage');
        const confirmationModalConfirm = document.getElementById('confirmationModalConfirm');
        const confirmationModalCancel = document.getElementById('confirmationModalCancel');
        let currentConfirmAction = null;
        
        const editDescriptionModal = document.getElementById('editDescriptionModal');
        const editDescriptionTextarea = document.getElementById('editDescriptionTextarea');
        const editDescriptionModalCancel = document.getElementById('editDescriptionModalCancel');
        const editDescriptionModalSave = document.getElementById('editDescriptionModalSave');
        let currentRecordIdToEdit = null;
        
        const editStudentModal = document.getElementById('editStudentModal');
        const editStudentName = document.getElementById('editStudentName');
        const editStudentClass = document.getElementById('editStudentClass');
        const editStudentModalCancel = document.getElementById('editStudentModalCancel');
        const editStudentModalSave = document.getElementById('editStudentModalSave');
        let currentStudentToEdit = {}; // { studentId, originalClassId, originalName }


        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        const rekapTableBody = document.getElementById('rekapTableBody');
        const rekapFilterKelas = document.getElementById('rekapFilterKelas');

        const inputSiswaForm = document.getElementById('inputSiswaForm');
        const inputKelas = document.getElementById('inputKelas');
        
        const studentSearchWrapper = document.getElementById('studentSearchWrapper');
        const searchStudentNameInput = document.getElementById('searchStudentNameInput');
        const studentSuggestionsDropdown = document.getElementById('studentSuggestionsDropdown');
        const inputNamaSiswa = document.getElementById('inputNamaSiswa'); 
        
        const inputKategori = document.getElementById('inputKategori'); // New category dropdown
        const inputKeterangan = document.getElementById('inputKeterangan'); // Formerly inputAlasan

        const inputTanggal = document.getElementById('inputTanggal');
        const inputJam = document.getElementById('inputJam');
        const cancelInputSiswa = document.getElementById('cancelInputSiswa');
        let originalStudentOptions = []; 

        const totalKeterlambatanText = document.getElementById('totalKeterlambatanText');
        const persentasePenangananText = document.getElementById('persentasePenangananText');
        const statusChartCanvas = document.getElementById('statusChart').getContext('2d');
        let statusChartInstance = null;

        const pasteDataSiswa = document.getElementById('pasteDataSiswa');
        const importDataSiswaButton = document.getElementById('importDataSiswaButton');
        const importResult = document.getElementById('importResult');
        const classManagementContainer = document.getElementById('classManagementContainer'); 
        const resetTahunAjaranButton = document.getElementById('resetTahunAjaranButton');
        const perhatianListContainer = document.getElementById('perhatianListContainer');

        // Pagination & Rekap state
        let allTimeViolationRecords = [];
        let filteredRekapRecords = [];
        let rekapCurrentPage = 1;
        let rekapItemsPerPage = 20;
        const rekapFilterBulan = document.getElementById('rekapFilterBulan');
        const rekapFilterTahun = document.getElementById('rekapFilterTahun');
        const rekapItemsPerPageSelect = document.getElementById('rekapItemsPerPage');
        const rekapPageInfo = document.getElementById('rekapPageInfo');
        const rekapPrevButton = document.getElementById('rekapPrevButton');
        const rekapNextButton = document.getElementById('rekapNextButton');
        

        // --- View Toggle ---
        function setAppView(viewType) {
            localStorage.setItem('viewMode', viewType);
            if (viewType === 'card') {
                tabNavigationView.classList.add('hidden');
                cardViewContainer.classList.remove('hidden');
                cardViewContainer.classList.add('grid');
                tabContents.forEach(content => content.classList.add('hidden')); 
                backToMenuButtons.forEach(btn => btn.classList.remove('hidden')); 
                cardViewIcon.classList.remove('hidden');
                listViewIcon.classList.add('hidden');
            } else { // 'tab'
                tabNavigationView.classList.remove('hidden');
                cardViewContainer.classList.add('hidden');
                cardViewContainer.classList.remove('grid');
                
                let activePanelId = document.querySelector('.tab-button.active')?.dataset.tab + 'Panel';
                if (!document.querySelector('.tab-button.active') || !document.getElementById(activePanelId)) {
                    tabButtons[0]?.classList.add('active'); 
                    activePanelId = tabButtons[0]?.dataset.tab + 'Panel';
                }
                tabContents.forEach(content => content.classList.toggle('hidden', content.id !== activePanelId));
                if(document.getElementById(activePanelId)) {
                    document.getElementById(activePanelId).classList.remove('hidden');
                    if (activePanelId === 'rekapPanel') filterAndDisplayRekap();
                    else if (activePanelId === 'grafikPanel') loadGrafikData();
                    else if (activePanelId === 'inputSiswaPanel') resetInputSiswaPanel();
                }

                backToMenuButtons.forEach(btn => btn.classList.add('hidden'));
                cardViewIcon.classList.add('hidden');
                listViewIcon.classList.remove('hidden');
            }
        }

        viewToggleButton.addEventListener('click', () => {
            const currentView = localStorage.getItem('viewMode') || 'card';
            setAppView(currentView === 'card' ? 'tab' : 'card');
        });

        // --- Utility Functions ---
        function showLoading(show) { loadingIndicator.classList.toggle('hidden', !show); loadingIndicator.classList.toggle('flex', show); }
        function showMessage(message, type = 'info', duration = 3000) { messagePopupText.textContent = message; const existingColorClasses = ['bg-blue-500', 'bg-red-600', 'bg-green-600']; existingColorClasses.forEach(cls => messagePopup.classList.remove(cls)); messagePopup.classList.remove('opacity-0', 'translate-y-10'); let bgColorClassesToAdd = 'bg-blue-600'; if (type === 'error') bgColorClassesToAdd = 'bg-red-600'; else if (type === 'success') bgColorClassesToAdd = 'bg-green-600'; messagePopup.classList.add(bgColorClassesToAdd); messagePopup.classList.remove('hidden'); setTimeout(() => { messagePopup.classList.add('opacity-100'); messagePopup.classList.remove('translate-y-10'); }, 50); setTimeout(() => { messagePopup.classList.remove('opacity-100'); messagePopup.classList.add('translate-y-10'); setTimeout(() => messagePopup.classList.add('hidden'), 300); }, duration); }
        function getCurrentDate() { return new Date().toISOString().split('T')[0]; }
        function getCurrentTime() { return new Date().toTimeString().split(' ')[0].substring(0,5); }

        // --- Custom Modals ---
        function showConfirmationModal(title, message, onConfirm) { confirmationModalTitle.textContent = title; confirmationModalMessage.textContent = message; currentConfirmAction = onConfirm; confirmationModal.classList.remove('hidden'); confirmationModal.classList.add('flex'); }
        confirmationModalCancel.addEventListener('click', () => { confirmationModal.classList.add('hidden'); confirmationModal.classList.remove('flex'); currentConfirmAction = null; });
        confirmationModalConfirm.addEventListener('click', () => { if (typeof currentConfirmAction === 'function') currentConfirmAction(); confirmationModal.classList.add('hidden'); confirmationModal.classList.remove('flex'); currentConfirmAction = null; });
        
        function showEditDescriptionModal(recordId, currentDescription) { 
            currentRecordIdToEdit = recordId; 
            editDescriptionTextarea.value = currentDescription; 
            editDescriptionModal.classList.remove('hidden'); 
            editDescriptionModal.classList.add('flex'); 
        }
        editDescriptionModalCancel.addEventListener('click', () => { editDescriptionModal.classList.add('hidden'); editDescriptionModal.classList.remove('flex'); currentRecordIdToEdit = null; });
        editDescriptionModalSave.addEventListener('click', async () => { if (!currentRecordIdToEdit) return; const newDescription = editDescriptionTextarea.value.trim(); if (newDescription === "") { showMessage('Keterangan tidak boleh kosong.', 'error'); return; } showLoading(true); try { const recordRef = ref(db, `${violationRecordsPath}/${currentRecordIdToEdit}`); await update(recordRef, { description: newDescription }); showMessage('Keterangan berhasil diperbarui.', 'success'); editDescriptionModal.classList.add('hidden'); editDescriptionModal.classList.remove('flex'); currentRecordIdToEdit = null; } catch (error) { console.error("Error updating description:", error); showMessage('Gagal memperbarui keterangan.', 'error'); } finally { showLoading(false); } });
        
        async function showEditStudentModal(studentId, studentName, classId) {
            currentStudentToEdit = { studentId, originalClassId: classId, originalName: studentName };
            editStudentName.value = studentName;
            
            const classesRef = ref(db, classesPath);
            const snapshot = await get(classesRef);
            const classesData = snapshot.val();
            let classOptions = '';
            if (classesData) {
                Object.entries(classesData).forEach(([id, data]) => {
                    classOptions += `<option value="${id}" ${id === classId ? 'selected' : ''}>${data.name}</option>`;
                });
            }
            editStudentClass.innerHTML = classOptions;
            
            editStudentModal.classList.remove('hidden');
            editStudentModal.classList.add('flex');
        }
        editStudentModalCancel.addEventListener('click', () => { editStudentModal.classList.add('hidden'); editStudentModal.classList.remove('flex'); currentStudentToEdit = {}; });
        editStudentModalSave.addEventListener('click', async () => {
            const { studentId, originalClassId, originalName } = currentStudentToEdit;
            const newName = editStudentName.value.trim();
            const newClassId = editStudentClass.value;

            if (!newName) { showMessage("Nama siswa tidak boleh kosong.", "error"); return; }
            showLoading(true);
            const nameChanged = newName !== originalName;
            const classChanged = newClassId !== originalClassId;

            try {
                if (classChanged) {
                    const oldStudentRef = ref(db, `${studentsPath}/${originalClassId}/${studentId}`);
                    const newStudentRef = ref(db, `${studentsPath}/${newClassId}/${studentId}`);
                    await set(newStudentRef, { name: newName, classId: newClassId });
                    await remove(oldStudentRef);
                } else if (nameChanged) {
                    const studentRef = ref(db, `${studentsPath}/${originalClassId}/${studentId}`);
                    await update(studentRef, { name: newName });
                }
                
                showMessage("Data siswa berhasil diperbarui.", "success");
                editStudentModal.classList.add('hidden');
                editStudentModal.classList.remove('flex');
                listenToClasses(); 
            } catch (error) {
                console.error("Error updating student data:", error);
                showMessage("Gagal memperbarui data siswa.", "error");
            } finally {
                showLoading(false);
            }
        });


        // --- Authentication & App Initialization ---
        onAuthStateChanged(auth, (user) => { if (user) { authScreen.classList.add('hidden'); appScreen.classList.remove('hidden'); userEmailDisplay.textContent = user.email; initializeAppData(); } else { authScreen.classList.remove('hidden'); appScreen.classList.add('hidden'); userEmailDisplay.textContent = ''; if (statusChartInstance) { statusChartInstance.destroy(); statusChartInstance = null; } } });
        loginForm.addEventListener('submit', async (e) => { e.preventDefault(); showLoading(true); authError.textContent = ''; const email = loginForm.loginEmail.value; const password = loginForm.loginPassword.value; try { await signInWithEmailAndPassword(auth, email, password); showMessage('Login berhasil!', 'success'); } catch (error) { console.error("Login error:", error); authError.textContent = `Error: ${error.message.replace('Firebase: ', '')}`; showMessage(`Login gagal: ${error.code}`, 'error'); } finally { showLoading(false); } });
        registerForm.addEventListener('submit', async (e) => { e.preventDefault(); showLoading(true); authError.textContent = ''; const email = registerForm.registerEmail.value; const password = registerForm.registerPassword.value; if (password.length < 6) { authError.textContent = 'Password minimal 6 karakter.'; showLoading(false); return; } try { await createUserWithEmailAndPassword(auth, email, password); showMessage('Registrasi berhasil! Silakan login.', 'success'); registerForm.classList.add('hidden'); loginForm.classList.remove('hidden'); loginForm.loginEmail.value = email; } catch (error) { console.error("Register error:", error); authError.textContent = `Error: ${error.message.replace('Firebase: ', '')}`; showMessage(`Registrasi gagal: ${error.code}`, 'error'); } finally { showLoading(false); } });
        showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); loginForm.classList.add('hidden'); registerForm.classList.remove('hidden'); authError.textContent = ''; });
        showLoginLink.addEventListener('click', (e) => { e.preventDefault(); registerForm.classList.add('hidden'); loginForm.classList.remove('hidden'); authError.textContent = ''; });
        logoutButton.addEventListener('click', async () => { showLoading(true); try { await firebaseSignOut(auth); showMessage('Logout berhasil.', 'info'); } catch (error) { console.error("Logout error:", error); showMessage('Logout gagal.', 'error'); } finally { showLoading(false); } });

        // --- Navigation Logic ---
        function showPanel(panelId) {
            tabContents.forEach(content => {
                content.classList.toggle('hidden', content.id !== panelId);
            });
            cardViewContainer.classList.add('hidden');
            cardViewContainer.classList.remove('grid');

            const currentView = localStorage.getItem('viewMode') || 'card';
            backToMenuButtons.forEach(btn => btn.classList.toggle('hidden', currentView === 'tab'));
            
            const panelToShow = document.getElementById(panelId);
            if(panelToShow) panelToShow.classList.remove('hidden');


            if (panelId === 'rekapPanel') filterAndDisplayRekap();
            if (panelId === 'grafikPanel') loadGrafikData();
            if (panelId === 'inputSiswaPanel') resetInputSiswaPanel();
            if (panelId === 'databasePanel') listenToClasses(); 
            if (panelId === 'perhatianPanel') loadPerhatianData();
        }

        cardItems.forEach(card => {
            card.addEventListener('click', () => {
                const targetPanelId = card.dataset.targetPanel;
                showPanel(targetPanelId);
                const currentView = localStorage.getItem('viewMode') || 'card';
                if (currentView === 'tab') {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    const correspondingTabButton = document.querySelector(`.tab-button[data-tab="${targetPanelId.replace('Panel', '')}"]`);
                    correspondingTabButton?.classList.add('active');
                }
            });
        });

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                if (tabNavigationView.classList.contains('hidden')) return; 
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                const targetPanelId = button.dataset.tab + 'Panel';
                showPanel(targetPanelId);
            });
        });

        backToMenuButtons.forEach(button => {
            button.addEventListener('click', () => {
                setAppView('card'); 
            });
        });


        function initializeAppData() {
            document.documentElement.classList.add('dark');
            const preferredView = localStorage.getItem('viewMode') || 'card';
            setAppView(preferredView); 
            setupRekapFilters();
            loadClassesForDropdowns();
            listenToViolationRecords(); 
            listenToClasses(); 
        }
        
        async function loadClassesForDropdowns() { const classesRef = ref(db, classesPath); onValue(classesRef, (snapshot) => { const classesData = snapshot.val(); const options = ['<option value="">Semua Kelas</option>']; const inputOptions = ['<option value="">Pilih Kelas</option>']; if (classesData) { Object.entries(classesData).forEach(([classId, classObj]) => { options.push(`<option value="${classId}">${classObj.name}</option>`); inputOptions.push(`<option value="${classId}" data-classname="${classObj.name}">${classObj.name}</option>`); }); } rekapFilterKelas.innerHTML = options.join(''); inputKelas.innerHTML = inputOptions.join(''); }); }
        importDataSiswaButton.addEventListener('click', async () => { const dataToPaste = pasteDataSiswa.value.trim(); if (!dataToPaste) { showMessage('Area data kosong.', 'error'); return; } showLoading(true); importResult.textContent = ''; let importedCount = 0, errorCount = 0; const lines = dataToPaste.split('\n'); const classesRef = ref(db, classesPath); try { const existingClassesSnapshot = await get(classesRef); const existingClasses = existingClassesSnapshot.val() || {}; let classMap = {}; Object.entries(existingClasses).forEach(([id, data]) => { classMap[data.name.trim().toLowerCase()] = id; }); for (const line of lines) { const parts = line.split(','); if (parts.length === 2) { const studentName = parts[0].trim(); const className = parts[1].trim(); if (studentName && className) { let classId = classMap[className.toLowerCase()]; if (!classId) { const newClassRef = push(classesRef); classId = newClassRef.key; await set(newClassRef, { name: className }); classMap[className.toLowerCase()] = classId; } const classStudentsRef = ref(db, `${studentsPath}/${classId}`); const classStudentsSnapshot = await get(query(classStudentsRef, orderByChild('name'), equalTo(studentName))); if (!classStudentsSnapshot.exists()) { const newStudentRef = push(classStudentsRef); await set(newStudentRef, { name: studentName, classId: classId }); importedCount++; } } else { errorCount++; } } else if (line.trim() !== "") { errorCount++; } } importResult.textContent = `Impor selesai. ${importedCount} siswa berhasil ditambahkan. ${errorCount} baris bermasalah.`; showMessage(`Impor selesai: ${importedCount} siswa ditambahkan.`, 'success'); pasteDataSiswa.value = ''; } catch (error) { console.error("Error importing data:", error); importResult.textContent = `Error saat impor: ${error.message}`; showMessage('Impor gagal.', 'error'); } finally { showLoading(false); } });
        
        function listenToClasses() { 
            const classesRef = ref(db, classesPath); 
            onValue(classesRef, (snapshot) => { 
                const classesData = snapshot.val() || {};
                classManagementContainer.innerHTML = ''; 
                if (Object.keys(classesData).length === 0) {
                    classManagementContainer.innerHTML = '<p class="text-slate-400 italic">Belum ada kelas terdaftar.</p>';
                    return;
                }
                Object.entries(classesData).forEach(([classId, classInfo]) => {
                    const classDiv = document.createElement('div');
                    classDiv.className = 'p-3 bg-slate-700/50 rounded-lg';
                    classDiv.innerHTML = `
                        <div class="flex justify-between items-center cursor-pointer">
                            <h4 class="font-semibold text-lg text-slate-100">${classInfo.name}</h4>
                            <i class="fas fa-chevron-down text-slate-400 transform transition-transform"></i>
                        </div>
                        <div class="student-list-container mt-4 pt-4 border-t border-slate-600 hidden">
                           <p class="text-slate-400 italic">Memuat siswa...</p> 
                        </div>
                    `;
                    classManagementContainer.appendChild(classDiv);

                    classDiv.querySelector('.cursor-pointer').addEventListener('click', async (e) => {
                        const studentListDiv = classDiv.querySelector('.student-list-container');
                        const icon = classDiv.querySelector('i');
                        const isHidden = studentListDiv.classList.toggle('hidden');
                        icon.classList.toggle('rotate-180', !isHidden);

                        if (!isHidden && studentListDiv.dataset.loaded !== 'true') {
                            const studentsRef = ref(db, `${studentsPath}/${classId}`);
                            const studentSnapshot = await get(studentsRef);
                            const studentsData = studentSnapshot.val() || {};
                            studentListDiv.innerHTML = ''; 

                            if (Object.keys(studentsData).length === 0) {
                                studentListDiv.innerHTML = '<p class="text-slate-400 italic">Tidak ada siswa di kelas ini.</p>';
                            } else {
                                const studentUl = document.createElement('ul');
                                studentUl.className = 'space-y-2';
                                Object.entries(studentsData).forEach(([studentId, studentInfo]) => {
                                    const li = document.createElement('li');
                                    li.className = 'flex justify-between items-center text-slate-300';
                                    li.innerHTML = `
                                        <span>${studentInfo.name}</span>
                                        <div class="space-x-3">
                                            <button class="edit-student-button text-indigo-400 hover:text-indigo-300 text-sm" data-student-id="${studentId}" data-student-name="${studentInfo.name}" data-class-id="${classId}">Edit</button>
                                            <button class="delete-student-button text-red-400 hover:text-red-300 text-sm" data-student-id="${studentId}" data-class-id="${classId}">Hapus</button>
                                        </div>
                                    `;
                                    studentUl.appendChild(li);
                                });
                                studentListDiv.appendChild(studentUl);
                            }
                            studentListDiv.dataset.loaded = 'true';
                        }
                    });
                });
            }); 
        }

        classManagementContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('edit-student-button')) {
                const { studentId, studentName, classId } = e.target.dataset;
                showEditStudentModal(studentId, studentName, classId);
            }
            if (e.target.classList.contains('delete-student-button')) {
                const { studentId, classId } = e.target.dataset;
                showConfirmationModal(
                    'Hapus Data Siswa',
                    'Anda yakin ingin menghapus siswa ini? Tindakan ini tidak dapat diurungkan.',
                    async () => {
                        showLoading(true);
                        try {
                            await remove(ref(db, `${studentsPath}/${classId}/${studentId}`));
                            showMessage('Siswa berhasil dihapus.', 'success');
                        } catch (error) {
                            console.error("Error deleting student:", error);
                            showMessage("Gagal menghapus siswa.", "error");
                        } finally {
                            showLoading(false);
                        }
                    }
                );
            }
        });
        
        resetTahunAjaranButton.addEventListener('click', () => { showConfirmationModal( 'Reset Total Tahun Ajaran', 'Anda yakin ingin menghapus SEMUA data, termasuk daftar siswa, kelas, dan riwayat pelanggaran? Tindakan ini tidak dapat diurungkan.', async () => { showLoading(true); try { await Promise.all([ remove(ref(db, violationRecordsPath)), remove(ref(db, studentsPath)), remove(ref(db, classesPath)) ]); showMessage('Semua data aplikasi berhasil direset.', 'success'); } catch (error) { console.error("Error resetting all data:", error); showMessage('Gagal mereset data aplikasi.', 'error'); } finally { showLoading(false); } } ); });
        function resetInputSiswaPanel() { inputSiswaForm.reset(); inputTanggal.value = getCurrentDate(); inputJam.value = getCurrentTime(); studentSearchWrapper.classList.add('hidden'); searchStudentNameInput.value = ''; studentSuggestionsDropdown.innerHTML = ''; studentSuggestionsDropdown.classList.add('hidden'); originalStudentOptions = []; inputNamaSiswa.innerHTML = '<option value=""></option>'; inputNamaSiswa.value = ''; }
        inputKelas.addEventListener('change', async () => { const selectedClassId = inputKelas.value; originalStudentOptions = []; searchStudentNameInput.value = ''; studentSuggestionsDropdown.innerHTML = ''; studentSuggestionsDropdown.classList.add('hidden'); inputNamaSiswa.innerHTML = '<option value=""></option>'; inputNamaSiswa.value = ''; if (!selectedClassId) { studentSearchWrapper.classList.add('hidden'); return; } studentSearchWrapper.classList.remove('hidden'); searchStudentNameInput.placeholder = "Memuat siswa..."; searchStudentNameInput.disabled = true; showLoading(true); try { const classStudentsRef = ref(db, `${studentsPath}/${selectedClassId}`); const snapshot = await get(classStudentsRef); const studentsData = snapshot.val(); if (studentsData) { Object.entries(studentsData).forEach(([studentId, studentObj]) => { originalStudentOptions.push({ id: studentId, name: studentObj.name }); }); searchStudentNameInput.placeholder = "Ketik untuk mencari siswa..."; } else { searchStudentNameInput.placeholder = "Tidak ada siswa di kelas ini"; } } catch (error) { console.error("Error loading students for class:", error); searchStudentNameInput.placeholder = "Gagal memuat siswa"; showMessage('Gagal memuat daftar siswa.', 'error'); } finally { searchStudentNameInput.disabled = false; showLoading(false); } });
        searchStudentNameInput.addEventListener('input', () => { const searchTerm = searchStudentNameInput.value.toLowerCase().trim(); studentSuggestionsDropdown.innerHTML = ''; if (searchTerm === '' || !inputKelas.value) { studentSuggestionsDropdown.classList.add('hidden'); inputNamaSiswa.innerHTML = '<option value=""></option>'; inputNamaSiswa.value = ''; return; } const filteredStudents = originalStudentOptions.filter(student => student.name.toLowerCase().includes(searchTerm) ); if (filteredStudents.length > 0) { filteredStudents.forEach(student => { const item = document.createElement('div'); item.textContent = student.name; item.dataset.id = student.id; item.dataset.name = student.name; item.className = 'p-2 cursor-pointer suggestion-item text-slate-200'; item.addEventListener('click', () => { searchStudentNameInput.value = student.name; inputNamaSiswa.innerHTML = `<option value="${student.id}">${student.name}</option>`; inputNamaSiswa.value = student.id; studentSuggestionsDropdown.classList.add('hidden'); }); studentSuggestionsDropdown.appendChild(item); }); studentSuggestionsDropdown.classList.remove('hidden'); } else { const noResultItem = document.createElement('div'); noResultItem.textContent = 'Tidak ada siswa cocok'; noResultItem.className = 'p-2 text-slate-400'; studentSuggestionsDropdown.appendChild(noResultItem); studentSuggestionsDropdown.classList.remove('hidden'); inputNamaSiswa.innerHTML = '<option value=""></option>'; inputNamaSiswa.value = ''; } });
        document.addEventListener('click', function(event) { if (!studentSearchWrapper.contains(event.target)) { studentSuggestionsDropdown.classList.add('hidden'); } });
        searchStudentNameInput.addEventListener('focus', () => { if (searchStudentNameInput.value.trim() !== '' && originalStudentOptions.length > 0) { searchStudentNameInput.dispatchEvent(new Event('input')); } });
        inputSiswaForm.addEventListener('submit', async (e) => { e.preventDefault(); showLoading(true); const selectedClassOption = inputKelas.options[inputKelas.selectedIndex]; const studentIdFromHiddenSelect = inputNamaSiswa.value; const studentNameFromSearchInput = searchStudentNameInput.value; const record = { classId: inputKelas.value, className: selectedClassOption.dataset.classname, studentId: studentIdFromHiddenSelect, studentName: studentNameFromSearchInput, description: inputKeterangan.value.trim(), date: inputTanggal.value, time: inputJam.value, category: inputKategori.value, status: document.querySelector('input[name="statusPenanganan"]:checked').value, recordedAt: serverTimestamp() }; if (!record.classId || !record.studentId || !record.description || !record.category) { showMessage('Harap lengkapi semua field.', 'error'); showLoading(false); return; } let isDuplicate = false; const recordsCheckRef = ref(db, violationRecordsPath); try { const snapshot = await get(recordsCheckRef); const allRecords = snapshot.val() || {}; for (const key in allRecords) { const existingRecord = allRecords[key]; if (existingRecord.studentId === record.studentId && existingRecord.date === record.date && existingRecord.category === record.category) { isDuplicate = true; break; } } } catch (error) { console.error("Error checking for duplicates:", error); showMessage("Gagal memeriksa duplikasi, coba lagi.", "error"); showLoading(false); return; } if (isDuplicate) { showMessage('Pelanggaran kategori ini untuk siswa tersebut sudah didata hari ini.', 'error'); showLoading(false); return; } try { const newRecordRef = push(ref(db, violationRecordsPath)); await set(newRecordRef, record); showMessage('Data pelanggaran berhasil disimpan.', 'success'); resetInputSiswaPanel(); } catch (error) { console.error("Error saving violation record:", error); showMessage(`Gagal menyimpan data: ${error.message}`, 'error'); } finally { showLoading(false); } });
        cancelInputSiswa.addEventListener('click', () => { resetInputSiswaPanel(); });
        function renderRekapTable(recordsToRender) { rekapTableBody.innerHTML = ''; if (recordsToRender.length === 0) { rekapTableBody.innerHTML = `<tr><td colspan="8" class="text-center py-10 text-slate-400">Tidak ada data pelanggaran untuk filter ini.</td></tr>`; return; } recordsToRender.forEach(record => { const row = rekapTableBody.insertRow(); row.className = "hover:bg-slate-700/50 transition-colors duration-150"; const escapedDescription = record.description.replace(/</g, "&lt;").replace(/>/g, "&gt;"); row.innerHTML = ` <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-300">${record.date}</td> <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-300">${record.time}</td> <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-slate-100">${record.studentName}</td> <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-300">${record.className}</td> <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-300 font-semibold">${record.category || '-'}</td> <td class="px-4 py-3 text-sm text-slate-300 max-w-xs truncate" title="${escapedDescription}">${escapedDescription}</td> <td class="px-4 py-3 whitespace-nowrap text-sm"> <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${record.status === 'Sudah Ditangani' ?  'bg-green-700 text-green-100' :  'bg-yellow-700 text-yellow-100'}"> ${record.status} </span> </td> <td class="px-4 py-3 whitespace-nowrap text-sm font-medium space-x-2"> ${record.status === 'Belum Ditangani' ?   `<button data-id="${record.id}" class="mark-handled-button text-blue-400 hover:text-blue-300 transition duration-150">Tandai Sudah</button>` :   '<span class="text-green-400">Selesai</span>'} <button data-id="${record.id}" data-description="${escapedDescription}" class="edit-description-button text-indigo-400 hover:text-indigo-300 transition duration-150">Edit</button> <button data-id="${record.id}" class="delete-record-button text-red-400 hover:text-red-300 transition duration-150">Hapus</button> </td> `; }); document.querySelectorAll('.mark-handled-button').forEach(button => { button.addEventListener('click', (e) => markAsHandled(e.target.dataset.id)); }); document.querySelectorAll('.edit-description-button').forEach(button => { button.addEventListener('click', (e) => { const recordId = e.target.dataset.id; const rawDescription = filteredRekapRecords.find(r => r.id === recordId)?.description || e.target.dataset.description; showEditDescriptionModal(recordId, rawDescription); }); }); document.querySelectorAll('.delete-record-button').forEach(button => { button.addEventListener('click', (e) => deleteViolationRecord(e.target.dataset.id)); }); }
        async function markAsHandled(recordId) { showLoading(true); try { const recordRef = ref(db, `${violationRecordsPath}/${recordId}`); await update(recordRef, { status: "Sudah Ditangani" }); showMessage('Status berhasil diperbarui.', 'success'); } catch (error) { console.error("Error updating status:", error); showMessage('Gagal memperbarui status.', 'error'); } finally { showLoading(false); } }
        async function deleteViolationRecord(recordId) { showConfirmationModal( 'Hapus Data Pelanggaran', 'Anda yakin ingin menghapus data pelanggaran ini? Tindakan ini tidak dapat diurungkan.', async () => { showLoading(true); try { await remove(ref(db, `${violationRecordsPath}/${recordId}`)); showMessage('Data pelanggaran berhasil dihapus.', 'success'); } catch (error) { console.error("Error deleting record:", error); showMessage('Gagal menghapus data.', 'error'); } finally { showLoading(false); } } ); }
        
        // --- REKAP & PAGINATION LOGIC ---
        function setupRekapFilters() {
            const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            rekapFilterBulan.innerHTML = months.map((month, index) => `<option value="${index}" ${index === currentMonth ? 'selected' : ''}>${month}</option>`).join('');
            
            let years = new Set([currentYear]);
            allTimeViolationRecords.forEach(rec => years.add(new Date(rec.date).getFullYear()));
            rekapFilterTahun.innerHTML = Array.from(years).sort((a,b) => b-a).map(year => `<option value="${year}" ${year === currentYear ? 'selected' : ''}>${year}</option>`).join('');
            
            [rekapFilterBulan, rekapFilterTahun, rekapFilterKelas, rekapItemsPerPageSelect].forEach(el => {
                el.addEventListener('change', filterAndDisplayRekap);
            });
            rekapPrevButton.addEventListener('click', () => { if (rekapCurrentPage > 1) { rekapCurrentPage--; renderRekapPage(); } });
            rekapNextButton.addEventListener('click', () => { const totalPages = Math.ceil(filteredRekapRecords.length / rekapItemsPerPage); if (rekapCurrentPage < totalPages) { rekapCurrentPage++; renderRekapPage(); } });
        }

        function filterAndDisplayRekap() {
            rekapCurrentPage = 1; 
            rekapItemsPerPage = rekapItemsPerPageSelect.value === "All" ? Infinity : parseInt(rekapItemsPerPageSelect.value);

            const selectedMonthJS = parseInt(rekapFilterBulan.value);
            const selectedYear = rekapFilterTahun.value;
            const selectedClass = rekapFilterKelas.value;
            
            const monthYearString = `${selectedYear}-${String(selectedMonthJS + 1).padStart(2, '0')}`;
            
            filteredRekapRecords = allTimeViolationRecords
                .filter(record => record.date && record.date.startsWith(monthYearString))
                .filter(record => !selectedClass || record.classId === selectedClass);
            
            renderRekapPage();
        }

        function renderRekapPage() {
            const totalRecords = filteredRekapRecords.length;
            const totalPages = rekapItemsPerPage === Infinity ? 1 : Math.ceil(totalRecords / rekapItemsPerPage);
            
            rekapCurrentPage = Math.max(1, Math.min(rekapCurrentPage, totalPages));

            const startIndex = (rekapCurrentPage - 1) * rekapItemsPerPage;
            const endIndex = rekapItemsPerPage === Infinity ? totalRecords : startIndex + rekapItemsPerPage;
            const recordsForPage = filteredRekapRecords.slice(startIndex, endIndex);

            renderRekapTable(recordsForPage);

            rekapPageInfo.textContent = `Halaman ${totalPages > 0 ? rekapCurrentPage : 0} dari ${totalPages}`;
            rekapPrevButton.disabled = rekapCurrentPage <= 1;
            rekapNextButton.disabled = rekapCurrentPage >= totalPages;
        }


        function loadGrafikData() { const recordsRef = ref(db, violationRecordsPath); onValue(recordsRef, (snapshot) => { const allRecords = snapshot.val() || {}; const currentMonthYear = new Date().toISOString().slice(0, 7); const monthlyRecords = Object.values(allRecords) .filter(record => record.date && record.date.startsWith(currentMonthYear)); let totalLate = monthlyRecords.length; let handledCount = monthlyRecords.filter(r => r.status === "Sudah Ditangani").length; let unhandledCount = totalLate - handledCount; let percentageHandled = totalLate > 0 ? ((handledCount / totalLate) * 100).toFixed(1) : 0; totalKeterlambatanText.textContent = totalLate; persentasePenangananText.textContent = `${percentageHandled}%`; if (statusChartInstance) statusChartInstance.destroy(); const chartTextColor = '#E2E8F0'; statusChartInstance = new Chart(statusChartCanvas, { type: 'pie', data: { labels: ['Sudah Ditangani', 'Belum Ditangani'], datasets: [{ label: 'Status Penanganan', data: [handledCount, unhandledCount], backgroundColor: [ 'rgba(16, 185, 129, 0.7)', 'rgba(245, 158, 11, 0.7)' ], borderColor: [ 'rgba(5, 150, 105, 1)', 'rgba(217, 119, 6, 1)' ], borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { color: chartTextColor } }, title: { display: true, text: 'Status Penanganan Pelanggaran Bulan Ini', color: chartTextColor, font: { size: 16 } } } } }); }, (error) => { console.error("Error loading grafik data:", error); totalKeterlambatanText.textContent = 'Error'; persentasePenangananText.textContent = 'Error'; showMessage('Gagal memuat data grafik.', 'error'); }); }
        
        function loadPerhatianData() {
            const container = document.getElementById('perhatianListContainer');
            container.innerHTML = '<p class="text-slate-400 italic">Menganalisis data pelanggaran...</p>';

            const studentCounts = {};
            allTimeViolationRecords.forEach(record => {
                if(record.studentId) {
                    if (!studentCounts[record.studentId]) {
                        studentCounts[record.studentId] = { 
                            name: record.studentName, 
                            class: record.className, 
                            totalCount: 0, 
                            violations: {} 
                        };
                    }
                    studentCounts[record.studentId].totalCount++;
                    const category = record.category || 'LAINNYA';
                    studentCounts[record.studentId].violations[category] = (studentCounts[record.studentId].violations[category] || 0) + 1;
                }
            });

            const frequentViolators = Object.values(studentCounts).filter(student => student.totalCount >= 3).sort((a, b) => b.totalCount - a.count);
            
            container.innerHTML = ''; // Clear container
            if (frequentViolators.length === 0) {
                container.innerHTML = '<p class="text-slate-400 italic">Tidak ada siswa yang tercatat melakukan pelanggaran 3 kali atau lebih.</p>';
                return;
            }

            frequentViolators.forEach(student => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'p-4 bg-slate-700/50 rounded-lg flex justify-between items-start gap-4';
                
                let violationDetailsHTML = '<ul class="text-xs space-y-1 mt-2 text-slate-400">';
                Object.entries(student.violations).forEach(([category, count]) => {
                    violationDetailsHTML += `<li><span class="font-semibold">${category}:</span> ${count} kali</li>`;
                });
                violationDetailsHTML += '</ul>';

                itemDiv.innerHTML = `
                    <div class="flex-grow">
                        <p class="font-semibold text-slate-100">${student.name}</p>
                        <p class="text-sm text-slate-400">${student.class || 'Kelas tidak diketahui'}</p>
                        ${violationDetailsHTML}
                    </div>
                    <div class="text-right flex-shrink-0">
                        <p class="text-2xl font-bold text-orange-400">${student.totalCount}x</p>
                        <p class="text-xs text-slate-500">Total Pelanggaran</p>
                    </div>
                `;
                container.appendChild(itemDiv);
            });
        }
        
        function listenToViolationRecords() { 
            const recordsRef = ref(db, violationRecordsPath); 
            onValue(recordsRef, (snapshot) => { 
                const recordsData = snapshot.val() || {};
                allTimeViolationRecords = Object.entries(recordsData).map(([id, record]) => ({ id, ...record })).sort((a, b) => (b.recordedAt || 0) - (a.recordedAt || 0));
                setupRekapFilters();
                
                const currentView = localStorage.getItem('viewMode') || 'card';
                const activePanel = document.querySelector('.tab-content:not(.hidden)');
                if (activePanel) {
                   if (activePanel.id === 'rekapPanel') filterAndDisplayRekap();
                   if (activePanel.id === 'grafikPanel') loadGrafikData();
                   if (activePanel.id === 'perhatianPanel') loadPerhatianData();
                }
            }); 
        }

    </script>
</body>
</html>
